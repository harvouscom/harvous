---
import { actions } from "astro:actions";
import { db, eq, Notes, Threads, desc } from "astro:db";
import Layout from "@/layouts/Layout.astro";
import NoteCard from "@/components/NoteCard.astro";
import ThreadCard from "@/components/ThreadCard.astro";
import AddButton from "@/components/AddButton.astro";
import Tab from "@/components/TabBar/Tab.astro";
import { SignOutButton } from "@clerk/astro/components";
import EllipsisIcon from "@fortawesome/fontawesome-free/svgs/solid/ellipsis.svg";

// Get userId from auth and redirect if not authenticated
const userId = Astro.locals.auth().userId;
if (!userId) {
  return Astro.redirect("/");
}

// Verify user exists
const user = await Astro.locals.currentUser();
if (!user) {
  return Astro.redirect("/");
}

const notes = await db.select()
  .from(Notes)
  .where(eq(Notes.userId, userId as string))
  .orderBy(desc(Notes.createdAt));

const threads = await db.select()
  .from(Threads)
  .where(eq(Threads.userId, userId as string))
  .orderBy(desc(Threads.createdAt));

// Create arrays of note and thread IDs for checking in client-side script
const noteIds = notes.map(note => note.id);
const threadIds = threads.map(thread => thread.id);
---

<Layout>
  <div class="relative min-h-[100vh]">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-6 mx-auto max-w-screen-sm flex items-center justify-between" x-data>
        <div class="flex">
          <Tab label="Feed" href="#" active />
          <div id="note-tab-container"></div>
          <div id="thread-tab-container"></div>
        </div>
        
        <!-- Sign Out Button in header -->
        <div>
          <SignOutButton>
            <span class="text-sm font-medium text-(--color-stone-grey) hover:text-black transition-colors px-3 py-1 rounded-md hover:bg-gray-100 cursor-pointer inline-block">
              Sign Out
            </span>
          </SignOutButton>
        </div>
      </div>
    </section>

    <main
      class="max-w-screen-sm mx-auto px-6 pt-6 pb-12 flex flex-col gap-6"
    >
      <!-- New Section -->
      <section class="flex flex-col items-start self-stretch rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">New</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">0</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
      </section>

      <!-- Pinned Threads Section -->
      <section class="flex flex-col items-start self-stretch rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">Pinned Threads</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">0</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
      </section>

      <!-- Unorganized Notes Section -->
      <section class="flex flex-col items-start self-stretch rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">Unorganized Notes</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">{notes.length}</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
        {notes.length > 0 && (
          <div class="w-full overflow-x-auto px-6 pb-[18px]">
            <div class="flex gap-3 min-w-min">
              {
                notes.map((note) => (
                  <div class="min-w-[160px] max-w-[160px] flex-shrink-0">
                    <a href={`/dashboard/notes/${note.id}`}>
                      <NoteCard title={note.title ?? ""} content={note.content ?? ""} />
                    </a>
                  </div>
                ))
              }
            </div>
          </div>
        )}
      </section>

      <!-- All Threads Section -->
      <section class="flex flex-col items-start self-stretch rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">All Threads</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">{threads.length}</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
        {threads.length > 0 && (
          <div class="w-full px-6 pb-[18px]">
            <div class="flex flex-col gap-3 w-full">
              {
                threads.map((thread) => (
                  <div class="w-full">
                    <a href={`/dashboard/threads/${thread.id}`}>
                      <ThreadCard title={thread.title} isPublic={thread.isPublic} color={thread.color || undefined} />
                    </a>
                  </div>
                ))
              }
            </div>
          </div>
        )}
      </section>
    </main>
    
    <!-- Floating Action Button for creating a new note -->
    <div class="absolute bottom-[32px] right-[32px] z-50">
      <AddButton />
    </div>
  </div>

  <script define:vars={{ noteIds, threadIds }}>
    // Check if the user was viewing a note previously and keep the tab if they were
    document.addEventListener('DOMContentLoaded', () => {
      const lastViewedNote = localStorage.getItem('lastViewedNote');
      const noteTabContainer = document.getElementById('note-tab-container');
      
      if (lastViewedNote && noteTabContainer) {
        const noteId = lastViewedNote;
        
        // Check if it's a new note or if the note exists in the database
        if (noteId === 'new' || noteIds.includes(parseInt(noteId))) {
          const noteTab = document.createElement('div');
          noteTab.style.margin = '0'; // Ensure no margin
          noteTab.style.padding = '0'; // Ensure no padding
          
          // For new notes vs existing notes
          const href = noteId === 'new' ? '/dashboard/notes/new' : `/dashboard/notes/${noteId}`;
          
          noteTab.innerHTML = `
            <div class="relative rounded-t-lg px-5 h-[44px] flex items-center tab bg-(--color-fog-white)" role="tab" style="margin: 0;">
              <div class="flex items-center gap-2">
                <a href="${href}" class="tab-text w-fit font-sans font-bold text-sm text-(--color-stone-grey)">Note</a>
                <span class="close-btn text-[12px] font-bold leading-none text-(--color-stone-grey) cursor-pointer" onclick="closeNoteTab()">×</span>
              </div>
            </div>
          `;
          noteTabContainer.appendChild(noteTab);
        } else {
          // Note doesn't exist anymore, remove from localStorage
          localStorage.removeItem('lastViewedNote');
        }
      }
      
      // Add the same for thread tabs
      const lastViewedThread = localStorage.getItem('lastViewedThread');
      const threadTabContainer = document.getElementById('thread-tab-container');
      
      if (lastViewedThread && threadTabContainer) {
        const threadId = lastViewedThread;
        
        // Check if it's a new thread or if the thread exists in the database
        if (threadId === 'new' || threadIds.includes(parseInt(threadId))) {
          const threadTab = document.createElement('div');
          threadTab.style.margin = '0'; // Ensure no margin
          threadTab.style.padding = '0'; // Ensure no padding
          
          // For new threads vs existing threads
          const href = threadId === 'new' ? '/dashboard/threads/new' : `/dashboard/threads/${threadId}`;
          
          threadTab.innerHTML = `
            <div class="relative rounded-t-lg px-5 h-[44px] flex items-center tab bg-(--color-fog-white)" role="tab" style="margin: 0;">
              <div class="flex items-center gap-2">
                <a href="${href}" class="tab-text w-fit font-sans font-bold text-sm text-(--color-stone-grey)">Thread</a>
                <span class="close-btn text-[12px] font-bold leading-none text-(--color-stone-grey) cursor-pointer" onclick="closeThreadTab()">×</span>
              </div>
            </div>
          `;
          threadTabContainer.appendChild(threadTab);
        } else {
          // Thread doesn't exist anymore, remove from localStorage
          localStorage.removeItem('lastViewedThread');
        }
      }
    });

    function closeNoteTab() {
      localStorage.removeItem('lastViewedNote');
      const noteTabContainer = document.getElementById('note-tab-container');
      if (noteTabContainer) {
        noteTabContainer.innerHTML = '';
      }
    }
    
    function closeThreadTab() {
      localStorage.removeItem('lastViewedThread');
      const threadTabContainer = document.getElementById('thread-tab-container');
      if (threadTabContainer) {
        threadTabContainer.innerHTML = '';
      }
    }
  </script>
</Layout>
