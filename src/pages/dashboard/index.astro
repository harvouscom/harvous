---
import { actions } from "astro:actions";
import { db, eq, Notes } from "astro:db";
import Layout from "@/layouts/Layout.astro";
import NoteCard from "@/components/NoteCard.astro";
import CtaButton from "@/components/CtaButton.astro";
import Tab from "@/components/TabBar/Tab.astro";
if (!Astro.locals.auth().userId) {
  return Astro.redirect("/");
}

const user = await Astro.locals.currentUser();

if (!user) {
  return Astro.redirect("/");
}

const notes = await db.select().from(Notes).where(eq(Notes.userId, user.id));
---

<Layout>
  <section class="bg-(--color-fog-white) pt-3">
    <div class="px-6 mx-auto max-w-screen-sm flex items-center gap-2" x-data>
      <Tab label="Feed" href="#" active />
      <div id="note-tab-container"></div>
    </div>
  </section>

  <main
    class="max-w-screen-sm mx-auto px-6 pt-6 pb-12 grid grid-rows-[auto_1fr] gap-3"
  >
    <ul class="grid max-sm:grid-cols-2 sm:grid-cols-3 gap-3 gap-y-4">
      {
        notes.map((note) => (
          <li class="w-full h-full">
            <a class="h-full" href={`/dashboard/notes/${note.id}`}>
              <NoteCard title={note.title ?? ""} content={note.content ?? ""} />
            </a>
          </li>
        ))
      }
    </ul>

    <a href="/dashboard/notes/new">
      <CtaButton />
    </a>
  </main>

  <script>
    // Check if the user was viewing a note previously and keep the tab if they were
    document.addEventListener('DOMContentLoaded', () => {
      const lastViewedNote = localStorage.getItem('lastViewedNote');
      const noteTabContainer = document.getElementById('note-tab-container');
      
      if (lastViewedNote && noteTabContainer) {
        const noteId = lastViewedNote;
        const noteTab = document.createElement('div');
        
        // For new notes vs existing notes
        const href = noteId === 'new' ? '/dashboard/notes/new' : `/dashboard/notes/${noteId}`;
        
        noteTab.innerHTML = `
          <div class="relative rounded-t-lg px-5 py-3 w-fit tab bg-(--color-fog-white)" role="tab">
            <div class="flex items-center gap-2">
              <a href="${href}" class="tab-text w-fit font-sans font-bold text-sm text-(--color-stone-grey)">Note</a>
              <span class="close-btn text-[12px] font-bold leading-none text-(--color-stone-grey) cursor-pointer" onclick="closeNoteTab()">Ã—</span>
            </div>
          </div>
        `;
        noteTabContainer.appendChild(noteTab);
      }
    });

    function closeNoteTab() {
      localStorage.removeItem('lastViewedNote');
      const noteTabContainer = document.getElementById('note-tab-container');
      if (noteTabContainer) {
        noteTabContainer.innerHTML = '';
      }
    }
  </script>
</Layout>
