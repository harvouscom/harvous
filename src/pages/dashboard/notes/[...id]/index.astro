---
import { db, eq, Notes, and } from "astro:db";
import { actions } from "astro:actions";
import { z } from "zod";
import Layout from "@/layouts/Layout.astro";
import IconButton from "@/components/IconButton.astro";
import BookmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/bookmark.svg";
import CheckIcon from "@fortawesome/fontawesome-free/svgs/solid/check.svg";
import DeleteIcon from "@fortawesome/fontawesome-free/svgs/solid/trash.svg";
import Tab from "@/components/TabBar/Tab.astro";
import ChonkButton from "@/components/ChonkButton.astro";
import NoteStickyIcon from "@fortawesome/fontawesome-free/svgs/solid/note-sticky.svg";
import Drawer from "@/components/Drawer.astro";

const { id } = Astro.params;

if (!id || z.number({ coerce: true }).safeParse(id).success === false) {
  return Astro.redirect("/dashboard/notes");
}

const numericId = parseInt(id);
const currentUser = Astro.locals.auth();
const userId = currentUser ? currentUser.userId : null;

if (!userId) {
  return Astro.redirect("/login");
}

const notes = await db
  .select()
  .from(Notes)
  .where(and(eq(Notes.id, numericId), eq(Notes.userId, userId as string)))
  .limit(1);

if (!notes.length) {
  return Astro.redirect("/dashboard/notes");
}

const noteData = notes[0];

const result = Astro.getActionResult(actions.notes.delete);

if (result?.data?.success) {
  return Astro.redirect("/dashboard");
}
---

<Layout title="Note">
  <div x-data="{ showActionBar: false }" class="flex flex-col min-h-[100vh]">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-6 mx-auto max-w-screen-sm flex items-center gap-2">
        <Tab label="Feed" href="/dashboard" />
        <Tab label="Note" active closable />
      </div>
    </section>

    <main
      class="max-w-screen-sm mx-auto px-6 pt-6 flex-grow flex flex-col"
    >
      <section class="px-1 py-2 flex items-center gap-2">
        <button 
          class="icon-btn rounded-full w-[44px] h-[44px] flex items-center justify-center shadow-[0px_-2.91px_0px_0px_#0000001A_inset]"
          :class="showActionBar ? 'bg-[var(--color-stone-grey)] text-[var(--color-light-paper)] fill-[var(--color-light-paper)]' : 'bg-[var(--color-paper)] text-[var(--color-stone-grey)] fill-[var(--color-stone-grey)]'"
          @click="showActionBar = !showActionBar"
        >
          <BookmarkIcon x-show="!showActionBar" class="w-[20px] h-[20px]" />
          <CheckIcon x-cloak x-show="showActionBar" class="w-[20px] h-[20px]" />
        </button>
        <h1 class="text-title">{noteData.title || "Untitled Note"}</h1>
      </section>

      <section class="!select-text whitespace-normal flex flex-col gap-5 px-6 py-5 bg-(--color-light-paper) rounded-xl trix-content flex-grow mb-6">
        <p class="text-caption text-(--color-stone-grey) w-fit">{noteData.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</p>
        <div set:html={noteData.content}></div>
      </section>
    </main>

    <div x-show="showActionBar" class="bg-(--color-pebble-grey) p-3 mt-auto">
      <div class="grid grid-cols-2 gap-3 max-w-screen-sm mx-auto px-6">
        <a class="grid" href={`/dashboard/notes/${noteData.id}/edit`}>
          <ChonkButton text="Edit">
            <NoteStickyIcon class="w-[15px] h-[15px] text-inherit fill-current" />
          </ChonkButton>
        </a>
        <form class="grid" method="POST" action={actions.notes.delete}>
          <input type="hidden" name="id" value={noteData.id} />
          <input type="hidden" name="userId" value={userId} />
          <ChonkButton text="Delete" type="submit">
            <DeleteIcon class="w-[15px] h-[15px] text-inherit fill-current" />
          </ChonkButton>
        </form>
      </div>
    </div>
  </div>

  <script define:vars={{ noteId: noteData.id }}>
    // Save the current note ID to localStorage
    document.addEventListener('DOMContentLoaded', function() {
      localStorage.setItem('lastViewedNote', noteId.toString());
    });
  </script>
</Layout>