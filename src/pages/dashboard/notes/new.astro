---
import { actions } from "astro:actions";
import { db, Notes, max, sql } from "astro:db";
import Layout from "@/layouts/Layout.astro";
import Tab from "@/components/TabBar/Tab.astro";
import TrixEditor from "@/components/TrixEditor.astro";
import TrixToolbarV2 from "@/components/TrixToolbarV2.astro";
import MetaBar from "@/components/MetaBar.astro";

const currentUser = Astro.locals.auth();
const userId = currentUser ? currentUser.userId : null;

if (!userId) {
  return Astro.redirect("/login");
}

// Find the maximum note ID to display the next one
const maxIdResult = await db.select({ maxId: max(Notes.id) }).from(Notes);
const nextNoteId = maxIdResult[0].maxId ? maxIdResult[0].maxId + 1 : 1;

const result = Astro.getActionResult(actions.notes.create);

if (result?.data?.success) {
  return Astro.redirect("/dashboard/notes/" + result.data.note.id);
}
---

<Layout title="Note" classNames="grid grid-rows-1">
  <div class="flex flex-col h-full" x-data="{ activeDrawer: null }">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-6 mx-auto max-w-screen-sm flex items-center gap-2">
        <Tab label="Feed" href="/dashboard" />
        <Tab label="Note" active closable />
      </div>
    </section>

    <main
      class="flex-1 w-full max-w-screen-sm mx-auto px-6 pt-6 pb-6 flex flex-col gap-3"
    >
      <form
        class="grid gap-3 flex-1 grid-rows-[auto_1fr_auto_auto_auto] w-full"
        method="POST"
        action={actions.notes.create}
      >
        <input
          class="bg-[var(--color-fog-white)] py-3 px-3 rounded-xl w-full"
          type="text"
          name="title"
          placeholder="Title"
          required
        />
        <div class="overflow-auto w-full">
          <TrixEditor toolbar="my_toolbar" name="content" content="" placeholder="Content" />
        </div>
        <TrixToolbarV2 id="my_toolbar" input="content" />
        <div class="w-full pb-[12px]">
          <MetaBar noteId={nextNoteId} />
        </div>
        <input type="hidden" name="userId" value={userId} />
        <input type="hidden" name="isPublic" value="false" />
        <div class="py-3 w-full">
          <button
            class="w-full bg-[var(--color-blue)] text-white py-3 px-3 rounded-xl shadow-[0px_-4px_0px_0px_#0000001A_inset] h-[60px]"
            type="submit">Create Note</button>
        </div>
      </form>
    </main>
    
    <!-- Drawers -->
  </div>
</Layout>

<script define:vars={{ nextNoteId }}>
  // For new notes, we'll handle this differently
  document.addEventListener('DOMContentLoaded', () => {
    // We mark that a note tab is open, but without an ID yet
    localStorage.setItem('lastViewedNote', 'new');
    
    // Listen for drawer events
    window.addEventListener('show-drawer', (event) => {
      // Access the CustomEvent detail safely
      /** @type {{drawer: string}} */
      const detail = event.detail;
      const drawerType = detail?.drawer;
      
      if (drawerType) {
        // Using Alpine from window
        const Alpine = window.Alpine;
        if (Alpine) {
          const mainElement = document.querySelector('main');
          if (mainElement && mainElement.parentElement) {
            Alpine.$data(mainElement.parentElement).activeDrawer = drawerType;
          }
        }
      }
    });
    
    window.addEventListener('hide-drawer', () => {
      // Using Alpine from window
      const Alpine = window.Alpine;
      if (Alpine) {
        const mainElement = document.querySelector('main');
        if (mainElement && mainElement.parentElement) {
          Alpine.$data(mainElement.parentElement).activeDrawer = null;
        }
      }
    });
  });
</script>
