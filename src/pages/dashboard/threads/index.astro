---
import { db, Threads, desc, eq } from "astro:db";
import Layout from "@/layouts/Layout.astro";
import Tab from "@/components/TabBar/Tab.astro";

if (!Astro.locals.auth().userId) {
  return Astro.redirect("/login");
}

const user = await Astro.locals.currentUser();

if (!user) {
  return Astro.redirect("/login");
}

// Fetch user's threads
const threads = await db.select()
  .from(Threads)
  .where(eq(Threads.userId, user.id))
  .orderBy(desc(Threads.createdAt));
---

<Layout title="Threads">
  <div class="flex flex-col h-full">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-6 mx-auto max-w-screen-sm flex items-center">
        <Tab label="Feed" href="/dashboard" />
        <Tab label="Threads" active />
      </div>
    </section>

    <main class="flex-1 w-full max-w-screen-sm mx-auto px-6 pt-6 pb-6 flex flex-col gap-3">
      <div class="flex justify-between items-center">
        <h1 class="text-xl font-bold">Your Threads</h1>
        <a href="/dashboard/threads/new" class="bg-[var(--color-blue)] text-white py-2 px-4 rounded-lg">New Thread</a>
      </div>

      <div class="mt-4 space-y-4">
        {threads.length === 0 ? (
          <div class="text-center py-8 text-gray-500">
            <p>You don't have any threads yet.</p>
            <p class="mt-2">Create your first thread to start organizing your notes.</p>
          </div>
        ) : (
          threads.map((thread) => (
            <div class="bg-[var(--color-fog-white)] p-4 rounded-xl">
              <div class="flex justify-between items-center">
                <h2 class="font-medium">{thread.title}</h2>
                <span class="text-sm text-gray-500">{thread.isPublic ? 'Public' : 'Private'}</span>
              </div>
              <div class="mt-2 flex justify-between items-center">
                <span class="text-sm text-gray-500">
                  Created {new Date(thread.createdAt).toLocaleDateString()}
                </span>
                <div class="flex items-center gap-2">
                  {thread.color && (
                    <span 
                      class="w-4 h-4 rounded-full" 
                      style={`background-color: var(--color-${thread.color})`}
                    ></span>
                  )}
                  <a href={`/dashboard/threads/${thread.id}`} class="text-[var(--color-blue)]">View</a>
                </div>
              </div>
            </div>
          ))
        )}
      </div>
    </main>
  </div>
</Layout> 