---
import { db, eq, Notes, and, NoteThreads, count } from "astro:db";
import { z } from "zod";
import { actions } from "astro:actions";
import Layout from "@/layouts/Layout.astro";
import Tab from "@/components/TabBar/Tab.astro";
import TrixEditor from "@/components/TrixEditor.astro";
import TrixToolbarV2 from "@/components/TrixToolbarV2.astro";
import ThreadsDrawer from "@/components/ThreadsDrawer.astro";
import MetaBar from "@/components/MetaBar.astro";

const { id } = Astro.params;

if (!id || z.number({ coerce: true }).safeParse(id).success === false) {
  return Astro.redirect("/feed/notes");
}

const numericId = parseInt(id);
const currentUser = Astro.locals.auth();
const userId = currentUser ? currentUser.userId : null;

if (!userId) {
  return Astro.redirect("/login");
}

const notes = await db
  .select()
  .from(Notes)
  .where(and(eq(Notes.id, numericId), eq(Notes.userId, userId as string)))
  .limit(1);

if (!notes.length) {
  return Astro.redirect("/feed/notes");
}

// Get thread count for this note
let threadCountValue = 0;
try {
  const threadCount = await db
    .select({ count: count() })
    .from(NoteThreads)
    .where(eq(NoteThreads.noteId, numericId));
  
  threadCountValue = threadCount[0]?.count || 0;
} catch (err) {
  console.error("Error fetching thread count:", err);
}

const noteData = notes[0];

const result = Astro.getActionResult(actions.notes.update);
if (result?.data?.success && result.data.note) {
  return Astro.redirect("/feed/notes/" + result.data.note[0].id);
}
---

<Layout title={noteData.title || 'Edit Note'}>
  <div class="flex flex-col h-[100dvh]">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-3 mx-auto max-w-screen-sm flex items-center">
        <div class="flex h-[48px]">
          <Tab label="Feed" href="/feed" />
          <Tab label="Note" active closable />
          <Tab label="Profile" href="/feed/profile" />
        </div>
      </div>
    </section>

    <main
      class="flex-1 max-w-screen-sm mx-auto w-full px-3 pt-6 flex flex-col h-full overflow-hidden"
    >
      <form
        class="flex flex-col h-full"
        method="POST"
        action={actions.notes.update}
      >
        <input
          class="bg-[var(--color-fog-white)] py-3 px-3 rounded-xl mb-3"
          type="text"
          name="title"
          placeholder="Title"
          required
          value={noteData.title}
        />
        <div class="flex-1 min-h-0 mb-3">
          <TrixEditor toolbar="my_toolbar" name="content" content={noteData.content} placeholder="Content" />
        </div>
        <div class="w-full pb-[12px]">
          <MetaBar noteId={noteData.id} />
        </div>
        <div class="sticky bottom-0 pt-2 z-10">
          <TrixToolbarV2 id="my_toolbar" input="content" />
          <input type="hidden" name="id" value={noteData.id} />
          <input type="hidden" name="userId" value={userId} />
          <input type="hidden" name="isPublic" value="false" />
          <div class="py-3">
            <button
              class="w-full bg-[var(--color-blue)] text-white py-3 px-3 rounded-xl shadow-[0px_-4px_0px_0px_#0000001A_inset] h-[60px]"
              type="submit">Save</button>
          </div>
        </div>
      </form>
    </main>
    
    <!-- Thread Drawer -->
    <ThreadsDrawer noteId={numericId} userId={userId as string} />
  </div>
</Layout>

<script define:vars={{ threadCountValue, noteId: numericId }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Save the current note ID to localStorage
    localStorage.setItem('lastViewedNote', noteId.toString());
    
    // Update thread counter
    const threadCounter = document.querySelector('[data-counter="threads"]');
    if (threadCounter) {
      threadCounter.textContent = threadCountValue.toString();
    }
  });
</script>
