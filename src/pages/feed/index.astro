---
import { actions } from "astro:actions";
import { db, eq, Notes, Threads, desc, NoteThreads, isNull, and, sql } from "astro:db";
import Layout from "@/layouts/Layout.astro";
import NoteCard from "@/components/NoteCard.astro";
import ThreadCard from "@/components/ThreadCard.astro";
import AddButton from "@/components/AddButton.astro";
import Tab from "@/components/TabBar/Tab.astro";
import EllipsisIcon from "@fortawesome/fontawesome-free/svgs/solid/ellipsis.svg";
import GlobalActionBar from "@/components/GlobalActionBar.astro";

// Get userId from auth and redirect if not authenticated
const userId = Astro.locals.auth().userId;
if (!userId) {
  return Astro.redirect("/");
}

// Verify user exists
const user = await Astro.locals.currentUser();
if (!user) {
  return Astro.redirect("/");
}

// Query for unorganized notes (notes that don't belong to any threads)
const notes = await db.select({ 
    id: Notes.id, 
    title: Notes.title, 
    content: Notes.content, 
    createdAt: Notes.createdAt, 
    updatedAt: Notes.updatedAt, 
    userId: Notes.userId, 
    isPublic: Notes.isPublic 
  })
  .from(Notes)
  .leftJoin(NoteThreads, eq(Notes.id, NoteThreads.noteId))
  .where(
    and(
      eq(Notes.userId, userId as string),
      isNull(NoteThreads.id)
    )
  )
  .orderBy(desc(Notes.createdAt));

// Get all threads, sorted by most recently updated first, and if updatedAt is null, then by createdAt
const allThreads = await db.select()
  .from(Threads)
  .where(eq(Threads.userId, userId as string))
  .orderBy(sql`COALESCE(updatedAt, createdAt) DESC`);

// Extract pinned threads for the Pinned Threads section
const pinnedThreads = allThreads.filter(thread => thread.isPinned);

// Create arrays of note and thread IDs for checking in client-side script
const noteIds = notes.map(note => note.id);
const threadIds = allThreads.map(thread => thread.id);
---

<Layout>
  <div class="flex flex-col min-h-[100vh] bg-[var(--color-soft-paper)]">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-3 mx-auto max-w-screen-sm flex items-center justify-between" x-data>
        <div class="flex h-[48px]">
          <Tab label="Feed" href="#" active />
          <div id="thread-tab-container" class="h-full"></div>
          <div id="note-tab-container" class="h-full"></div>
          <Tab label="Profile" href="/feed/profile" />
        </div>
      </div>
    </section>

    <main
      class="max-w-screen-sm mx-auto px-3 pt-6 pb-12 flex flex-col gap-6 flex-grow w-full"
    >
      <!-- New Section -->
      <section class="flex flex-col items-start w-full rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">New</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">0</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
      </section>

      <!-- Pinned Threads Section -->
      <section class="flex flex-col items-start w-full rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">Pinned Threads</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">{pinnedThreads.length}</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
        {pinnedThreads.length > 0 && (
          <div class="w-full px-3 pb-[18px]">
            <div class="flex flex-col gap-3 w-full">
              {
                pinnedThreads.map((thread) => (
                  <div class="w-full">
                    <ThreadCard 
                      title={thread.title} 
                      isPublic={thread.isPublic} 
                      color={thread.color || undefined} 
                      id={thread.id}
                      userId={userId as string}
                    />
                  </div>
                ))
              }
            </div>
          </div>
        )}
      </section>

      <!-- Unorganized Notes Section -->
      <section class="flex flex-col items-start w-full rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">Unorganized Notes</h2>
              <div class="group relative">
                <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">{notes.length}</span>
                <span class="absolute left-1/2 -translate-x-1/2 -top-8 p-1 bg-[#78766F] text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Notes not in any threads</span>
              </div>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
        {notes.length > 0 && (
          <div class="w-full overflow-x-auto px-3 pb-[18px]">
            <div class="flex gap-3 min-w-min">
              {
                notes.map((note) => (
                  <div class="min-w-[160px] max-w-[160px] flex-shrink-0">
                    <NoteCard 
                      title={note.title ?? ""} 
                      content={note.content ?? ""} 
                      id={note.id}
                      userId={userId as string}
                    />
                  </div>
                ))
              }
            </div>
          </div>
        )}
      </section>

      <!-- All Threads Section -->
      <section class="flex flex-col items-start w-full rounded-xl bg-[#E6E4DA]">
        <div class="w-full px-6 py-3">
          <div class="flex items-center justify-between w-full">
            <div class="flex items-center gap-2">
              <h2 class="text-[#78766F] font-sans text-[14px] font-semibold">All Threads</h2>
              <span class="flex w-[21px] p-[2.5px_7px] justify-center items-center rounded-[20px] bg-[#EEECE3] text-[#78766F] font-mono text-[12px] font-semibold">{allThreads.length}</span>
            </div>
            <div class="flex items-center">
              <EllipsisIcon class="w-4 h-4 fill-[#78766F]" />
            </div>
          </div>
        </div>
        {allThreads.length > 0 && (
          <div class="w-full px-3 pb-[18px]">
            <div class="flex flex-col gap-3 w-full">
              {
                allThreads.map((thread) => (
                  <div class="w-full">
                    <ThreadCard 
                      title={thread.title} 
                      isPublic={thread.isPublic} 
                      color={thread.color || undefined} 
                      id={thread.id}
                      userId={userId as string}
                    />
                  </div>
                ))
              }
            </div>
          </div>
        )}
      </section>
    </main>
    
    <!-- Floating Action Button for creating a new note -->
    <div class="fixed bottom-[32px] right-[32px] z-50">
      <AddButton />
    </div>
    
    <!-- Global Action Bar (empty placeholder - will be populated dynamically) -->
    <div id="global-action-bar-container"></div>
  </div>

  <script define:vars={{ noteIds, threadIds, pinnedThreads }}>
    // Check if the user was viewing a note previously and keep the tab if they were
    document.addEventListener('DOMContentLoaded', () => {
      const lastViewedNote = localStorage.getItem('lastViewedNote');
      const noteTabContainer = document.getElementById('note-tab-container');
      const lastViewedThread = localStorage.getItem('lastViewedThread');
      const sourceThreadForNote = localStorage.getItem('sourceThreadForNote');
      const threadTabContainer = document.getElementById('thread-tab-container');

      // First add Thread tab if applicable
      if ((lastViewedThread || sourceThreadForNote) && threadTabContainer) {
        const threadId = lastViewedThread || sourceThreadForNote;
        
        // Check if it's a new thread or if the thread exists in the database
        if (threadId === 'new' || threadIds.includes(parseInt(threadId))) {
          const threadTab = document.createElement('div');
          threadTab.style.margin = '0'; // Ensure no margin
          threadTab.style.padding = '0'; // Ensure no padding
          
          // For new threads vs existing threads
          const href = threadId === 'new' ? '/feed/threads/new' : `/feed/threads/${threadId}`;
          
          threadTab.innerHTML = `
            <div class="h-[48px]">
              <a href="${href}" class="h-full rounded-t-lg bg-(--color-fog-white) flex items-center" role="tab">
                <div class="h-full flex items-center pl-[20px] pr-[12px] gap-2">
                  <span class="font-bold text-sm text-(--color-stone-grey)">Thread</span>
                  <button class="w-[15px] h-[15px] flex items-center justify-center text-[15px] font-medium text-(--color-stone-grey) p-0 border-0 bg-transparent cursor-pointer" onclick="closeThreadTab(event)">×</button>
                </div>
              </a>
            </div>
          `;
          threadTabContainer.appendChild(threadTab);
        } else {
          // Thread doesn't exist anymore, remove from localStorage
          localStorage.removeItem('lastViewedThread');
          localStorage.removeItem('sourceThreadForNote');
        }
      }
      
      // Then add Note tab if applicable
      if (lastViewedNote && noteTabContainer) {
        const noteId = lastViewedNote;
        
        // Check if it's a new note or if the note exists in the database
        if (noteId === 'new' || noteIds.includes(parseInt(noteId))) {
          const noteTab = document.createElement('div');
          noteTab.style.margin = '0'; // Ensure no margin
          noteTab.style.padding = '0'; // Ensure no padding
          
          // For new notes vs existing notes
          const href = noteId === 'new' ? '/feed/notes/new' : `/feed/notes/${noteId}`;
          
          // If note is from a thread, include the thread ID
          let finalHref = href;
          if (sourceThreadForNote) {
            finalHref = `${href}?threadId=${sourceThreadForNote}`;
          }
          
          noteTab.innerHTML = `
            <div class="h-[48px]">
              <a href="${finalHref}" class="h-full rounded-t-lg bg-(--color-fog-white) flex items-center" role="tab">
                <div class="h-full flex items-center pl-[20px] pr-[12px] gap-2">
                  <span class="font-bold text-sm text-(--color-stone-grey)">Note</span>
                  <button class="w-[15px] h-[15px] flex items-center justify-center text-[15px] font-medium text-(--color-stone-grey) p-0 border-0 bg-transparent cursor-pointer" onclick="closeNoteTab(event)">×</button>
                </div>
              </a>
            </div>
          `;
          noteTabContainer.appendChild(noteTab);
        } else {
          // Note doesn't exist anymore, remove from localStorage
          localStorage.removeItem('lastViewedNote');
          localStorage.removeItem('sourceThreadForNote');
        }
      }
    });

    function closeNoteTab(event) {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      // When closing note tab in feed view, we shouldn't necessarily clear sourceThreadForNote
      // if the thread tab is still visible
      localStorage.removeItem('lastViewedNote');
      
      // Only clear source thread reference if thread tab is not visible
      const threadTab = document.querySelector('a[href^="/feed/threads/"]');
      if (!threadTab) {
        localStorage.removeItem('sourceThreadForNote');
      }
      
      const noteTabContainer = document.getElementById('note-tab-container');
      if (noteTabContainer) {
        noteTabContainer.innerHTML = '';
      }
      
      window.location.reload();
    }
    
    function closeThreadTab(event) {
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      localStorage.removeItem('lastViewedThread');
      localStorage.removeItem('sourceThreadForNote');
      const threadTabContainer = document.getElementById('thread-tab-container');
      if (threadTabContainer) {
        threadTabContainer.innerHTML = '';
      }
      
      // If we're closing the thread tab, also close the note tab
      // since the note context depends on the thread
      closeNoteTab();
      
      window.location.reload();
    }
    
    window.closeNoteTab = closeNoteTab;
    window.closeThreadTab = closeThreadTab;

    // Initialize global action bar component
    document.addEventListener('DOMContentLoaded', () => {
      // Create container for global action bar
      const container = document.getElementById('global-action-bar-container');
      if (container) {
        // Add CSS
        const style = document.createElement('style');
        style.textContent = `
          #global-action-bar[data-visible="true"] {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
          }
          
          .action-button {
            background-color: var(--color-stone-grey);
            box-shadow: 0px -4px 0px 0px #00000040 inset;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            cursor: pointer;
            min-height: 64px;
            font-size: 16px;
          }
          
          .action-button:active {
            transform: scale(0.99);
            box-shadow: 0px -2px 0px 0px #0000001a inset,
              0px 0px 2px 0px #00000040,
              0px 2px 0px 0px #00000040 inset;
          }
          
          .action-button .icon-container {
            margin-bottom: 8px;
          }
          
          .action-button .text-container {
            font-weight: 500;
            line-height: 100%;
          }
        `;
        document.head.appendChild(style);
      }
    });
  </script>

  <script>
    // Declare types for the global functions
    declare global {
      interface Window {
        handleActionButtonClick: (type: string, id: string | number, userId: string, button: HTMLElement) => void;
        toggleGlobalActionBar: (type: string, id: string | number, userId: string) => void;
      }
    }
    
    // Global function to handle action button clicks for both notes and threads
    window.handleActionButtonClick = function(type: string, id: string | number, userId: string, button: HTMLElement) {
      console.log('Action button clicked:', type, id, userId);
      
      // Toggle button appearance
      const normalIcon = button.querySelector('.normal-icon');
      const checkIcon = button.querySelector('.x-icon');
      
      if (normalIcon && checkIcon) {
        // Toggle icon visibility
        const isActive = button.classList.toggle('active');
        
        // Call the global action bar toggle function
        if (window.toggleGlobalActionBar) {
          window.toggleGlobalActionBar(type, id, userId);
        }
      }
    }
  </script>

  <script define:vars={{ pinnedThreads }}>
    // Add global action bar toggle function to window so components can call it
    window.toggleGlobalActionBar = function(type, id, userId) {
      console.log('Toggle global action bar:', type, id, userId);
      
      // Find the action bar
      const actionBar = document.getElementById('global-action-bar');
      const container = document.getElementById('global-action-bar-container');
      
      // Check if clicking the same item
      const currentType = actionBar?.getAttribute('data-type');
      const currentId = actionBar?.getAttribute('data-id');
      const isVisible = actionBar?.getAttribute('data-visible') === 'true';
      
      if (isVisible && currentType === type && currentId === id.toString()) {
        // Close it
        if (actionBar) {
          actionBar.setAttribute('data-visible', 'false');
          actionBar.setAttribute('data-type', '');
          actionBar.setAttribute('data-id', '');
        }
        
        // Reset the button state
        const button = document.querySelector(`.${type}-action-btn[data-id="${id}"]`);
        if (button) {
          button.classList.remove('bg-[var(--color-stone-grey)]', 'text-[var(--color-light-paper)]', 'fill-[var(--color-light-paper)]');
          button.classList.add('bg-[var(--color-paper)]', 'text-[var(--color-stone-grey)]', 'fill-[var(--color-stone-grey)]');
        }
        
        return;
      }
      
      // Reset all button states first
      const allButtons = document.querySelectorAll('.note-action-btn, .thread-action-btn');
      allButtons.forEach(btn => {
        btn.classList.remove('bg-[var(--color-stone-grey)]', 'text-[var(--color-light-paper)]', 'fill-[var(--color-light-paper)]');
        btn.classList.add('bg-[var(--color-paper)]', 'text-[var(--color-stone-grey)]', 'fill-[var(--color-stone-grey)]');
      });
      
      // Update the active button state
      const activeButton = document.querySelector(`.${type}-action-btn[data-id="${id}"]`);
      if (activeButton) {
        activeButton.classList.remove('bg-[var(--color-paper)]', 'text-[var(--color-stone-grey)]', 'fill-[var(--color-stone-grey)]');
        activeButton.classList.add('bg-[var(--color-stone-grey)]', 'text-[var(--color-light-paper)]', 'fill-[var(--color-light-paper)]');
      }
      
      // Get isPinned status if it's a thread
      let isPinned = false;
      if (type === 'thread') {
        // Try to find the thread in the pinnedThreads array
        isPinned = pinnedThreads.some(thread => thread.id.toString() === id.toString());
      }
      
      // Create new GlobalActionBar component with correct props
      if (container) {
        container.innerHTML = ''; // Clear existing content
        
        // Create new action bar
        const newActionBar = document.createElement('div');
        newActionBar.innerHTML = `
          <div
            id="global-action-bar"
            class="fixed left-0 right-0 top-[32px] z-50 opacity-0 pointer-events-none transition-all duration-200 ease-in-out transform translate-y-[-8px]"
            data-visible="true"
            data-type="${type}"
            data-id="${id}"
          >
            <div class="max-w-screen-sm mx-auto px-3">
              <div class="bg-[#7d7a6f] p-3 rounded-xl shadow-lg -mx-[12px]">
                <div class="grid ${type === 'thread' ? 'grid-cols-3' : 'grid-cols-2'} gap-3 w-full">
                  <a class="grid" href="${type === 'note' ? `/feed/notes/${id}/edit` : `/feed/threads/${id}/edit`}">
                    <div class="action-button rounded-lg flex flex-col items-center justify-center pt-3 pb-4 px-3 active:scale-[.99] transition-transform duration-125">
                      <div class="icon-container">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="w-[18px] h-[18px] text-white fill-current">
                          <path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7 .8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/>
                        </svg>
                      </div>
                      <div class="text-container text-white text-[16px]">${type === 'note' ? 'Edit Note' : 'Edit Thread'}</div>
                    </div>
                  </a>
                  ${type === 'thread' ? `
                  <form 
                    class="grid" 
                    id="global-pin-form"
                    method="POST" 
                    action="/api/threads/toggle-pin"
                  >
                    <input type="hidden" name="id" value="${id}" />
                    <input type="hidden" name="userId" value="${userId}" />
                    <button type="submit" style="width: 100%; height: 100%; padding: 0; background: none; border: none;">
                      <div class="action-button rounded-lg flex flex-col items-center justify-center pt-3 pb-4 px-3 active:scale-[.99] transition-transform duration-125">
                        <div class="icon-container">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" class="w-[18px] h-[18px] text-white fill-current">
                            <path d="M32 32C32 14.3 46.3 0 64 0H320c17.7 0 32 14.3 32 32s-14.3 32-32 32H290.5l11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3H32c-10.3 0-19.9-4.9-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64H64C46.3 64 32 49.7 32 32zM160 384h64v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V384z"/>
                          </svg>
                        </div>
                        <div class="text-container text-white text-[16px]">${isPinned ? 'Unpin' : 'Pin'}</div>
                      </div>
                    </button>
                  </form>
                  ` : ''}
                  <form 
                    class="grid" 
                    id="global-delete-form"
                    method="POST" 
                    action="${type === 'note' ? '/api/notes/delete' : '/api/threads/delete'}"
                  >
                    <input type="hidden" name="id" value="${id}" />
                    <input type="hidden" name="userId" value="${userId}" />
                    <button type="submit" style="width: 100%; height: 100%; padding: 0; background: none; border: none;">
                      <div class="action-button rounded-lg flex flex-col items-center justify-center pt-3 pb-4 px-3 active:scale-[.99] transition-transform duration-125">
                        <div class="icon-container">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-[18px] h-[18px] text-white fill-current">
                            <path d="M170.5 51.6L151.5 80h145l-19-28.4c-1.5-2.2-4-3.6-6.7-3.6H177.1c-2.7 0-5.2 1.3-6.7 3.6zm147-26.6L354.2 80H368h48 8c13.3 0 24 10.7 24 24s-10.7 24-24 24h-8V432c0 44.2-35.8 80-80 80H112c-44.2 0-80-35.8-80-80V128h-8c-13.3 0-24-10.7-24-24S10.7 80 24 80h8h48 14.2l36.6-55.1C140.9 9.4 158.4 0 177.1 0h93.7c18.7 0 36.2 9.4 46.6 24.9zM80 128V432c0 17.7 14.3 32 32 32H336c17.7 0 32-14.3 32-32V128H80zm80 64V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16zm80 0V400c0 8.8-7.2 16-16 16s-16-7.2-16-16V192c0-8.8 7.2-16 16-16s16 7.2 16 16z"/>
                          </svg>
                        </div>
                        <div class="text-container text-white text-[16px]">Delete</div>
                      </div>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        `;
        container.appendChild(newActionBar);
        
        // Get the action bar that was just added to the DOM
        const addedActionBar = document.getElementById('global-action-bar');
        if (addedActionBar) {
          addedActionBar.setAttribute('data-visible', 'true');
        }
        
        // Add event listener to the pin form
        const pinForm = document.getElementById('global-pin-form');
        if (pinForm) {
          pinForm.addEventListener('submit', handlePinFormSubmit);
        }
        
        // Add event listener to the delete form
        const deleteForm = document.getElementById('global-delete-form');
        if (deleteForm) {
          deleteForm.addEventListener('submit', handleDeleteFormSubmit);
        }
      }
    };
    
    // Handle Pin Form Submission
    function handlePinFormSubmit(e) {
      e.preventDefault();
      const form = e.currentTarget;
      
      fetch(form.action, {
        method: 'POST',
        body: new FormData(form)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Show toast
          window.dispatchEvent(new CustomEvent('toast', {
            detail: {
              message: data.success,
              type: 'info'
            }
          }));
          
          // Refresh the page after a short delay
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        window.dispatchEvent(new CustomEvent('toast', {
          detail: {
            message: error.message || 'An error occurred',
            type: 'error'
          }
        }));
      });
    }
    
    // Handle Delete Form Submission
    function handleDeleteFormSubmit(e) {
      e.preventDefault();
      const form = e.currentTarget;
      
      // Get the type from the action bar
      const actionBar = document.getElementById('global-action-bar');
      const type = actionBar?.dataset.type || 'note';
      
      // Clear localStorage depending on type
      if (type === 'note') {
        localStorage.removeItem('lastViewedNote');
      } else if (type === 'thread') {
        localStorage.removeItem('lastViewedThread');
        localStorage.removeItem('sourceThreadForNote');
        localStorage.removeItem('lastViewedThreadColor');
      }
      
      // Submit form data via fetch
      fetch(form.action, {
        method: 'POST',
        body: new FormData(form)
      })
      .then(response => response.json())
      .then(data => {
        console.log('Delete response:', data);
        if (data.success) {
          // Show toast
          window.dispatchEvent(new CustomEvent('toast', {
            detail: {
              message: data.message,
              type: 'info'
            }
          }));
          
          // Redirect after a short delay
          setTimeout(() => {
            window.location.href = '/feed';
          }, 1500);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        window.dispatchEvent(new CustomEvent('toast', {
          detail: {
            message: error.message || 'Failed to delete',
            type: 'error'
          }
        }));
        
        // Redirect to feed after a short delay on error
        setTimeout(() => {
          window.location.href = '/feed';
        }, 1500);
      });
    }
    
    // Close action bar when clicking outside
    document.addEventListener('click', function(event) {
      const actionBar = document.getElementById('global-action-bar');
      if (!actionBar) return;
      
      const actionButtons = document.querySelectorAll('.note-action-btn, .thread-action-btn');
      const target = event.target;
      
      // Check if we clicked inside the action bar or on an action button
      let isActionBarOrButton = false;
      
      // Check if target is a Node and contained in actionBar
      if (target instanceof Node && actionBar.contains(target)) {
        isActionBarOrButton = true;
      }
      
      // Check action buttons
      actionButtons.forEach(button => {
        if (target instanceof Node && button.contains(target)) {
          isActionBarOrButton = true;
        }
      });
      
      // If clicking outside, close the action bar
      if (!isActionBarOrButton && actionBar.getAttribute('data-visible') === 'true') {
        // Hide the action bar
        actionBar.setAttribute('data-visible', 'false');
        
        // Reset button states
        actionButtons.forEach(button => {
          button.classList.remove('bg-[var(--color-stone-grey)]', 'text-[var(--color-light-paper)]', 'fill-[var(--color-light-paper)]');
          button.classList.add('bg-[var(--color-paper)]', 'text-[var(--color-stone-grey)]', 'fill-[var(--color-stone-grey)]');
        });
      }
    });
  </script>
</Layout>

<style>
  /* Global action bar styling */
  #global-action-bar[data-visible="true"] {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
  }
  
  .action-button {
    box-shadow: 0px -4px 0px 0px #00000040 inset;
  }
  
  button:active .action-button, a:active .action-button {
    box-shadow:
      0px -2px 0px 0px #0000001a inset,
      0px 0px 2px 0px #00000040,
      0px 2px 0px 0px #00000040 inset;
  }
</style>
