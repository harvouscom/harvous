---
import { actions } from "astro:actions";
import { db, Threads, max, sql } from "astro:db";
import Layout from "@/layouts/Layout.astro";
import Tab from "@/components/TabBar/Tab.astro";
import ThreadMetaBar from "@/components/ThreadMetaBar.astro";
import TitleInput from "@/components/TitleInput.astro";
import ThreadColorPicker from "@/components/ThreadColorPicker.astro";
import LockIcon from "@fortawesome/fontawesome-free/svgs/solid/lock.svg";
import GlobeIcon from "@fortawesome/fontawesome-free/svgs/solid/globe.svg";
import XmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
import DeleteIcon from "@fortawesome/fontawesome-free/svgs/solid/trash.svg";
import PencilIcon from "@fortawesome/fontawesome-free/svgs/solid/pencil.svg";
import ChonkButton from "@/components/ChonkButton.astro";

const currentUser = Astro.locals.auth();
const userId = currentUser ? currentUser.userId : null;

if (!userId) {
  return Astro.redirect("/login");
}

// Find the maximum thread ID to display the next one
const maxIdResult = await db.select({ maxId: max(Threads.id) }).from(Threads);
const nextThreadId = maxIdResult[0].maxId ? maxIdResult[0].maxId + 1 : 1;

const result = Astro.getActionResult(actions.threads.create);

if (result?.data?.success) {
  return Astro.redirect("/feed/threads/" + result.data.thread.id);
}
---

<Layout title="New Thread">
  <div class="flex flex-col min-h-[100vh] bg-[var(--color-soft-paper)]" x-data="{ activeDrawer: null, showActionBar: false, isPublic: false }">
    <section class="bg-(--color-fog-white) pt-3">
      <div class="px-3 mx-auto max-w-screen-sm flex items-center">
        <div class="flex h-[48px] overflow-x-auto overflow-y-hidden w-full tab-container">
          <Tab label="Feed" href="/feed" />
          <Tab label="Search" href="/feed/search" />
          <Tab label="Thread" active closable />
          <Tab label="Profile" href="/feed/profile" />
        </div>
      </div>
    </section>

    <main
      class="flex-1 w-full max-w-screen-sm mx-auto px-3 pt-6 pb-6 flex flex-col"
    >
      <section class="w-full px-1 py-2 flex items-center gap-2 relative">
        <button 
          class="icon-btn rounded-full w-[44px] h-[44px] flex items-center justify-center shadow-[0px_-2.91px_0px_0px_#0000001A_inset]"
          :class="showActionBar ? 'bg-[var(--color-stone-grey)] text-[var(--color-light-paper)] fill-[var(--color-light-paper)]' : 'bg-[var(--color-paper)] text-[var(--color-stone-grey)] fill-[var(--color-stone-grey)]'"
          @click="showActionBar = !showActionBar"
        >
          <LockIcon x-show="!showActionBar && !isPublic" class="w-[20px] h-[20px]" />
          <GlobeIcon x-show="!showActionBar && isPublic" class="w-[20px] h-[20px]" />
          <XmarkIcon x-cloak x-show="showActionBar" class="w-[20px] h-[20px]" />
        </button>
        <h1 class="text-title">New Thread</h1>
        
        <!-- Floating action bar positioned absolutely below the button -->
        <div 
          x-show="showActionBar" 
          x-cloak
          class="absolute top-[64px] left-[-12px] right-[-12px] z-10 bg-(--color-pebble-grey) p-3 rounded-xl shadow-lg"
        >
          <div class="grid grid-cols-2 gap-3 w-full">
            <a class="grid" href="/feed/threads/new">
              <ChonkButton text="Reset Form">
                <PencilIcon class="w-[15px] h-[15px] text-inherit fill-current" />
              </ChonkButton>
            </a>
            <a class="grid" href="/feed">
              <ChonkButton text="Cancel">
                <DeleteIcon class="w-[15px] h-[15px] text-inherit fill-current" />
              </ChonkButton>
            </a>
          </div>
        </div>
      </section>
      
      <form
        class="flex flex-col mt-3"
        method="POST"
        action={actions.threads.create}
      >
        <div class="space-y-3">
          <TitleInput placeholder="Name your Thread" name="title" />
          <ThreadMetaBar threadId={nextThreadId} />
          
          <div class="mt-4">
            <label class="block text-sm font-medium mb-2">Thread Color</label>
            <ThreadColorPicker selectedColor="blessed-blue" />
          </div>
          
          <input type="hidden" name="isPublic" id="isPublic" value="false" x-bind:value="isPublic.toString()" />
          <input type="hidden" name="userId" value={userId} />
          
          <div class="py-2">
            <button
              class="w-full bg-[var(--color-blue)] text-white py-3 px-3 rounded-xl shadow-[0px_-4px_0px_0px_#0000001A_inset] h-[60px]"
              type="submit">Add</button>
          </div>
        </div>
      </form>
    </main>
    
    <!-- Drawers -->
  </div>
</Layout>

<script define:vars={{ nextThreadId }}>
  // For new threads, handle this differently
  document.addEventListener('DOMContentLoaded', () => {
    // Mark that a thread tab is open, but without an ID yet
    localStorage.setItem('lastViewedThread', 'new');
    
    // Set up privacy toggle
    const metabarPrivacyButton = document.querySelector('.button-wrapper');
    const isPublicInput = document.getElementById('isPublic');
    
    if (metabarPrivacyButton && isPublicInput) {
      metabarPrivacyButton.addEventListener('click', () => {
        const currentValue = isPublicInput.value === 'true';
        isPublicInput.value = (!currentValue).toString();
        
        // Update the button text
        const buttonText = metabarPrivacyButton.querySelector('p');
        if (buttonText) {
          buttonText.textContent = !currentValue ? 'Public' : 'Private';
        }
        
        // Update the icon
        const buttonIcon = metabarPrivacyButton.querySelector('svg');
        if (buttonIcon) {
          // Toggle classes for the icon based on public/private state
          if (!currentValue) {
            buttonIcon.classList.add('public-icon');
            buttonIcon.classList.remove('private-icon');
          } else {
            buttonIcon.classList.add('private-icon');
            buttonIcon.classList.remove('public-icon');
          }
        }
        
        // Update Alpine state for the main icon button
        const Alpine = window.Alpine;
        if (Alpine) {
          const mainElement = document.querySelector('main');
          if (mainElement && mainElement.parentElement) {
            Alpine.$data(mainElement.parentElement).isPublic = !currentValue;
          }
        }
      });
    }
    
    // Listen for drawer events
    window.addEventListener('show-drawer', (event) => {
      // Access the CustomEvent detail safely
      /** @type {{drawer: string}} */
      const detail = event.detail;
      const drawerType = detail?.drawer;
      
      if (drawerType) {
        // Using Alpine from window
        const Alpine = window.Alpine;
        if (Alpine) {
          const mainElement = document.querySelector('main');
          if (mainElement && mainElement.parentElement) {
            Alpine.$data(mainElement.parentElement).activeDrawer = drawerType;
          }
        }
      }
    });
    
    window.addEventListener('hide-drawer', () => {
      // Using Alpine from window
      const Alpine = window.Alpine;
      if (Alpine) {
        const mainElement = document.querySelector('main');
        if (mainElement && mainElement.parentElement) {
          Alpine.$data(mainElement.parentElement).activeDrawer = null;
        }
      }
    });
  });
</script> 