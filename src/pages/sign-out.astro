---
import { SignOutButton } from "@clerk/astro/components";
import Layout from '@/layouts/Layout.astro';

// Check if we should force sign-out based on URL parameter
const url = new URL(Astro.request.url);
const forceSignOut = url.searchParams.get('force') === 'true';
---

<Layout title="Signing Out">
  <div class="min-h-screen flex flex-col items-center justify-center bg-[#f2f0e6]">
    <h1 class="text-2xl font-bold mb-6">Signing you out...</h1>
    
    <div id="sign-out-action">
      <SignOutButton>
        <button id="auto-click-signout" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
          Click here if you're not redirected
        </button>
      </SignOutButton>
    </div>
    
    <p class="mt-4 text-gray-600">You will be redirected to the homepage shortly.</p>
  </div>
</Layout>

<script define:vars={{ forceSignOut }}>
  // Auto-click the sign-out button when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    // Short delay to ensure Clerk components are loaded
    setTimeout(() => {
      const signOutButton = document.getElementById('auto-click-signout');
      if (signOutButton) {
        signOutButton.click();
      }
      
      // Force sign out using Clerk's global API if forceSignOut is true
      if (forceSignOut && window.Clerk) {
        try {
          window.Clerk.signOut()
            .then(() => {
              console.log("Signed out successfully");
              window.location.href = '/?signedout=true';
            })
            .catch(error => {
              console.error("Error signing out:", error);
              // Still try to redirect
              window.location.href = '/?error=signout';
            });
        } catch (error) {
          console.error("Error using Clerk signOut:", error);
          // Fallback to normal redirect
          window.location.href = '/';
        }
      } else {
        // Redirect to home page after a delay if not using force sign-out
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);
      }
    }, 500);
  });
</script> 