---
import Layout from "@/layouts/Layout.astro";
import NavigationColumnReact from "@/components/NavigationColumnReact.astro";
import MobileNavigation from "@/components/MobileNavigation.astro";
import MobileAdditional from "@/components/MobileAdditional.astro";
import NewSpacePanelReact from "@/components/NewSpacePanelReact.astro";
import { getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
import { calculateTotalXP } from "@/utils/xp-system";
import { getThreadGradientCSS } from "@/utils/colors";

// Get user data from Clerk authentication
const auth = Astro.locals.auth();
const { userId, getToken } = auth;

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Try to fetch user data from Clerk API using secret key
let userData: any = null;
try {
  const clerkSecretKey = import.meta.env.CLERK_SECRET_KEY;
  console.log('Clerk secret key available:', clerkSecretKey ? 'Yes' : 'No');
  
  if (clerkSecretKey) {
    const response = await fetch(`https://api.clerk.com/v1/users/${userId}`, {
      headers: {
        'Authorization': `Bearer ${clerkSecretKey}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log('API response status:', response.status);
    
    if (response.ok) {
      userData = await response.json();
      console.log('User data from Clerk API:', userData);
    } else {
      const errorText = await response.text();
      console.log('API error response:', errorText);
    }
  }
} catch (error) {
  console.log('Error fetching user data:', error);
}

// Extract user data from API response or use fallbacks
const firstName = userData?.first_name || userData?.firstName || '';
const lastName = userData?.last_name || userData?.lastName || '';
const email = userData?.email_addresses?.[0]?.email_address || userData?.email || '';

// Generate initials from first and last name
const initials = `${firstName.charAt(0) || ''}${lastName.charAt(0) || ''}`.toUpperCase() || 'U';
const displayName = `${firstName} ${lastName.charAt(0)}`.trim() || 'User';

// Get user color from database
let userColor = 'paper'; // default
try {
  const { db, UserMetadata, eq } = await import('astro:db');
  const userMetadata = await db.select().from(UserMetadata).where(eq(UserMetadata.userId, userId)).get();
  userColor = userMetadata?.userColor || 'paper';
} catch (error) {
  console.log('Error fetching user color:', error);
}

// Fetch navigation data for mobile components and XP data
let spaces: any[] = [];
let threads: any[] = [];
let inboxCount: number = 0;
let userXP: number = 0;

try {
  const [spacesData, threadsData, inboxCountData, xpData] = await Promise.all([
    getSpacesWithCounts(userId),
    getAllThreadsWithCounts(userId),
    getInboxCount(userId),
    calculateTotalXP(userId)
  ]);
  
  spaces = spacesData;
  threads = threadsData;
  inboxCount = inboxCountData;
  userXP = xpData;
  
  // Ensure threads have backgroundGradient property for consistency
  threads = threads.map(thread => ({
    ...thread,
    backgroundGradient: thread.backgroundGradient || getThreadGradientCSS(thread.color || 'blue')
  }));
  
  // Ensure spaces have backgroundGradient property for consistency
  spaces = spaces.map(space => ({
    ...space,
    backgroundGradient: space.backgroundGradient || getThreadGradientCSS(space.color || 'blue')
  }));
} catch (error) {
  console.error("Error fetching navigation data:", error);
  // Fallback to empty data
  spaces = [];
  threads = [];
  inboxCount = 0;
  userXP = 0;
}

const contentType = "profile";
const contentId = "new-space";
---

<Layout title="New Space" contentType={contentType} contentId={contentId}>
  <!-- Navigation Column -->
  <NavigationColumnReact 
    slot="navigation"
    inboxCount={inboxCount}
    spaces={spaces}
    activeThread={null}
    currentSpace={null}
    isNote={false}
    currentId="new-space"
    showProfile={false}
    initials={initials}
    userColor={userColor}
  />

  <!-- Main Column -->
  <div slot="main" class="h-full flex flex-col">
    <NewSpacePanelReact />
  </div>

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">
    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxCount}
      currentSpace={null}
      currentThread={null}
      initials={initials}
      userColor={userColor}
    />
  </div>

  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional contentType="profile" contentId={contentId} currentThread={null} currentSpace={null} />
  </div>
</Layout>

<script is:inline>
  // Handle closeNewSpacePanel event to navigate back
  window.addEventListener('closeNewSpacePanel', () => {
    // Use requestAnimationFrame to ensure current page is fully rendered
    // before navigating, which helps View Transitions properly swap all slots
    requestAnimationFrame(() => {
      // Navigate back to dashboard
      if (window.astroNavigate) {
        window.astroNavigate('/');
        
        // After navigation, verify that navigation slot is properly loaded
        // This is a safety check to ensure View Transitions worked correctly
        setTimeout(() => {
          const navigationSlot = document.querySelector('[slot="navigation"]');
          const navigationIsland = navigationSlot?.querySelector('astro-island');
          
          // If navigation slot exists but island isn't hydrated after a delay, 
          // it might indicate a View Transitions issue
          // Note: This is just a check, Astro should handle hydration automatically
          if (navigationSlot && !navigationIsland?.shadowRoot) {
            // Island might still be hydrating, which is normal
            // But if it takes too long, we could force a refresh as fallback
            // For now, we'll let Astro handle it naturally
          }
        }, 500);
      } else {
        window.location.href = '/';
      }
    });
  });
</script>

