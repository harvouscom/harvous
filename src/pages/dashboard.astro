---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import SearchInput from "@/components/SearchInput.astro";
import SpaceButton from "@/components/SpaceButton.astro";
import Avatar from "@/components/Avatar.astro";
import TabNav from "@/components/TabNav.astro";
import CardFeat from "@/components/CardFeat.astro";
import CardNote from "@/components/CardNote.astro";
import CardThread from "@/components/CardThread.astro";
import PersistentNavigation from "@/components/PersistentNavigation.astro";
import { getFeaturedContent, getContentItems, getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
// Sample data imports removed - using real database data only
import { detectActiveThreadFromPath } from "@/utils/navigation-state";
import { db, Threads, Notes, eq, and, count } from "astro:db";
import MobileNavigation from "@/components/MobileNavigation.astro";
import MobileAdditional from "@/components/MobileAdditional.astro";
// Get user ID from Clerk authentication
const { userId } = Astro.locals.auth();
console.log("Dashboard: Using authenticated user ID:", userId);

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Fetch real data from database
// Use robust sample data system for consistent development experience
let featuredContent: any[] = [];
let contentItems: any[] = [];
let threads: any[] = [];
let spaces: any[] = [];
let inboxCount: number = 0;

// Always use real database data
try {
    console.log("Starting dashboard data fetch for user:", userId);
    
    // Fetch data one by one to isolate any issues
    console.log("Fetching featured content...");
    featuredContent = await getFeaturedContent(userId);
    console.log("Featured content fetched:", featuredContent.length);
    
    console.log("Fetching content items...");
    contentItems = await getContentItems(userId);
    console.log("Content items fetched:", contentItems.length);
    
    console.log("Fetching threads...");
    threads = await getAllThreadsWithCounts(userId);
    console.log("Threads fetched:", threads.length);
    
    console.log("Fetching spaces...");
    spaces = await getSpacesWithCounts(userId);
    console.log("Spaces fetched:", spaces.length);
    
    console.log("Fetching inbox count...");
    inboxCount = await getInboxCount(userId);
    console.log("Inbox count fetched:", inboxCount);
    
    console.log("Dashboard data fetched successfully:", {
      featuredContent: featuredContent.length,
      contentItems: contentItems.length,
      threads: threads.length,
      spaces: spaces.length,
      inboxCount
    });
    
    // Ensure threads have backgroundGradient property for consistency
    threads = threads.map(thread => ({
      ...thread,
      backgroundGradient: thread.backgroundGradient || `linear-gradient(180deg, var(--color-${thread.color || 'blessed-blue'}) 0%, var(--color-${thread.color || 'blessed-blue'}) 100%)`
    }));
    
    // Ensure spaces have backgroundGradient property for consistency
    spaces = spaces.map(space => ({
      ...space,
      backgroundGradient: space.backgroundGradient || `linear-gradient(180deg, var(--color-${space.color || 'blessed-blue'}) 0%, var(--color-${space.color || 'blessed-blue'}) 100%)`
    }));
} catch (error) {
  console.error("Error fetching dashboard data:", error);
  console.error("Error details:", error instanceof Error ? error.message : String(error));
  console.error("Error stack:", error instanceof Error ? error.stack : 'No stack trace available');
  
  // In production, we want to see the actual error instead of silent fallback
  if (import.meta.env.PROD) {
    console.error("PRODUCTION ERROR: Dashboard data fetch failed");
    console.error("This indicates a serious issue with database connectivity or data integrity");
    // Still provide fallback data but log the error prominently
  }
  
  // Fallback to empty data if database fails
  featuredContent = [];
  contentItems = [];
  threads = [];
  spaces = [];
  inboxCount = 0;
  
  // Add some debug info
  console.log("Using fallback empty data due to error");
}

// Combine all content for the main content section
// Inbox shows only unorganized threads (not individual notes)
const inboxContent = featuredContent.filter(item => item.type === 'thread');
// Organized content should only include contentItems, not featuredContent notes
// to avoid duplication of unorganized notes
const organizedContent = contentItems;
// Use the actual count of items displayed in inbox, not the total inbox count
const inboxItemCount = inboxContent.length;

// Get active thread context for navigation
const activeThread = await detectActiveThreadFromPath('/dashboard', userId);

// Check if unorganized thread has notes and should be shown in navigation
let unorganizedThread = null;
try {
  console.log("Dashboard: Checking for unorganized thread...");
  
  // First, check if the unorganized thread exists
  const unorganizedThreadData = await db.select({
    id: Threads.id,
    title: Threads.title,
    subtitle: Threads.subtitle,
    color: Threads.color,
    spaceId: Threads.spaceId,
    isPublic: Threads.isPublic,
    isPinned: Threads.isPinned,
    createdAt: Threads.createdAt,
    updatedAt: Threads.updatedAt,
  })
  .from(Threads)
  .where(and(
    eq(Threads.userId, userId),
    eq(Threads.id, "thread_unorganized")
  ))
  .get();

  console.log("Dashboard: Unorganized thread data:", unorganizedThreadData);
  
  if (unorganizedThreadData) {
    // Thread exists, check if it has notes
    const noteCount = await db.select({ count: count() })
      .from(Notes)
      .where(eq(Notes.threadId, "thread_unorganized"))
      .get();
    
    console.log("Dashboard: Note count for unorganized thread:", noteCount);
    
    if (noteCount && noteCount.count > 0) {
      unorganizedThread = {
        id: 'thread_unorganized',
        title: 'Unorganized',
        color: null,
        noteCount: noteCount.count,
        backgroundGradient: 'linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)'
      };
      console.log("Dashboard: Created unorganized thread object:", unorganizedThread);
    }
  } else {
    console.log("Dashboard: Unorganized thread does not exist, creating it...");
    
    // Thread doesn't exist, create it
    try {
      const newUnorganizedThread = await db.insert(Threads).values({
        id: "thread_unorganized",
        title: "Unorganized",
        subtitle: "Notes that haven't been organized into threads yet",
        spaceId: null,
        userId: userId,
        isPublic: true,
        isPinned: false,
        color: null,
        createdAt: new Date(),
        updatedAt: new Date(),
      }).returning().get();

      console.log("âœ… Dashboard: Created unorganized thread:", newUnorganizedThread);
      
      // Check if it has notes after creation
      const noteCount = await db.select({ count: count() })
        .from(Notes)
        .where(eq(Notes.threadId, "thread_unorganized"))
        .get();
      
      console.log("Dashboard: Note count after creation:", noteCount);
      
      if (noteCount && noteCount.count > 0) {
        unorganizedThread = {
          id: 'thread_unorganized',
          title: 'Unorganized',
          color: null,
          noteCount: noteCount.count,
          backgroundGradient: 'linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)'
        };
        console.log("Dashboard: Created unorganized thread object after creation:", unorganizedThread);
      }
    } catch (createError: any) {
      // If creation failed due to constraint, it means another process created it
      if (createError.code === 'SQLITE_CONSTRAINT_PRIMARYKEY' || createError.rawCode === 1555) {
        console.log("Dashboard: Unorganized thread already exists, fetching it...");
        // Try to fetch it again
        const existingThread = await db.select({
          id: Threads.id,
          title: Threads.title,
          subtitle: Threads.subtitle,
          color: Threads.color,
          spaceId: Threads.spaceId,
          isPublic: Threads.isPublic,
          isPinned: Threads.isPinned,
          createdAt: Threads.createdAt,
          updatedAt: Threads.updatedAt,
        })
        .from(Threads)
        .where(and(
          eq(Threads.userId, userId),
          eq(Threads.id, "thread_unorganized")
        ))
        .get();
        
        console.log("Dashboard: Fetched existing thread:", existingThread);
        
        if (existingThread) {
          const noteCount = await db.select({ count: count() })
            .from(Notes)
            .where(eq(Notes.threadId, "thread_unorganized"))
            .get();
          
          console.log("Dashboard: Note count for existing thread:", noteCount);
          
          if (noteCount && noteCount.count > 0) {
            unorganizedThread = {
              id: 'thread_unorganized',
              title: 'Unorganized',
              color: null,
              noteCount: noteCount.count,
              backgroundGradient: 'linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)'
            };
            console.log("Dashboard: Created unorganized thread object for existing thread:", unorganizedThread);
          }
        }
      } else {
        throw createError;
      }
    }
  }
} catch (error) {
  console.error("Dashboard: Error checking unorganized thread:", error);
}
---

<Layout title="Harvous" contentType="dashboard" currentThread={null}>
  <!-- Navigation Column -->
  <div slot="navigation" class="h-full">
          <div class="flex flex-col items-start justify-between relative h-full">
            <!-- Top Section - Search and Navigation -->
            <div class="flex flex-col gap-12 items-start justify-start w-full flex-1 min-h-0">
              <!-- Search Input -->
              <SearchInput placeholder="Search" className="h-[60px]" />
              
              <!-- Navigation Buttons -->
              <div class="flex flex-col items-start justify-start w-full">
                <a href="/dashboard" class="w-full">
                  <SpaceButton 
                    text="For You" 
                    count={inboxItemCount} 
                    state="WithCount" 
                    className="w-full" 
                    backgroundGradient="linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)"
                    isActive={true} 
                  />
                </a>
                
                {/* Persistent Navigation - shows recently accessed items */}
                <PersistentNavigation />
                
                {/* Show created spaces */}
                {spaces.map(space => (
                  <div data-navigation-item={space.id} class="w-full">
                    <a href={`/${space.id}`} class="w-full">
                      <SpaceButton 
                        text={space.title} 
                        count={space.totalItemCount} 
                        state="Close" 
                        className="w-full" 
                        backgroundGradient={space.backgroundGradient}
                        isActive={false}
                        itemId={space.id}
                      />
                    </a>
                  </div>
                ))}
                
                {/* Show unorganized thread if it has notes and is not the active thread */}
                {unorganizedThread && (!activeThread || activeThread.id !== 'thread_unorganized') ? (
                  <div data-navigation-item={unorganizedThread.id} class="w-full">
                    <a href={`/${unorganizedThread.id}`} class="w-full">
                      <SpaceButton 
                        text={unorganizedThread.title} 
                        count={unorganizedThread.noteCount} 
                        state="Close" 
                        className="w-full" 
                        backgroundGradient={unorganizedThread.backgroundGradient}
                        isActive={false}
                        itemId={unorganizedThread.id}
                      />
                    </a>
                  </div>
                ) : null}

                {/* Show active thread if any (excluding unorganized thread) */}
                {activeThread && activeThread.id !== 'thread_unorganized' ? (
                  <div data-navigation-item={activeThread.id} class="w-full">
                    <a href={`/${activeThread.id}`} class="w-full">
                      <SpaceButton 
                        text={activeThread.title} 
                        count={activeThread.noteCount} 
                        state="Close" 
                        className="w-full" 
                        backgroundGradient={activeThread.backgroundGradient}
                        isActive={false}
                        itemId={activeThread.id}
                      />
                    </a>
                  </div>
                ) : null}
                

              </div>
            </div>
            
            <!-- Bottom Section with New Space Button and Avatar -->
            <div class="flex gap-3 items-center justify-start w-full shrink-0">
              <SpaceButton text="New Space" className="flex-1" />
              <Avatar initials="DJ" />
            </div>
          </div>
  </div>

  <!-- Main Column -->
  <div slot="main" class="h-full" id="dashboard-content">
          <div class="flex flex-col h-full">
            
            <!-- Content List -->
            <div class="flex-1">
              <CardStack title="For You" subtitle="" headerBgColor="var(--color-paper)">
                <div slot="header-actions" class="flex gap-2">
                  <button 
                    hx-get="/dashboard" 
                    hx-target="#dashboard-content" 
                    hx-swap="outerHTML"
                    class="p-2 rounded-lg hover:bg-gray-100 transition-colors"
                    title="Refresh"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                  </button>
                </div>
                <div class="flex flex-col gap-6">
                  <!-- First TabNav Group -->
                  <div class="flex flex-col gap-3">
                    <!-- First TabNav - Inbox/Archive -->
                    <TabNav 
                      tabs={[
                        { id: "inbox", label: "Inbox", isActive: true },
                        { id: "archive", label: "Archive", isActive: false }
                      ]}
                      class="inbox-archive-tabs"
                    />
                    
                    <!-- Inbox Content (only unassigned items) -->
                    <div class="inbox-content" data-tab-content="inbox">
                      {inboxContent.length > 0 ? (
                        <div class="flex gap-3 overflow-auto">
                          {inboxContent.map(item => (
                            <a 
                              href={item.type === 'thread' ? `/${item.threadId}` : `/${item.id}`}
                              class="block transition-transform duration-200 hover:scale-[1.002]"
                            >
                              <CardFeat 
                                variant={item.variant}
                                title={item.title}
                                content={item.content}
                                imageUrl={(item as any).imageUrl}
                                lastUpdated={item.lastUpdated}
                                isPrivate={(item as any).isPrivate}
                              />
                            </a>
                          ))}
                        </div>
                      ) : (
                        <div class="text-center py-8 text-gray-500">
                          <p>No items in inbox</p>
                        </div>
                      )}
                    </div>
                    
                    <!-- Archive Content (dismissed items) -->
                    <div class="archive-content hidden" data-tab-content="archive">
                      <div class="text-center py-8 text-gray-500">
                        <p>No archived items</p>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Second TabNav Group -->
                  <div class="flex flex-col gap-3">
                    <!-- Second TabNav - All/Threads/Notes -->
                    <TabNav 
                      tabs={[
                        { id: "all", label: "All", isActive: true },
                        { id: "threads", label: "Threads", isActive: false },
                        { id: "notes", label: "Notes", isActive: false }
                      ]}
                      class="content-tabs"
                    />
                    
                    <!-- All Content -->
                    <div class="organized-content flex flex-col" data-tab-content="all">
                      {organizedContent.length > 0 ? (
                        organizedContent.map(item => (
                          <div class={`content-item ${item.type}-item mb-3`}>
                            <a 
                              href={item.type === 'thread' ? `/${item.threadId}` : `/${item.noteId}`}
                              class="block transition-transform duration-200 hover:scale-[1.002]"
                            >
                              {item.type === 'note' ? (
                                <CardNote 
                                  title={item.title}
                                  content={item.content}
                                />
                              ) : (
                                <CardThread 
                                  title={item.title}
                                  subtitle={item.subtitle}
                                  count={item.count}
                                  accentColor={item.accentColor}
                                  lastUpdated={item.lastUpdated}
                                  isPrivate={(item as any).isPrivate}
                                />
                              )}
                            </a>
                          </div>
                        ))
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[300px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[24px] leading-[1.2]">
                              <p>So when's move-in day?</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[16px] leading-[1.3] max-w-[250px]">
                              <p>Add to your Harvous and this area will start to feel lived in.</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Threads Only Content -->
                    <div class="organized-content flex flex-col hidden" data-tab-content="threads">
                      {organizedContent.filter(item => item.type === 'thread').length > 0 ? (
                        organizedContent.filter(item => item.type === 'thread').map(item => (
                          <div class={`content-item ${item.type}-item mb-3`}>
                            <a 
                              href={`/${item.threadId}`}
                              class="block transition-transform duration-200 hover:scale-[1.002]"
                            >
                              <CardThread 
                                title={item.title}
                                subtitle={item.subtitle}
                                count={item.count}
                                accentColor={item.accentColor}
                                lastUpdated={item.lastUpdated}
                                isPrivate={(item as any).isPrivate}
                              />
                            </a>
                          </div>
                        ))
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[300px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[24px] leading-[1.2]">
                              <p>So when's move-in day?</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[16px] leading-[1.3] max-w-[250px]">
                              <p>Add to your Harvous and this area will start to feel lived in.</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Notes Only Content -->
                    <div class="organized-content flex flex-col hidden" data-tab-content="notes">
                      {organizedContent.filter(item => item.type === 'note').length > 0 ? (
                        organizedContent.filter(item => item.type === 'note').map(item => (
                          <div class={`content-item ${item.type}-item mb-3`}>
                            <a 
                              href={`/${item.noteId}`}
                              class="block transition-transform duration-200 hover:scale-[1.002]"
                            >
                              <CardNote 
                                title={item.title}
                                content={item.content}
                              />
                            </a>
                          </div>
                        ))
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[300px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[24px] leading-[1.2]">
                              <p>So when's move-in day?</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[16px] leading-[1.3] max-w-[250px]">
                              <p>Add to your Harvous and this area will start to feel lived in.</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                </div>
              </div>
              </CardStack>
            </div>
          </div>
  </div>

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">
    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxItemCount}
      currentSpace={null}
      currentThread={activeThread}
    />
  </div>

  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional contentType="dashboard" />
  </div>



</Layout>

