---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import SearchInput from "@/components/SearchInput.astro";
import SpaceButton from "@/components/SpaceButton.astro";
import Avatar from "@/components/Avatar.astro";
import SquareButton from "@/components/SquareButton.astro";
import TabNav from "@/components/TabNav.astro";
import CardFeat from "@/components/CardFeat.astro";
import CardNote from "@/components/CardNote.astro";
import CardThread from "@/components/CardThread.astro";
import { getFeaturedContent, getContentItems, getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
import { getInboxContent, getOrganizedContent, getNavigationData, shouldUseSampleData, getDataMode, toggleDataMode } from "@/utils/sample-data";
import NewNotePanel from "@/components/NewNotePanel.astro";
// For local development, use placeholder user ID
// In production, this will be handled by Clerk authentication
const userId = "user_2abc123"; // Placeholder for local development

// Fetch real data from database
// Use robust sample data system for consistent development experience
let featuredContent: any[] = [];
let contentItems: any[] = [];
let threads: any[] = [];
let spaces: any[] = [];
let inboxCount: number = 0;

if (shouldUseSampleData()) {
  // Use clean, consistent sample data
  featuredContent = getInboxContent();
  contentItems = getOrganizedContent();
  const navData = getNavigationData();
  threads = navData.threads;
  spaces = navData.spaces;
  inboxCount = navData.inboxCount;
} else {
  // Production: fetch from database
  try {
    [featuredContent, contentItems, threads, spaces, inboxCount] = await Promise.all([
      getFeaturedContent(userId),
      getContentItems(userId),
      getAllThreadsWithCounts(userId),
      getSpacesWithCounts(userId),
      getInboxCount(userId)
    ]);
  } catch (error) {
    console.error("Error fetching dashboard data:", error);
    // Fallback to sample data if database fails
    featuredContent = getInboxContent();
    contentItems = getOrganizedContent();
    const navData = getNavigationData();
    threads = navData.threads;
    spaces = navData.spaces;
    inboxCount = navData.inboxCount;
  }
}

// Sample data is already properly organized - no complex filtering needed
const inboxContent = featuredContent;
const organizedContent = contentItems;
const inboxItemCount = inboxCount;
---

<Layout title="Dashboard">
  <!-- Alpine.js CDN for SquareButton menu functionality -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  
  <div class="h-screen bg-[var(--color-light-paper)] p-6">
    <div class="grid grid-cols-[300px_640px_minmax(auto,640px)] gap-6 h-full">
      <!-- Navigation Column -->
      <section class="h-full">
        <slot name="navigation">
          <div class="content-stretch flex flex-col items-start justify-between relative size-full">
            <div class="content-stretch flex flex-col gap-12 items-start justify-start relative shrink-0 w-full">
              <!-- Search Input -->
              <SearchInput placeholder="Search" className="h-[60px]" />
              
              <!-- Navigation Buttons -->
              <div class="content-stretch flex flex-col items-start justify-start relative shrink-0 w-full">
                <a href="/dashboard" class="w-full">
                  <SpaceButton 
                    text="For You" 
                    count={inboxItemCount} 
                    state="WithCount" 
                    className="w-full" 
                    backgroundGradient="linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)"
                    isActive={true} 
                  />
                </a>
                
                {/* Show created spaces */}
                {spaces.map(space => (
                  <a href={`/${space.id}`} class="w-full">
                    <SpaceButton 
                      text={space.title} 
                      count={space.totalItemCount} 
                      state="WithCount" 
                      className="w-full" 
                      backgroundGradient="linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)"
                      isActive={false}
                    />
                  </a>
                ))}
                
                                {/* Show pinned threads */}
                {threads.filter(thread => thread.isPinned).map(thread => (
                  <a href={`/${thread.id}`} class="w-full">
                    <SpaceButton 
                      text={thread.title} 
                      count={thread.noteCount} 
                      state="WithCount" 
                      className="w-full" 
                      backgroundGradient={thread.backgroundGradient}
                      isActive={false}
                    />
                  </a>
                ))}
                

              </div>
            </div>
            
            <!-- Bottom Section with New Space Button and Avatar -->
            <div class="content-stretch flex gap-3 items-center justify-start relative shrink-0 w-full">
              <SpaceButton text="New Space" className="flex-1" />
              <Avatar initials="DJ" />
            </div>
          </div>
        </slot>
      </section>

      <!-- Main Column -->
      <section class="h-full">
        <slot name="main">
          <div class="flex flex-col h-full">
            
            <!-- Content List -->
            <div class="flex-1">
              <CardStack title="For You" subtitle="" headerBgColor="var(--color-paper)">
                <div class="flex flex-col gap-6">
                  <!-- First TabNav - Inbox/Archive -->
                  <TabNav 
                    tabs={[
                      { id: "inbox", label: "Inbox", isActive: true },
                      { id: "archive", label: "Archive", isActive: false }
                    ]}
                    class="inbox-archive-tabs"
                  />
                  
                  <!-- Inbox Content (only unassigned items) -->
                  <div class="inbox-content" id="inbox-content">
                    {inboxContent.length > 0 ? (
                      <div class="flex gap-3 overflow-auto">
                        {inboxContent.map(item => (
                          <a 
                            href={item.type === 'thread' ? `/${item.threadId}` : `/${item.noteId}`}
                            class="block transition-transform duration-200 hover:scale-[1.002]"
                          >
                            <CardFeat 
                              variant={item.variant}
                              title={item.title}
                              content={item.content}
                              imageUrl={(item as any).imageUrl}
                              lastUpdated={item.lastUpdated}
                              isPrivate={(item as any).isPrivate}
                            />
                          </a>
                        ))}
                      </div>
                    ) : (
                      <div class="text-center py-8 text-gray-500">
                        <p>No items in inbox</p>
                      </div>
                    )}
                  </div>
                  
                  <!-- Archive Content (dismissed items) -->
                  <div class="archive-content hidden" id="archive-content">
                    <div class="text-center py-8 text-gray-500">
                      <p>No archived items</p>
                    </div>
                  </div>
                  
                  <!-- Second TabNav - All/Threads/Notes -->
                  <TabNav 
                    tabs={[
                      { id: "all", label: "All", isActive: true },
                      { id: "threads", label: "Threads", isActive: false },
                      { id: "notes", label: "Notes", isActive: false }
                    ]}
                    class="content-tabs"
                  />
                  
                  <!-- Organized Content List (items that have been added to Harvous) -->
                  <div class="organized-content flex flex-col gap-3">
                    {organizedContent.map(item => (
                      <div class={`content-item ${item.type}-item`}>
                        <a 
                          href={item.type === 'thread' ? `/${item.id}` : `/${item.noteId}`}
                          class="block transition-transform duration-200 hover:scale-[1.002]"
                        >
                          {item.type === 'note' ? (
                            <CardNote 
                              title={item.title}
                              content={item.content}
                            />
                          ) : (
                            <CardThread 
                              title={item.title}
                              subtitle={item.subtitle}
                              count={item.count}
                              accentColor={item.accentColor}
                              lastUpdated={item.lastUpdated}
                              isPrivate={(item as any).isPrivate}
                            />
                          )}
                        </a>
                      </div>
                    ))}
                  </div>
                </div>
              </CardStack>
            </div>
          </div>
        </slot>
      </section>

      <!-- Additional Column -->
      <section class="h-full">
        <slot name="additional">
                    <div 
            class="flex flex-col items-left justify-between h-full"
            x-data="{ showNewNotePanel: false }"
            x-init="
              // Initialize from localStorage
              showNewNotePanel = localStorage.getItem('showNewNotePanel') === 'true';
              
              // Listen for NewNotePanel events
              window.addEventListener('openNewNotePanel', () => {
                showNewNotePanel = true;
                localStorage.setItem('showNewNotePanel', 'true');
              });
              window.addEventListener('closeNewNotePanel', () => {
                showNewNotePanel = false;
                localStorage.setItem('showNewNotePanel', 'false');
              });
            "
          >
            <!-- Default state: SquareButtons -->
            <div x-show="!showNewNotePanel" class="flex flex-col items-left justify-between h-full">
              <SquareButton variant="More" />
              <SquareButton variant="Add" withMenu={true} />
            </div>
            
            <!-- New Note Panel -->
            <div x-show="showNewNotePanel" class="h-full">
              <NewNotePanel />
            </div>
          </div>
        </slot>
      </section>
    </div>
  </div>

  <script>
    // Handle content filtering tabs
    document.addEventListener('DOMContentLoaded', () => {
      // Handle inbox/archive tabs
      const inboxArchiveTabs = document.querySelector('.inbox-archive-tabs');
      if (inboxArchiveTabs) {
        const tabButtons = inboxArchiveTabs.querySelectorAll('[data-tab-id]');
        const inboxContent = document.getElementById('inbox-content');
        const archiveContent = document.getElementById('archive-content');
        
        tabButtons.forEach(button => {
          button.addEventListener('click', (e) => {
            const tabId = (e.currentTarget as HTMLElement).getAttribute('data-tab-id');
            if (!tabId) return;
            
            // Update active tab styling
            tabButtons.forEach(btn => {
              btn.setAttribute('data-active', 'false');
              btn.classList.remove('opacity-100');
              btn.classList.add('opacity-50');
              // Hide the dot element
              const dot = btn.querySelector('[data-dot]') as HTMLElement;
              if (dot) dot.style.display = 'none';
            });
            
            (e.currentTarget as HTMLElement).setAttribute('data-active', 'true');
            (e.currentTarget as HTMLElement).classList.remove('opacity-50');
            (e.currentTarget as HTMLElement).classList.add('opacity-100');
            // Show the dot element for the active tab
            const activeDot = (e.currentTarget as HTMLElement).querySelector('[data-dot]') as HTMLElement;
            if (activeDot) activeDot.style.display = 'block';
            
            // Show/hide content based on selected tab
            if (tabId === 'inbox') {
              if (inboxContent) inboxContent.classList.remove('hidden');
              if (archiveContent) archiveContent.classList.add('hidden');
            } else if (tabId === 'archive') {
              if (inboxContent) inboxContent.classList.add('hidden');
              if (archiveContent) archiveContent.classList.remove('hidden');
            }
          });
        });
      }
      
      // Handle content filtering tabs
      const contentTabs = document.querySelector('.content-tabs');
      if (!contentTabs) return;
      
      const contentTabButtons = contentTabs.querySelectorAll('[data-tab-id]');
      const contentItems = document.querySelectorAll('.content-item');
      
      contentTabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const tabId = (e.currentTarget as HTMLElement).getAttribute('data-tab-id');
          if (!tabId) return;
          
          // Update active tab styling
          contentTabButtons.forEach(btn => {
            btn.setAttribute('data-active', 'false');
            btn.classList.remove('opacity-100');
            btn.classList.add('opacity-50');
            // Hide the dot element
            const dot = btn.querySelector('[data-dot]') as HTMLElement;
            if (dot) dot.style.display = 'none';
          });
          
          (e.currentTarget as HTMLElement).setAttribute('data-active', 'true');
          (e.currentTarget as HTMLElement).classList.remove('opacity-50');
          (e.currentTarget as HTMLElement).classList.add('opacity-100');
          // Show the dot element for the active tab
          const activeDot = (e.currentTarget as HTMLElement).querySelector('[data-dot]') as HTMLElement;
          if (activeDot) activeDot.style.display = 'block';
          
          // Show/hide content based on selected tab
          contentItems.forEach(item => {
            const element = item as HTMLElement;
            if (tabId === 'all') {
              element.style.display = 'block';
            } else if (tabId === 'notes' && item.classList.contains('note-item')) {
              element.style.display = 'block';
            } else if (tabId === 'threads' && item.classList.contains('thread-item')) {
              element.style.display = 'block';
            } else {
              element.style.display = 'none';
            }
          });
        });
      });
    });
  </script>
</Layout>
