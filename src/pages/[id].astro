---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import CardFull from "@/components/CardFull.astro";
import SearchInput from "@/components/SearchInput.astro";
import SpaceButton from "@/components/SpaceButton.astro";
import Avatar from "@/components/Avatar.astro";
import TabNav from "@/components/TabNav.astro";
import CardNote from "@/components/CardNote.astro";
import CardThread from "@/components/CardThread.astro";
// import { db, Threads, Notes, Spaces, eq, and, desc } from "astro:db"; // Conditionally imported below
// import { getAllThreadsWithCounts, getSpacesWithCounts, getNotesForThread, getThreadsForSpace, getNotesForSpace, getInboxCount } from "@/utils/dashboard-data"; // Conditionally imported below
import { getThreadColorCSS } from "@/utils/colors";
import { SAMPLE_DATA, getNavigationData, shouldUseSampleData } from "@/utils/sample-data";
import { detectActiveThreadFromPath } from "@/utils/navigation-state";
import MobileNavigation from "@/components/MobileNavigation.astro";
import MobileAdditional from "@/components/MobileAdditional.astro";

// Get static paths for static mode
export async function getStaticPaths() {
  const { SAMPLE_DATA } = await import("@/utils/sample-data");
  
  const paths = [
    // Add paths for all sample spaces
    ...SAMPLE_DATA.spaces.map(space => ({
      params: { id: space.id },
      props: { id: space.id }
    })),
    // Add paths for all sample threads
    ...SAMPLE_DATA.unorganizedThreads.map(thread => ({
      params: { id: thread.id },
      props: { id: thread.id }
    })),
    ...SAMPLE_DATA.organizedThreads.map(thread => ({
      params: { id: thread.id },
      props: { id: thread.id }
    })),
    // Add paths for all sample notes
    ...SAMPLE_DATA.unorganizedNotes.map(note => ({
      params: { id: note.id },
      props: { id: note.id }
    })),
    ...SAMPLE_DATA.threadNotes.map(note => ({
      params: { id: note.id },
      props: { id: note.id }
    }))
  ];
  
  console.log("Generated static paths:", paths.length);
  return paths;
}

// Get user ID - use development fallback since middleware is disabled
let userId: string = "dev_user_123"; // Development fallback
console.log("Dynamic page: Using development user ID:", userId);

const { id } = Astro.params;
console.log("Dynamic page: ID =", id);

// Determine if this is a thread, note, or space based on the ID prefix
const isThread = id?.startsWith('thread_');
const isNote = id?.startsWith('note_');
const isSpace = id?.startsWith('space_');
console.log("Dynamic page: isThread =", isThread, "isNote =", isNote, "isSpace =", isSpace);

let content: any = null;
let threads: any[] = [];
let spaces: any[] = [];
let pageTitle = "";
let pageContent = "";
let currentThread: any = null;
let currentSpace: any = null;
let threadNotes: any[] = [];
let inboxCount: number = 0;

// Declare database functions that will be conditionally imported
let getAllThreadsWithCounts: any;
let getSpacesWithCounts: any;
let getNotesForThread: any;
let getThreadsForSpace: any;
let getNotesForSpace: any;
let getInboxCount: any;

  if (shouldUseSampleData()) {
    // Use robust sample data system
    if (isThread) {
      // Find thread in sample data
      const thread = [...SAMPLE_DATA.unorganizedThreads, ...SAMPLE_DATA.organizedThreads]
        .find(t => t.id === id);
      
      if (thread) {
        // Get notes for this thread from sample data
        threadNotes = SAMPLE_DATA.threadNotes.filter(note => note.threadId === thread.id);

        content = {
          id: thread.id,
          title: thread.title,
          subtitle: thread.content,
          color: thread.color,
          spaceId: thread.spaceId,
          notes: threadNotes,
          noteCount: threadNotes.length
        };
        currentThread = {
          id: thread.id,
          title: thread.title,
          color: thread.color,
          noteCount: threadNotes.length,
          backgroundGradient: `linear-gradient(180deg, var(--color-${thread.color}) 0%, var(--color-${thread.color}) 100%)`
        };

        // Note: Active thread is now detected from URL path instead of global state

        pageTitle = thread.title;
        pageContent = `${threadNotes.length} notes`;
      }
    } else if (isNote) {
      // Find note in sample data (check both unorganized and thread notes)
      const note = [...SAMPLE_DATA.unorganizedNotes, ...SAMPLE_DATA.threadNotes].find(n => n.id === id);
      

      
      if (note) {
        content = {
          id: note.id,
          title: note.title,
          content: note.content,
          threadId: note.threadId,
          createdAt: note.createdAt,
          noteId: note.noteId,
          updatedAt: new Date()
        };
        pageTitle = note.title;
        pageContent = note.content.substring(0, 100) + (note.content.length > 100 ? "..." : "");
        
        // Get the thread this note belongs to
        if (note.threadId && note.threadId !== 'thread_unorganized') {
          // Find the actual thread data
          const parentThread = [...SAMPLE_DATA.unorganizedThreads, ...SAMPLE_DATA.organizedThreads]
            .find(t => t.id === note.threadId);
          
          if (parentThread) {
            currentThread = {
              id: parentThread.id,
              title: parentThread.title,
              color: parentThread.color,
              noteCount: SAMPLE_DATA.threadNotes.filter(n => n.threadId === parentThread.id).length,
              backgroundGradient: `linear-gradient(180deg, var(--color-${parentThread.color}) 0%, var(--color-${parentThread.color}) 100%)`
            };
            
            // Note: Active thread is now detected from URL path instead of global state
          }
        } else {
          currentThread = {
            id: note.threadId,
            title: "Unorganized",
            noteCount: SAMPLE_DATA.unorganizedNotes.length
          };
        }
      }
    } else if (isSpace) {
      // Find space in sample data
      const space = SAMPLE_DATA.spaces.find(s => s.id === id);
      

      
      if (space) {
        // Get threads for this space
        const spaceThreads = SAMPLE_DATA.organizedThreads.filter(t => t.spaceId === space.id);
        
        content = {
          id: space.id,
          title: space.title,
          color: space.color,
          threads: spaceThreads,
          notes: [],
          threadCount: spaceThreads.length,
          noteCount: 0
        };
        currentSpace = {
          id: space.id,
          title: space.title,
          color: space.color
        };
        
        // Note: Active thread is now detected from URL path instead of global state
        
        pageTitle = space.title;
        pageContent = `${spaceThreads.length} threads`;
      }
    }


  // Get navigation data (spaces and inbox count only)
  const navData = getNavigationData();
  spaces = navData.spaces;
  inboxCount = navData.inboxCount;
  
  // Get all threads for navigation (including organized and unorganized)
  threads = [
    ...SAMPLE_DATA.unorganizedThreads,
    ...SAMPLE_DATA.organizedThreads
  ].map(thread => ({
    ...thread,
    noteCount: SAMPLE_DATA.threadNotes.filter(note => note.threadId === thread.id).length
  }));
} else {
  // Production: fetch from database - TEMPORARILY DISABLED FOR STATIC MODE
  console.log("Production database mode disabled for static build");
  
  // For now, fall back to sample data
  const navData = getNavigationData();
  spaces = navData.spaces;
  inboxCount = navData.inboxCount;
  
  // Get all threads for navigation (including organized and unorganized)
  threads = [
    ...SAMPLE_DATA.unorganizedThreads,
    ...SAMPLE_DATA.organizedThreads
  ].map(thread => ({
    ...thread,
    noteCount: SAMPLE_DATA.threadNotes.filter(note => note.threadId === thread.id).length
  }));
}



// If content not found, redirect to dashboard
if (!content) {
  // return Astro.redirect('/dashboard'); // Temporarily disabled for static mode
  console.log("Content not found, would redirect to dashboard");
}
---

<Layout title={pageTitle}>
  <!-- Navigation Column -->
  <div slot="navigation" class="h-full">
          <div class="content-stretch flex flex-col items-start justify-between relative h-full">
            <div class="content-stretch flex flex-col gap-12 items-start justify-start relative shrink-0 w-full">
              <!-- Search Input -->
              <SearchInput placeholder="Search" className="h-[60px]" />
              
              <!-- Navigation Buttons -->
              <div class="content-stretch flex flex-col items-start justify-start relative shrink-0 w-full">
                <a href="/dashboard" class="w-full">
                  <SpaceButton text="For You" count={inboxCount} state="WithCount" className="w-full" isActive={false} />
                </a>
                
                {/* Show created spaces */}
                {spaces.map(space => (
                  <a href={`/${space.id}`} class="w-full">
                    <SpaceButton 
                      text={space.title} 
                      count={space.totalItemCount} 
                      state="WithCount" 
                      className="w-full" 
                      backgroundGradient="linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)"
                      isActive={currentSpace?.id === space.id}
                    />
                  </a>
                ))}
                
                {/* Show active thread if any (active if on thread page, inactive otherwise) */}
                {(() => {
                  const activeThread = detectActiveThreadFromPath(`/${id}`);
                  return activeThread ? (
                    <a href={`/${activeThread.id}`} class="w-full">
                      <SpaceButton 
                        text={activeThread.title} 
                        count={activeThread.noteCount} 
                        state="WithCount" 
                        className="w-full" 
                        backgroundGradient={activeThread.backgroundGradient}
                        isActive={activeThread.id === id}
                      />
                    </a>
                  ) : null;
                })()}
              </div>
            </div>
            
            <!-- Bottom Section with New Space Button and Avatar -->
            <div class="content-stretch flex gap-3 items-center justify-start relative shrink-0 w-full">
              <SpaceButton text="New Space" className="flex-1" />
              <Avatar initials="DJ" />
            </div>
          </div>
  </div>

  <!-- Main Column -->
  <div slot="main" class="h-full">
          {isNote ? (
            <CardFull 
              title={content.title || "Untitled Note"}
              content={content.content}
              date={content.createdAt ? content.createdAt.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : "Feb 7, 2025"}
              noteId={content.noteId ? `N${content.noteId.toString().padStart(3, '0')}` : undefined}
              className="h-full"
            />
          ) : (
            <CardStack 
              title={pageTitle} 
              subtitle={pageContent} 
              headerBgColor={isThread && currentThread?.color ? `var(--color-${currentThread.color})` : "var(--color-paper)"}
            >
              <div class="flex flex-col gap-6">
                {isThread && threadNotes && threadNotes.length > 0 ? (
                  <div class="flex flex-col gap-3">
                    {threadNotes.map((note: any) => (
                      <div class="content-item note-item">
                        <a 
                          href={`/${note.id}`}
                          class="block transition-transform duration-200 hover:scale-[1.002]"
                        >
                          <CardNote 
                            title={note.title || "Untitled Note"}
                            content={note.content.substring(0, 150) + (note.content.length > 150 ? "..." : "")}
                          />
                        </a>
                      </div>
                    ))}
                  </div>
                ) : isSpace && content.threads && content.threads.length > 0 ? (
                  <div class="flex flex-col gap-3">
                    {/* Show threads in this space */}
                    {content.threads.map((thread: any) => (
                      <div class="content-item thread-item">
                        <a 
                          href={`/${thread.id}`}
                          class="block transition-transform duration-200 hover:scale-[1.002]"
                        >
                          <CardThread 
                            title={thread.title}
                            subtitle={thread.subtitle || `${thread.noteCount} notes`}
                            count={thread.noteCount}
                            accentColor={thread.accentColor}
                            lastUpdated={thread.lastUpdated}
                            isPrivate={!thread.isPublic}
                          />
                        </a>
                      </div>
                    ))}
                    
                    {/* Show standalone notes in this space */}
                    {content.notes && content.notes.length > 0 && content.notes.map((note: any) => (
                      <div class="content-item note-item">
                        <a 
                          href={`/${note.id}`}
                          class="block transition-transform duration-200 hover:scale-[1.002]"
                        >
                          <CardNote 
                            title={note.title || "Untitled Note"}
                            content={note.content.substring(0, 150) + (note.content.length > 150 ? "..." : "")}
                          />
                        </a>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div class="text-center py-12">
                    <p class="text-[var(--color-pebble-grey)] text-lg">No content found.</p>
                  </div>
                )}
              </div>
            </CardStack>
          )}
  </div>

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">

    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxCount}
      currentSpace={currentSpace}
      currentThread={currentThread}
    />
  </div>

  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional />
  </div>
</Layout>
