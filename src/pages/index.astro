---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import SearchInput from "@/components/SearchInput.astro";
import SquareButton from "@/components/SquareButton.astro";
import Avatar from "@/components/Avatar.astro";
import TabNav from "@/components/TabNav.astro";
import CardFeat from "@/components/CardFeat.astro";
import CardNote from "@/components/CardNote.astro";
import CardThread from "@/components/CardThread.astro";
import NavigationColumnReact from "@/components/NavigationColumnReact.astro";
import MobileNavigation from "@/components/MobileNavigation.astro";
import { getFeaturedContent, getContentItems, getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
import { getArchivedItems } from "@/utils/inbox-data";
import InboxItemsList from "@/components/react/InboxItemsList";
import OrganizedContentList from "@/components/react/OrganizedContentList";
// Sample data imports removed - using real database data only
import { detectActiveThreadFromPath } from "@/utils/navigation-state";
import { getThreadGradientCSS } from "@/utils/colors";
import { ensureUnorganizedThread } from "@/utils/unorganized-thread";
import MobileAdditional from "@/components/MobileAdditional.astro";
import { getRelativeTime } from "@/utils/date-formatting";
import { db, InboxItemNotes, eq, count } from "astro:db";
// Get user data from Clerk authentication
const auth = Astro.locals.auth();
const { userId } = auth;

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Get cached user data (optimized - no API calls on every page load)
import { getCachedUserData, type CachedUserData } from '@/utils/user-cache';

let userData: CachedUserData;
try {
  userData = await getCachedUserData(userId);
} catch (error) {
  console.log('Error getting cached user data:', error);
  // Fallback data
  userData = {
    firstName: '',
    lastName: '',
    email: '',
    initials: 'U',
    displayName: 'User',
    userColor: 'paper',
  };
}

const { firstName, lastName, initials, displayName, userColor } = userData;

// Fetch real data from database
// Use robust sample data system for consistent development experience
let featuredContent: any[] = [];
let contentItems: any[] = [];
let threads: any[] = [];
let spaces: any[] = [];
let inboxCount: number = 0;

// Always use real database data
try {
    // Fetch all data in parallel for better performance
    const [featuredContentData, contentItemsData, threadsData, spacesData, inboxCountData] = await Promise.all([
      getFeaturedContent(userId),
      getContentItems(userId),
      getAllThreadsWithCounts(userId),
      getSpacesWithCounts(userId),
      getInboxCount(userId)
    ]);
    
    featuredContent = featuredContentData;
    contentItems = contentItemsData;
    threads = threadsData;
    spaces = spacesData;
    inboxCount = inboxCountData;
    
    // Ensure threads have backgroundGradient property for consistency
    threads = threads.map(thread => ({
      ...thread,
      backgroundGradient: thread.backgroundGradient || getThreadGradientCSS(thread.color || 'blue')
    }));
    
    // Ensure spaces have backgroundGradient property for consistency
    spaces = spaces.map(space => ({
      ...space,
      backgroundGradient: space.backgroundGradient || getThreadGradientCSS(space.color || 'blue')
    }));
} catch (error) {
  console.error("Error fetching dashboard data:", error);
  console.error("Error details:", error instanceof Error ? error.message : String(error));
  console.error("Error stack:", error instanceof Error ? error.stack : 'No stack trace available');
  
  // In production, we want to see the actual error instead of silent fallback
  if (import.meta.env.PROD) {
    console.error("PRODUCTION ERROR: Dashboard data fetch failed");
    console.error("This indicates a serious issue with database connectivity or data integrity");
    // Still provide fallback data but log the error prominently
  }
  
  // Fallback to empty data if database fails
  featuredContent = [];
  contentItems = [];
  threads = [];
  spaces = [];
  inboxCount = 0;
  
}

// Combine all content for the main content section
// Inbox shows inbox items from Harvous team (both threads and notes)
const inboxContent = featuredContent; // Now includes both threads and notes from inbox
// Organized content should only include contentItems, not featuredContent notes
// to avoid duplication of unorganized notes
const organizedContent = contentItems;
// Use the actual count of items displayed in inbox, not the total inbox count
const inboxItemCount = inboxContent.length;

// Get archived items, active thread, and unorganized thread in parallel
let archivedItems: any[] = [];
let activeThread = null;
let unorganizedThread = null;

try {
  const [archived, threadContext, threadData] = await Promise.all([
    getArchivedItems(userId).catch(() => []),
    detectActiveThreadFromPath(Astro.url.pathname, userId).catch(() => null),
    ensureUnorganizedThread(userId).catch(() => null)
  ]);
  
  // Process archived items
  archivedItems = await Promise.all(archived.map(async (item) => {
    const cleanContent = item.content ? item.content.replace(/<[^>]*>/g, '').substring(0, 150) + (item.content.length > 150 ? "..." : "") : '';
    
    // Get note count for threads
    let noteCount = 0;
    if (item.contentType === 'thread') {
      const countResult = await db
        .select({ count: count() })
        .from(InboxItemNotes)
        .where(eq(InboxItemNotes.inboxItemId, item.id))
        .get();
      noteCount = countResult?.count || 0;
    }
    
    // Format timestamp showing when item was made available to user
    // Use createdAt from UserInboxItems (when item appeared in user's inbox)
    let displayTimestamp: string | undefined = undefined;
    if (item.createdAt) {
      try {
        displayTimestamp = getRelativeTime(new Date(item.createdAt));
      } catch (error) {
        console.error('Error formatting archived item timestamp:', error, 'item.createdAt:', item.createdAt);
        displayTimestamp = undefined;
      }
    }
    
    return {
      id: item.id,
      type: item.contentType === 'thread' ? 'thread' : 'note',
      title: item.title,
      content: cleanContent,
      imageUrl: item.imageUrl,
      variant: item.contentType === 'thread' ? 'Thread' : (item.imageUrl ? 'NoteImage' : 'Note'),
      threadId: item.contentType === 'thread' ? item.id : undefined,
      noteId: item.contentType === 'note' ? item.id : undefined,
      color: item.color,
      subtitle: item.subtitle,
      lastUpdated: displayTimestamp, // Relative time when item was made available to user
      count: noteCount, // Note count for threads
      threadType: item.threadType, // Thread type from CMS
    };
  }));
  
  // Set active thread
  activeThread = threadContext;
  
  // Set unorganized thread if it has notes
  if (threadData && threadData.noteCount > 0) {
    unorganizedThread = threadData;
  }
} catch (error) {
  console.error("Error fetching additional dashboard data:", error);
  archivedItems = [];
}
---

<Layout 
  title="Harvous" 
  contentType="dashboard" 
  currentThread={null} 
  currentSpace={null}
  userId={userId}
  userData={{
    email: userData.email,
    name: `${userData.firstName} ${userData.lastName}`.trim(),
    displayName: userData.displayName,
    userColor: userData.userColor,
  }}
>
  <!-- Navigation Column -->
  <NavigationColumnReact 
    slot="navigation"
    inboxCount={inboxItemCount}
    spaces={spaces}
    activeThread={activeThread}
    currentSpace={null}
    isNote={false}
    currentId={undefined}
    showProfile={false}
    initials={initials}
    userColor={userColor}
  />

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">
    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxItemCount}
      currentSpace={null}
      currentThread={activeThread}
      initials={initials}
      userColor={userColor}
    />
  </div>

  <!-- Main Column -->
  <div slot="main" class="h-full" id="dashboard-content" data-navigation-item="dashboard" data-title="For You" data-count={inboxItemCount} data-background-gradient="var(--color-paper)">
          <div class="flex flex-col h-full">
            
            <!-- Content List -->
            <div class="flex-1">
              <CardStack title="For You" subtitle="" headerBgColor="var(--color-paper)">
                <div slot="header-actions" class="flex gap-2">
                  <button 
                    hx-get="/" 
                    hx-target="#dashboard-content" 
                    hx-swap="outerHTML"
                    class="p-2 rounded-lg hover:bg-gray-100 transition-colors"
                    title="Refresh"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                  </button>
                </div>
                <div class="flex flex-col gap-6">
                  <!-- First TabNav Group -->
                  <div class="flex flex-col gap-3">
                    <!-- First TabNav - Inbox/Archive with dynamic text -->
                    <div class="flex items-center justify-between pb-0 pl-[4px] pr-[12px] pt-[4px] relative w-full">
                      <TabNav 
                        tabs={[
                          { id: "inbox", label: "Inbox", isActive: true },
                          { id: "archive", label: "Archive", isActive: false }
                        ]}
                        class="inbox-archive-tabs"
                      />
                      <div class="flex flex-col font-sans font-normal justify-center leading-[0] overflow-ellipsis overflow-hidden relative shrink-0 text-[12px] text-[#78766f] text-nowrap">
                        <p class="leading-[1.3] whitespace-pre inbox-auto-text">14 day auto archive</p>
                        <p class="leading-[1.3] whitespace-pre archive-auto-text hidden">30 day auto delete</p>
                      </div>
                    </div>
                    
                    <!-- Inbox Content (reserved for external content only) -->
                    <div class="inbox-content min-h-[200px]" data-tab-content="inbox">
                      {inboxContent.length > 0 ? (
                        <InboxItemsList 
                          client:visible
                          items={inboxContent}
                        />
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[200px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[18px] leading-[1.2]">
                              <p>Your inbox is empty</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[14px] leading-[1.3]">
                              <p>Where new items appear, from Harvous and others</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Archive Content (dismissed items) -->
                    <div class="archive-content hidden min-h-[200px]" data-tab-content="archive">
                      {archivedItems.length > 0 ? (
                        <InboxItemsList 
                          client:visible
                          items={archivedItems}
                        />
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[200px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[18px] leading-[1.2]">
                              <p>Your archive is empty</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[14px] leading-[1.3]">
                              <p>Archived items are kept for 30 days</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <!-- Second TabNav Group -->
                  <div class="flex flex-col gap-3">
                    <!-- Second TabNav - All/Threads/Notes -->
                    <TabNav 
                      tabs={[
                        { id: "all", label: "All", isActive: true },
                        { id: "threads", label: "Threads", isActive: false },
                        { id: "notes", label: "Notes", isActive: false }
                      ]}
                      class="content-tabs"
                    />
                    
                    <!-- All Content -->
                    <div class="organized-content flex flex-col" data-tab-content="all">
                      {organizedContent.length > 0 ? (
                        <OrganizedContentList 
                          initialItems={organizedContent}
                          filter="all"
                          client:visible
                        />
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[300px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[24px] leading-[1.2]">
                              <p>So when's move-in day?</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[16px] leading-[1.3] max-w-[250px]">
                              <p>Add to your Harvous and this area will start to feel lived in.</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Threads Only Content -->
                    <div class="organized-content flex flex-col hidden" data-tab-content="threads">
                      {organizedContent.filter(item => item.type === 'thread').length > 0 ? (
                        <OrganizedContentList 
                          initialItems={organizedContent.filter(item => item.type === 'thread')}
                          filter="threads"
                          client:visible
                        />
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[300px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[24px] leading-[1.2]">
                              <p>So when's move-in day?</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[16px] leading-[1.3] max-w-[250px]">
                              <p>Add to your Harvous and this area will start to feel lived in.</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                    
                    <!-- Notes Only Content -->
                    <div class="organized-content flex flex-col hidden" data-tab-content="notes">
                      {organizedContent.filter(item => item.type === 'note').length > 0 ? (
                        <OrganizedContentList 
                          initialItems={organizedContent.filter(item => item.type === 'note')}
                          filter="notes"
                          client:visible
                        />
                      ) : (
                        <div class="flex flex-col items-center justify-center min-h-[300px] w-full text-center">
                          <div class="flex flex-col gap-2 items-center justify-center">
                            <div class="font-sans font-semibold text-[#4a473d] text-[24px] leading-[1.2]">
                              <p>So when's move-in day?</p>
                            </div>
                            <div class="font-sans font-normal text-[#78766f] text-[16px] leading-[1.3] max-w-[250px]">
                              <p>Add to your Harvous and this area will start to feel lived in.</p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                </div>
              </div>
              </CardStack>
            </div>
          </div>
  </div>


  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional contentType="dashboard" currentSpace={null} />
  </div>


</Layout>

<!-- Initialize navigation cache with server-rendered data -->
<script type="module" define:vars={{ threads, spaces, inboxItemCount }}>
  import { initNavigationCache } from '../scripts/navigation-cache-client';
  
  // Cache navigation data after page loads
  if (typeof window !== 'undefined') {
    // Initialize cache with server-rendered data
    initNavigationCache(threads, spaces, inboxItemCount);
    
    // Re-initialize after View Transitions
    document.addEventListener('astro:page-load', () => {
      // Try to get data from the new page, or use cached data
      initNavigationCache(threads, spaces, inboxItemCount);
    });
  }
</script>

<!-- Update inbox/archive auto text based on active tab -->
<script is:inline>
  function updateInboxArchiveText() {
    // Find all inbox-archive-tabs instances (works for both desktop and mobile)
    const inboxArchiveTabs = document.querySelectorAll('.inbox-archive-tabs');
    
    inboxArchiveTabs.forEach(function(tabContainer) {
      const inboxButton = tabContainer.querySelector('[data-tab-id="inbox"]');
      const archiveButton = tabContainer.querySelector('[data-tab-id="archive"]');
      
      if (!inboxButton || !archiveButton) return;
      
      // Find text elements within the same parent container
      const parentContainer = tabContainer.parentElement;
      if (!parentContainer) return;
      
      const inboxText = parentContainer.querySelector('.inbox-auto-text');
      const archiveText = parentContainer.querySelector('.archive-auto-text');
      
      if (!inboxText || !archiveText) return;
      
      const isInboxActive = inboxButton.getAttribute('data-active') === 'true';
      
      if (isInboxActive) {
        inboxText.classList.remove('hidden');
        archiveText.classList.add('hidden');
      } else {
        inboxText.classList.add('hidden');
        archiveText.classList.remove('hidden');
      }
    });
  }
  
  // Update on page load
  if (typeof window !== 'undefined') {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updateInboxArchiveText);
    } else {
      updateInboxArchiveText();
    }
    
    // Listen for tab clicks on inbox-archive-tabs
    document.addEventListener('click', function(e) {
      const clickedTab = e.target.closest('.inbox-archive-tabs [data-tab-button]');
      if (clickedTab) {
        // Small delay to let tab-manager.js update the active state first
        setTimeout(updateInboxArchiveText, 10);
      }
    });
    
    // Also listen for View Transitions
    document.addEventListener('astro:page-load', function() {
      setTimeout(updateInboxArchiveText, 100);
    });
  }
</script>
