---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import NavigationColumnReact from "@/components/NavigationColumnReact.astro";
import MobileNavigation from "@/components/MobileNavigation.astro";
import MobileAdditional from "@/components/MobileAdditional.astro";
import { getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
import { calculateTotalXP } from "@/utils/xp-system";
import { getThreadGradientCSS } from "@/utils/colors";
import { getCachedUserData, type CachedUserData } from '@/utils/user-cache';
import ProfilePageReact from "@/components/ProfilePageReact.astro";
import ProfileContent from "@/components/profile/ProfileContent.astro";

// Get user data from Clerk authentication
const auth = Astro.locals.auth();
const { userId } = auth;

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Get cached user data
let userData: CachedUserData;
try {
  userData = await getCachedUserData(userId);
} catch (error) {
  console.log('Error getting cached user data:', error);
  // Fallback data
  userData = {
    firstName: '',
    lastName: '',
    email: '',
    initials: 'U',
    displayName: 'User',
    userColor: 'paper',
  };
}

const { firstName, lastName, email, initials, displayName, userColor, createdAt } = userData;

// Format join date
let joinDate: string;
if (createdAt) {
  const joinDateObj = new Date(createdAt);
  const month = joinDateObj.toLocaleDateString('en-US', { month: 'short' });
  const year = joinDateObj.getFullYear();
  joinDate = `${month} ${year}`;
} else {
  const currentDate = new Date();
  const currentMonth = currentDate.toLocaleDateString('en-US', { month: 'short' });
  const currentYear = currentDate.getFullYear();
  joinDate = `${currentMonth} ${currentYear}`;
}

// Fetch navigation data
let spaces: any[] = [];
let threads: any[] = [];
let inboxCount: number = 0;
let userXP: number = 0;

try {
  const [spacesData, threadsData, inboxCountData, xpData] = await Promise.all([
    getSpacesWithCounts(userId),
    getAllThreadsWithCounts(userId),
    getInboxCount(userId),
    calculateTotalXP(userId)
  ]);
  
  spaces = spacesData.map(space => ({
    ...space,
    backgroundGradient: space.backgroundGradient || getThreadGradientCSS(space.color || 'blue')
  }));
  threads = threadsData.map(thread => ({
    ...thread,
    backgroundGradient: thread.backgroundGradient || getThreadGradientCSS(thread.color || 'blue')
  }));
  inboxCount = inboxCountData;
  userXP = xpData;
  
} catch (error) {
  console.error("Error fetching navigation data:", error);
}

const contentType = "profile";
const contentId = "profile";
---

<Layout title="Profile" contentType={contentType} contentId={contentId}>
  <!-- Navigation Column -->
  <NavigationColumnReact 
    slot="navigation"
    inboxCount={inboxCount}
    spaces={spaces}
    activeThread={null}
    currentSpace={null}
    isNote={false}
    currentId={undefined}
    showProfile={true}
    initials={initials}
    userColor={userColor}
  />

  <!-- Main Column -->
  <div slot="main" class="h-full">
    <div class="flex flex-col h-full">
      <div class="flex-1 min-h-0">
        <CardStack 
          title={displayName}
          headerBgColor={`var(--color-${userColor})`}
          centerTitle={true}
          class="h-full"
          id="profile-cardstack"
        >
          <ProfileContent joinDate={joinDate} userXP={userXP} />
        </CardStack>
      </div>
      
      <!-- Logout Button at Bottom -->
      <div class="mt-4 mb-safe">
        <button
          id="logout-button"
          type="button"
          onclick="window.handleLogout && window.handleLogout(event)"
          data-outer-shadow
          class="group relative rounded-3xl cursor-pointer transition-[scale,shadow] duration-300 pb-7 pt-6 px-6 flex items-center justify-center font-sans font-semibold text-[18px] leading-[0] text-nowrap text-[var(--color-fog-white)] min-h-[60px] w-full shadow-[0px_4px_4px_0px_rgba(0,0,0,0.25)]"
          style="background-color: var(--color-stone-grey)"
        >
          <div class="relative shrink-0 transition-transform duration-125">
            Logout
          </div>
          <div class="absolute inset-0 pointer-events-none rounded-3xl transition-shadow duration-125 shadow-[0px_-8px_0px_0px_rgba(0,0,0,0.1)_inset] group-active:!shadow-[0px_-2px_0px_0px_rgba(0,0,0,0.1)_inset]" />
        </button>
      </div>
    </div>
  </div>

  <ProfilePageReact
    slot="additional"
    displayName={displayName}
    userColor={userColor}
    joinDate={joinDate}
    userXP={userXP}
    firstName={firstName}
    lastName={lastName}
  />

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">
    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxCount}
      currentSpace={null}
      currentThread={null}
      initials={initials}
      userColor={userColor}
    />
  </div>

  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional contentType="profile" contentId={contentId} currentThread={null} currentSpace={null} />
  </div>
</Layout>
<script>
    // Make logout globally available for the Astro button to call into the React component
    // This script can be removed once the logout button is also moved to React
    document.addEventListener('DOMContentLoaded', () => {
        if (window.profilePage && window.profilePage.handleLogout) {
            window.handleLogout = window.profilePage.handleLogout;
        }
    });
    document.addEventListener('astro:page-load', () => {
        if (window.profilePage && window.profilePage.handleLogout) {
            window.handleLogout = window.profilePage.handleLogout;
        }
    });
</script>
