---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import SquareButton from "@/components/SquareButton.astro";
import SpaceButton from "@/components/SpaceButton.astro";
import Avatar from "@/components/Avatar.astro";
import PersistentNavigation from "@/components/PersistentNavigation.astro";
import Button from "@/components/Button.astro";
import MobileNavigation from "@/components/MobileNavigation.astro";
import MobileAdditional from "@/components/MobileAdditional.astro";
import { getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
import { calculateTotalXP } from "@/utils/xp-system";
import FaBoltIcon from "@fortawesome/fontawesome-free/svgs/solid/bolt.svg";
import EditNameColorPanel from "@/components/EditNameColorPanelReact.astro";

// Get user data from Clerk authentication
const auth = Astro.locals.auth();
const { userId, getToken } = auth;

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Get cached user data (optimized - no API calls on every page load)
import { getCachedUserData, type CachedUserData } from '@/utils/user-cache';

let userData: CachedUserData;
try {
  userData = await getCachedUserData(userId);
} catch (error) {
  console.log('Error getting cached user data:', error);
  // Fallback data
  userData = {
    firstName: '',
    lastName: '',
    email: '',
    initials: 'U',
    displayName: 'User',
    userColor: 'paper',
  };
}

const { firstName, lastName, email, initials, displayName, userColor } = userData;

// Extract and format join date (fallback to current date since we don't cache this)
const currentDate = new Date();
const currentMonth = currentDate.toLocaleDateString('en-US', { month: 'short' });
const currentYear = currentDate.getFullYear();
const joinDate = `${currentMonth} ${currentYear}`;

// User data is now cached and includes userColor, initials, and displayName

// Debug: Show what we got
console.log('Final values:', { firstName, lastName, email, initials, displayName, userColor, joinDate });

// Fetch navigation data for mobile components and XP data
let spaces: any[] = [];
let threads: any[] = [];
let inboxCount: number = 0;
let userXP: number = 0;

try {
  const [spacesData, threadsData, inboxCountData, xpData] = await Promise.all([
    getSpacesWithCounts(userId),
    getAllThreadsWithCounts(userId),
    getInboxCount(userId),
    calculateTotalXP(userId)
  ]);
  
  spaces = spacesData;
  threads = threadsData;
  inboxCount = inboxCountData;
  userXP = xpData;
  
  // Ensure threads have backgroundGradient property for consistency
  threads = threads.map(thread => ({
    ...thread,
    backgroundGradient: thread.backgroundGradient || `linear-gradient(180deg, var(--color-${thread.color || 'blessed-blue'}) 0%, var(--color-${thread.color || 'blessed-blue'}) 100%)`
  }));
  
  // Ensure spaces have backgroundGradient property for consistency
  spaces = spaces.map(space => ({
    ...space,
    backgroundGradient: space.backgroundGradient || `linear-gradient(180deg, var(--color-${space.color || 'blessed-blue'}) 0%, var(--color-${space.color || 'blessed-blue'}) 100%)`
  }));
} catch (error) {
  console.error("Error fetching navigation data:", error);
  // Fallback to empty data
  spaces = [];
  threads = [];
  inboxCount = 0;
  userXP = 0;
}

// Mock data for profile - in a real app this would come from a database
const userProfile = {
  name: displayName,
  initials: initials,
  email: email,
  joinDate: "January 2024",
  stats: {
    totalNotes: 42,
    totalThreads: 8,
    totalSpaces: 3
  }
};

const contentType = "profile";
const contentId = "profile";
---

<Layout title="Profile" contentType={contentType} contentId={contentId}>
  <!-- Navigation Column -->
  <div slot="navigation" class="h-full">
    <div class="flex flex-col items-start justify-between relative h-full">
      <!-- Top Section - Navigation -->
      <div class="flex flex-col gap-12 items-start justify-start w-full flex-1 min-h-0">
        <!-- Navigation Buttons -->
        <div class="flex flex-col items-start justify-start w-full">
          <a href="/dashboard" class="w-full">
            <SpaceButton 
              text="For You" 
              count={inboxCount} 
              state="WithCount" 
              className="w-full" 
              isActive={false} 
            />
          </a>
          
          {/* Persistent Navigation - shows recently accessed items */}
          <PersistentNavigation />
        </div>
      </div>
      
      <!-- Bottom Section with New Space Button, Search, and Back Button -->
      <div class="flex gap-3 items-center justify-start w-full shrink-0">
        <a href="/new-space" class="flex-1">
          <SpaceButton text="New Space" className="w-full" />
        </a>
        <SquareButton variant="Search" />
        <a href="/dashboard">
          <SquareButton variant="Back" />
        </a>
      </div>
    </div>
  </div>

  <!-- Main Column -->
  <div slot="main" class="h-full flex flex-col">
    <CardStack 
      title={displayName}
      headerBgColor={`var(--color-${userColor})`}
      centerTitle={true}
      class="flex-1"
      id="profile-cardstack"
    >
      <!-- Profile Content -->
      <div class="flex flex-col justify-between h-full w-full">
        <!-- Top Section -->
        <div class="flex flex-col gap-4">
          <!-- Top Info Cards -->
          <div class="grid grid-cols-2 gap-4">
            <!-- Joined Date Card -->
            <div class="bg-white border border-[var(--color-fog-white)] rounded-2xl p-4 flex items-center gap-3">
              <svg class="w-5 h-5 fill-current text-[var(--color-deep-grey)]" viewBox="0 0 448 512">
                <path d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM48 192H400V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z"/>
              </svg>
              <div>
                <div class="text-lg font-bold text-[var(--color-deep-grey)]">{joinDate}</div>
                <div class="text-sm text-[var(--color-pebble-grey)]">Joined</div>
              </div>
            </div>
            
            <!-- XP Card -->
            <div class="bg-white border border-[var(--color-fog-white)] rounded-2xl p-4 flex items-center gap-3">
              <FaBoltIcon class="w-5 h-5 fill-current text-[var(--color-deep-grey)]" />
              <div>
                <div class="text-lg font-bold text-[var(--color-deep-grey)]">{userXP}</div>
                <div class="text-sm text-[var(--color-pebble-grey)]">XP</div>
              </div>
            </div>
          </div>

          <!-- Settings Options -->
          <div class="flex flex-col gap-3">
            <!-- Edit Name & Color -->
            <div onclick="window.dispatchEvent(new CustomEvent('openProfilePanel', { detail: { panelName: 'editNameColor' } }))" class="w-full">
              <SpaceButton 
                text="Edit Name & Color"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
            
            <!-- Email & Password -->
            <div onclick="window.dispatchEvent(new CustomEvent('openProfilePanel', { detail: { panelName: 'emailPassword' } }))" class="w-full">
              <SpaceButton 
                text="Email & Password"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
            
            <!-- My Church -->
            <div onclick="window.dispatchEvent(new CustomEvent('openProfilePanel', { detail: { panelName: 'myChurch' } }))" class="w-full">
              <SpaceButton 
                text="My Church"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
            
            <!-- My Data -->
            <div onclick="window.dispatchEvent(new CustomEvent('openProfilePanel', { detail: { panelName: 'myData' } }))" class="w-full">
              <SpaceButton 
                text="My Data"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
          </div>
        </div>

        <!-- Bottom Section - Get Support -->
        <div class="mt-auto">
          <div onclick="window.dispatchEvent(new CustomEvent('openProfilePanel', { detail: { panelName: 'getSupport' } }))" class="w-full">
            <SpaceButton 
              text="Get Support"
              state="WithArrow"
              backgroundGradient="var(--color-gradient-gray)"
              className="w-full"
            />
          </div>
        </div>
      </div>
    </CardStack>
    
    <!-- Logout Button at Bottom -->
    <div class="mt-4">
      <Button state="Secondary" class="w-full" id="logout-button">
        Logout
      </Button>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">
    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxCount}
      currentSpace={null}
      currentThread={null}
      initials={initials}
      userColor={userColor}
    />
  </div>

  <!-- Additional Column for Panels -->
  <div slot="additional" class="h-full additional-slot" id="profile-panels">
    <!-- Default state: No panels shown -->
    <div id="default-panel" class="flex flex-col items-left h-full justify-end">
      <!-- No buttons for profile page -->
    </div>
    
    <!-- Edit Name & Color Panel -->
    <div id="editNameColor-panel" class="h-full" style="display: none;">
      <EditNameColorPanel firstName={firstName} lastName={lastName} selectedColor={userColor as any} />
    </div>
    
    <!-- Placeholder for other panels -->
    <div id="emailPassword-panel" style="display: none;">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>Email & Password panel coming soon...</p>
      </div>
    </div>
    
    <div id="myChurch-panel" style="display: none;">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>My Church panel coming soon...</p>
      </div>
    </div>
    
    <div id="myData-panel" style="display: none;">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>My Data panel coming soon...</p>
      </div>
    </div>
    
    <div id="getSupport-panel" style="display: none;">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>Get Support panel coming soon...</p>
      </div>
    </div>
  </div>

  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional contentType="profile" contentId={contentId} currentThread={null} currentSpace={null} />
  </div>
</Layout>


<script>
  // Avatar manager is loaded globally via Layout.astro
  
  // ===== FUNCTION DEFINITIONS (SCRIPT SCOPE) =====
  
  // Setup profile event listeners
  function setupProfileListeners() {
    console.log('ðŸ”§ Setting up profile event listeners');
    
    // Remove any existing listeners to prevent duplicates
    window.removeEventListener('updateProfileRequest', handleProfileUpdateRequest);
    window.addEventListener('updateProfileRequest', handleProfileUpdateRequest);
    
    console.log('âœ… Profile event listeners attached');
  }

  async function handleProfileUpdateRequest(event) {
    console.log('âœ… profile.astro: updateProfileRequest event received:', event.detail);
    
    try {
      const { firstName, lastName, color } = event.detail;
      
      console.log('ðŸ“¤ profile.astro: Making API call to /api/user/update-profile');
      
      const response = await fetch('/api/user/update-profile', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          firstName,
          lastName,
          color
        })
      });

      console.log('ðŸ“¥ profile.astro: API response status:', response.status);
      const data = await response.json();
      console.log('ðŸ“¥ profile.astro: API response data:', data);

        if (response.ok) {
          console.log('âœ… profile.astro: Profile updated successfully');
          
          // Show success toast
          window.dispatchEvent(new CustomEvent('toast', {
            detail: {
              message: 'Profile saved successfully!',
              type: 'success'
            }
          }));
          
          // Refresh the page to show updated data
          console.log('ðŸ”„ Refreshing page to show updated profile data');
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
        console.error('âŒ profile.astro: Profile update failed:', data);
        
        // Show error toast
        window.dispatchEvent(new CustomEvent('toast', {
          detail: {
            message: 'Failed to save profile. Please try again.',
            type: 'error'
          }
        }));
      }
    } catch (error) {
      console.error('âŒ profile.astro: Error updating profile:', error);
      
      // Show error toast
      window.dispatchEvent(new CustomEvent('toast', {
        detail: {
          message: 'Error saving profile. Please try again.',
          type: 'error'
        }
      }));
    }
  }

  // Logout handler function
  async function handleLogout(event) {
    event.preventDefault();
    console.log('Logout button clicked');
    
    try {
      // Use Clerk's client-side signOut if available
      if (window.Clerk && window.Clerk.signOut) {
        console.log('Using Clerk signOut');
        await window.Clerk.signOut();
      } else {
        console.log('Clerk not available, using direct redirect');
      }
      
      // Always redirect to sign-in page
      console.log('Redirecting to sign-in page');
      window.location.href = '/sign-in';
    } catch (error) {
      console.error('Logout failed:', error);
      // Fallback: redirect to sign-in page anyway
      console.log('Fallback: redirecting to sign-in page');
      window.location.href = '/sign-in';
    }
  }

  // Desktop panel switching functionality
  function showPanel(panelName) {
    console.log('Desktop: Showing panel:', panelName);
    
    // Hide all panels
    const allPanels = document.querySelectorAll('[id$="-panel"]');
    allPanels.forEach(panel => {
      panel.style.display = 'none';
    });
    
    // Show the requested panel
    const targetPanel = document.getElementById(`${panelName}-panel`);
    if (targetPanel) {
      targetPanel.style.display = 'block';
      console.log('Desktop: Panel shown:', panelName);
    } else {
      console.log('Desktop: Panel not found:', panelName);
    }
  }
  
  function hideAllPanels() {
    console.log('Desktop: Hiding all panels');
    const allPanels = document.querySelectorAll('[id$="-panel"]');
    allPanels.forEach(panel => {
      panel.style.display = 'none';
    });
    
    // Show default panel
    const defaultPanel = document.getElementById('default-panel');
    if (defaultPanel) {
      defaultPanel.style.display = 'block';
    }
  }

  // Setup logout button
  function setupLogoutButton() {
    console.log('Profile page DOM loaded, setting up logout button');
    
    const logoutButton = document.getElementById('logout-button');
    console.log('Logout button found:', !!logoutButton);
    
    if (logoutButton) {
      // Remove any existing listeners to prevent duplicates
      logoutButton.removeEventListener('click', handleLogout);
      
      // Add the click handler
      logoutButton.addEventListener('click', handleLogout);
      console.log('Logout button event listener added');
    } else {
      console.error('Logout button not found!');
    }
    
    // Additional logout button setup as fallback
    setTimeout(() => {
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton && !logoutButton.hasAttribute('data-listener-added')) {
        logoutButton.setAttribute('data-listener-added', 'true');
        logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Fallback logout clicked');
          window.location.href = '/sign-in';
        });
        console.log('Fallback logout listener added');
      }
    }, 1000);
  }

  // Setup panel event listeners
  function setupPanelListeners() {
    // Listen for profile panel events (desktop only)
    window.addEventListener('openProfilePanel', (event) => {
      console.log('Desktop: openProfilePanel event received:', event.detail);
      const panelName = event.detail.panelName;
      
      // Check if we're on desktop (screen width >= 1160px)
      if (window.innerWidth >= 1160) {
        console.log('Desktop: Opening panel in additional column');
        showPanel(panelName);
      } else {
        console.log('Desktop: On mobile, letting MobileAdditional handle it');
      }
    });
    
    window.addEventListener('closeProfilePanel', () => {
      console.log('Desktop: closeProfilePanel event received');
      if (window.innerWidth >= 1160) {
        hideAllPanels();
      }
    });
  }

  // Setup other event listeners
  function setupOtherListeners() {
    // Global function to close profile panels
    window.closeProfilePanel = () => {
      console.log('closeProfilePanel function called');
      window.dispatchEvent(new CustomEvent('closeProfilePanel'));
    };
  }

  // ===== INITIALIZATION FUNCTION =====
  
  function initializeProfilePage() {
    console.log('ðŸš€ Initializing profile page...');
    
    // Setup profile event listeners (MOST CRITICAL - DO FIRST)
    setupProfileListeners();
    
    // Setup logout button
    setupLogoutButton();
    
    // Setup panel listeners
    setupPanelListeners();
    
    // Setup other listeners
    setupOtherListeners();
    
    console.log('âœ… Profile page initialization complete');
  }

  // ===== INITIALIZATION LOGIC =====
  
  // Check if DOM is already ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeProfilePage);
  } else {
    // DOM already loaded (View Transitions case) - initialize immediately
    initializeProfilePage();
  }

  // Also handle View Transitions
  document.addEventListener('astro:page-load', () => {
    console.log('ðŸ”„ Re-initializing profile page after View Transitions');
    initializeProfilePage();
  });

</script>
