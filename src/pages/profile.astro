---
import Layout from "@/layouts/Layout.astro";
import CardStack from "@/components/CardStack.astro";
import SquareButton from "@/components/SquareButton.astro";
import SpaceButton from "@/components/SpaceButton.astro";
import Avatar from "@/components/Avatar.astro";
import PersistentNavigation from "@/components/PersistentNavigation.astro";
import Button from "@/components/Button.astro";
import MobileNavigation from "@/components/MobileNavigation.astro";
import MobileAdditional from "@/components/MobileAdditional.astro";
import { getAllThreadsWithCounts, getSpacesWithCounts, getInboxCount } from "@/utils/dashboard-data";
import { calculateTotalXP } from "@/utils/xp-system";
import FaBoltIcon from "@fortawesome/fontawesome-free/svgs/solid/bolt.svg";
import EditNameColorPanel from "@/components/EditNameColorPanel.astro";

// Get user data from Clerk authentication
const auth = Astro.locals.auth();
const { userId, getToken } = auth;

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Get cached user data (optimized - no API calls on every page load)
import { getCachedUserData, type CachedUserData } from '@/utils/user-cache';

let userData: CachedUserData;
try {
  userData = await getCachedUserData(userId);
} catch (error) {
  console.log('Error getting cached user data:', error);
  // Fallback data
  userData = {
    firstName: '',
    lastName: '',
    email: '',
    initials: 'U',
    displayName: 'User',
    userColor: 'paper',
  };
}

const { firstName, lastName, email, initials, displayName, userColor } = userData;

// Extract and format join date (fallback to current date since we don't cache this)
const currentDate = new Date();
const currentMonth = currentDate.toLocaleDateString('en-US', { month: 'short' });
const currentYear = currentDate.getFullYear();
const joinDate = `${currentMonth} ${currentYear}`;

// User data is now cached and includes userColor, initials, and displayName

// Debug: Show what we got
console.log('Final values:', { firstName, lastName, email, initials, displayName, userColor, joinDate });

// Fetch navigation data for mobile components and XP data
let spaces: any[] = [];
let threads: any[] = [];
let inboxCount: number = 0;
let userXP: number = 0;

try {
  const [spacesData, threadsData, inboxCountData, xpData] = await Promise.all([
    getSpacesWithCounts(userId),
    getAllThreadsWithCounts(userId),
    getInboxCount(userId),
    calculateTotalXP(userId)
  ]);
  
  spaces = spacesData;
  threads = threadsData;
  inboxCount = inboxCountData;
  userXP = xpData;
  
  // Ensure threads have backgroundGradient property for consistency
  threads = threads.map(thread => ({
    ...thread,
    backgroundGradient: thread.backgroundGradient || `linear-gradient(180deg, var(--color-${thread.color || 'blessed-blue'}) 0%, var(--color-${thread.color || 'blessed-blue'}) 100%)`
  }));
  
  // Ensure spaces have backgroundGradient property for consistency
  spaces = spaces.map(space => ({
    ...space,
    backgroundGradient: space.backgroundGradient || `linear-gradient(180deg, var(--color-${space.color || 'blessed-blue'}) 0%, var(--color-${space.color || 'blessed-blue'}) 100%)`
  }));
} catch (error) {
  console.error("Error fetching navigation data:", error);
  // Fallback to empty data
  spaces = [];
  threads = [];
  inboxCount = 0;
  userXP = 0;
}

// Mock data for profile - in a real app this would come from a database
const userProfile = {
  name: displayName,
  initials: initials,
  email: email,
  joinDate: "January 2024",
  stats: {
    totalNotes: 42,
    totalThreads: 8,
    totalSpaces: 3
  }
};

const contentType = "profile";
const contentId = "profile";
---

<Layout title="Profile" contentType={contentType} contentId={contentId}>
  <!-- Navigation Column -->
  <div slot="navigation" class="h-full">
    <div class="flex flex-col items-start justify-between relative h-full">
      <!-- Top Section - Navigation -->
      <div class="flex flex-col gap-12 items-start justify-start w-full flex-1 min-h-0">
        <!-- Navigation Buttons -->
        <div class="flex flex-col items-start justify-start w-full">
          <a href="/dashboard" class="w-full">
            <SpaceButton 
              text="For You" 
              count={inboxCount} 
              state="WithCount" 
              className="w-full" 
              isActive={false} 
            />
          </a>
          
          {/* Persistent Navigation - shows recently accessed items */}
          <PersistentNavigation />
        </div>
      </div>
      
      <!-- Bottom Section with New Space Button, Search, and Back Button -->
      <div class="flex gap-3 items-center justify-start w-full shrink-0">
        <a href="/new-space" class="flex-1">
          <SpaceButton text="New Space" className="w-full" />
        </a>
        <SquareButton variant="Search" />
        <a href="/dashboard">
          <SquareButton variant="Back" />
        </a>
      </div>
    </div>
  </div>

  <!-- Main Column -->
  <div slot="main" class="h-full flex flex-col" x-data="{
    openPanel(panelName) {
      console.log('Main column openPanel called with:', panelName);
      window.dispatchEvent(new CustomEvent('openProfilePanel', { detail: { panelName } }));
    }
  }">
    <CardStack 
      title={displayName}
      headerBgColor={`var(--color-${userColor})`}
      centerTitle={true}
      class="flex-1"
      id="profile-cardstack"
    >
      <!-- Profile Content -->
      <div class="flex flex-col justify-between h-full w-full">
        <!-- Top Section -->
        <div class="flex flex-col gap-4">
          <!-- Top Info Cards -->
          <div class="grid grid-cols-2 gap-4">
            <!-- Joined Date Card -->
            <div class="bg-white border border-[var(--color-fog-white)] rounded-2xl p-4 flex items-center gap-3">
              <svg class="w-5 h-5 fill-current text-[var(--color-deep-grey)]" viewBox="0 0 448 512">
                <path d="M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64H344V24c0-13.3-10.7-24-24-24s-24 10.7-24 24V64H152V24zM48 192H400V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z"/>
              </svg>
              <div>
                <div class="text-lg font-bold text-[var(--color-deep-grey)]">{joinDate}</div>
                <div class="text-sm text-[var(--color-pebble-grey)]">Joined</div>
              </div>
            </div>
            
            <!-- XP Card -->
            <div class="bg-white border border-[var(--color-fog-white)] rounded-2xl p-4 flex items-center gap-3">
              <FaBoltIcon class="w-5 h-5 fill-current text-[var(--color-deep-grey)]" />
              <div>
                <div class="text-lg font-bold text-[var(--color-deep-grey)]">{userXP}</div>
                <div class="text-sm text-[var(--color-pebble-grey)]">XP</div>
              </div>
            </div>
          </div>

          <!-- Settings Options -->
          <div class="flex flex-col gap-3">
            <!-- Edit Name & Color -->
            <div x-on:click="console.log('Edit Name & Color div clicked'); openPanel('editNameColor')" class="w-full">
              <SpaceButton 
                text="Edit Name & Color"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
            
            <!-- Email & Password -->
            <div x-on:click="openPanel('emailPassword')" class="w-full">
              <SpaceButton 
                text="Email & Password"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
            
            <!-- My Church -->
            <div x-on:click="openPanel('myChurch')" class="w-full">
              <SpaceButton 
                text="My Church"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
            
            <!-- My Data -->
            <div x-on:click="openPanel('myData')" class="w-full">
              <SpaceButton 
                text="My Data"
                state="WithArrow"
                backgroundGradient="var(--color-gradient-gray)"
                className="w-full"
              />
            </div>
          </div>
        </div>

        <!-- Bottom Section - Get Support -->
        <div class="mt-auto">
          <SpaceButton 
            text="Get Support"
            state="WithArrow"
            backgroundGradient="var(--color-gradient-gray)"
            className="w-full"
          />
        </div>
      </div>
    </CardStack>
    
    <!-- Logout Button at Bottom -->
    <div class="mt-4">
      <Button state="Secondary" class="w-full" id="logout-button">
        Logout
      </Button>
    </div>
  </div>

  <!-- Mobile Navigation -->
  <div slot="mobile-navigation">
    <MobileNavigation 
      spaces={spaces}
      threads={threads}
      inboxCount={inboxCount}
      currentSpace={null}
      currentThread={null}
      initials={initials}
      userColor={userColor}
    />
  </div>

  <!-- Additional Column for Panels -->
  <div slot="additional" class="h-full additional-slot" x-data="{ 
    showNewNotePanel: false, 
    showNewThreadPanel: false,
    showEditNameColorPanel: false,
    showEmailPasswordPanel: false,
    showMyChurchPanel: false,
    showMyDataPanel: false,
    openProfilePanel(panelName) {
      // Close all other panels first
      this.showNewNotePanel = false;
      this.showNewThreadPanel = false;
      this.showEditNameColorPanel = false;
      this.showEmailPasswordPanel = false;
      this.showMyChurchPanel = false;
      this.showMyDataPanel = false;
      
      // Open the requested panel
      if (panelName === 'editNameColor') this.showEditNameColorPanel = true;
      else if (panelName === 'emailPassword') this.showEmailPasswordPanel = true;
      else if (panelName === 'myChurch') this.showMyChurchPanel = true;
      else if (panelName === 'myData') this.showMyDataPanel = true;
    },
    closeProfilePanel() {
      this.showEditNameColorPanel = false;
      this.showEmailPasswordPanel = false;
      this.showMyChurchPanel = false;
      this.showMyDataPanel = false;
    }
  }" x-init="
    console.log('Additional slot initialized');
  ">
    <!-- Default state: SquareButtons -->
    <div x-show="!showNewNotePanel && !showNewThreadPanel && !showEditNameColorPanel && !showEmailPasswordPanel && !showMyChurchPanel && !showMyDataPanel" class="flex flex-col items-left h-full justify-end">
      <!-- No buttons for profile page -->
    </div>
    
    <!-- Edit Name & Color Panel -->
    <div x-show="showEditNameColorPanel" class="h-full">
      <EditNameColorPanel firstName={firstName} lastName={lastName} selectedColor={userColor} />
    </div>
    
    <!-- Placeholder for other panels -->
    <div x-show="showEmailPasswordPanel">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>Email & Password panel coming soon...</p>
      </div>
    </div>
    
    <div x-show="showMyChurchPanel">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>My Church panel coming soon...</p>
      </div>
    </div>
    
    <div x-show="showMyDataPanel">
      <div class="text-center text-[var(--color-deep-grey)] p-8">
        <p>My Data panel coming soon...</p>
      </div>
    </div>
  </div>

  <!-- Mobile Additional -->
  <div slot="mobile-additional">
    <MobileAdditional contentType="profile" contentId={contentId} currentThread={null} currentSpace={null} />
  </div>
</Layout>


<script>
  // Get the logout button and add click handler
  document.addEventListener('DOMContentLoaded', () => {
    console.log('Profile page DOM loaded, setting up logout button');
    
    const logoutButton = document.getElementById('logout-button');
    console.log('Logout button found:', !!logoutButton);
    
    if (logoutButton) {
      // Remove any existing listeners to prevent duplicates
      logoutButton.removeEventListener('click', handleLogout);
      
      // Add the click handler
      logoutButton.addEventListener('click', handleLogout);
      console.log('Logout button event listener added');
    } else {
      console.error('Logout button not found!');
    }
    
    // Define the logout handler function
    async function handleLogout(event: Event) {
      event.preventDefault();
      console.log('Logout button clicked');
      
      try {
        // Use Clerk's client-side signOut if available
        if (window.Clerk && window.Clerk.signOut) {
          console.log('Using Clerk signOut');
          await window.Clerk.signOut();
        } else {
          console.log('Clerk not available, using direct redirect');
        }
        
        // Always redirect to sign-in page
        console.log('Redirecting to sign-in page');
        window.location.href = '/sign-in';
      } catch (error) {
        console.error('Logout failed:', error);
        // Fallback: redirect to sign-in page anyway
        console.log('Fallback: redirecting to sign-in page');
        window.location.href = '/sign-in';
      }
    }
    
    // Global function to close profile panels
    (window as any).closeProfilePanel = () => {
      console.log('closeProfilePanel function called');
      window.dispatchEvent(new CustomEvent('closeProfilePanel'));
    };
    
    // Global function to update all avatars
    (window as any).updateAllAvatars = (color: string, initials: string) => {
      console.log('updateAllAvatars called with:', { color, initials });
      const newColor = `var(--color-${color})`;
      
      // Find all avatar elements - simple approach
      const avatars = document.querySelectorAll('.avatar-button');
      const avatarsWithData = document.querySelectorAll('.avatar-button[data-avatar-color]');
      
      console.log(`Found ${avatarsWithData.length} avatar elements with data attribute`);
      console.log(`Found ${avatars.length} total avatar elements on page`);
      console.log(`Will update all ${avatars.length} avatar elements`);
      
      // Log details about each avatar found
      avatars.forEach((avatar, index) => {
        const avatarElement = avatar as HTMLElement;
        const currentColor = avatarElement.getAttribute('data-avatar-color') || 'no-data-attr';
        const currentStyle = avatarElement.getAttribute('style') || 'no-style';
        const parentElement = avatarElement.parentElement?.tagName || 'no-parent';
        const parentHref = avatarElement.parentElement?.getAttribute('href') || 'no-href';
        
        console.log(`Avatar ${index + 1}:`, {
          hasDataAttr: avatarElement.hasAttribute('data-avatar-color'),
          currentColor,
          currentStyle: currentStyle.substring(0, 50) + '...',
          parentElement,
          parentHref,
          element: avatarElement
        });
      });
      
      let totalUpdated = 0;
      avatars.forEach((avatar, index) => {
        const avatarElement = avatar as HTMLElement;
        
        // Log before update
        console.log(`Before update - Avatar ${index + 1}:`, {
          currentStyle: avatarElement.getAttribute('style'),
          computedStyle: window.getComputedStyle(avatarElement).backgroundColor
        });
        
        // Update color with multiple approaches
        avatarElement.style.background = newColor;
        avatarElement.style.backgroundColor = newColor;
        avatarElement.setAttribute('style', `background: ${newColor} !important; background-color: ${newColor} !important;`);
        
        // Force update with CSS custom property
        avatarElement.style.setProperty('--avatar-color', newColor);
        avatarElement.style.setProperty('background', newColor, 'important');
        avatarElement.style.setProperty('background-color', newColor, 'important');
        
        // Update data attribute (add it if it doesn't exist)
        avatarElement.setAttribute('data-avatar-color', color);
        
        // Update initials
        const initialsElement = avatarElement.querySelector('p');
        if (initialsElement) {
          initialsElement.textContent = initials;
          avatarElement.setAttribute('data-avatar-initials', initials);
        }
        
        // Log after update
        console.log(`After update - Avatar ${index + 1}:`, {
          newStyle: avatarElement.getAttribute('style'),
          computedStyle: window.getComputedStyle(avatarElement).backgroundColor,
          color: color,
          initials: initials,
          parentElement: avatarElement.parentElement?.tagName,
          parentHref: avatarElement.parentElement?.getAttribute('href')
        });
        
        totalUpdated++;
      });
      
      console.log(`Total avatars updated: ${totalUpdated}`);
      return totalUpdated;
    };
    
    // Test function to manually update avatars
    (window as any).testAvatarUpdate = (color = 'peaceful-pink', initials = 'TJ') => {
      console.log('Testing avatar update with:', { color, initials });
      return (window as any).updateAllAvatars(color, initials);
    };
    
    // Debug function to inspect all avatars on the page
    (window as any).debugAllAvatars = () => {
      console.log('=== DEBUGGING ALL AVATARS ON PAGE ===');
      
      // Find all possible avatar elements
      const selectors = [
        '.avatar-button',
        '[class*="avatar"]',
        'div[style*="background"]',
        'a[href="/profile"] div',
        '.mobile-navigation div'
      ];
      
      selectors.forEach((selector, index) => {
        const elements = document.querySelectorAll(selector);
        console.log(`\nSelector ${index + 1}: "${selector}"`);
        console.log(`Found ${elements.length} elements`);
        
        elements.forEach((element, elementIndex) => {
          const el = element as HTMLElement;
          const rect = el.getBoundingClientRect();
          const computedStyle = window.getComputedStyle(el);
          
          console.log(`  Element ${elementIndex + 1}:`, {
            tagName: el.tagName,
            className: el.className,
            id: el.id,
            style: el.getAttribute('style'),
            computedBackground: computedStyle.backgroundColor,
            computedBackgroundColor: computedStyle.backgroundColor,
            visible: rect.width > 0 && rect.height > 0,
            position: { x: rect.x, y: rect.y, width: rect.width, height: rect.height },
            parentElement: el.parentElement?.tagName,
            parentHref: el.parentElement?.getAttribute('href'),
            textContent: el.textContent?.trim()
          });
        });
      });
      
      console.log('=== END AVATAR DEBUG ===');
    };
    
    // Make sure the functions are available globally
    (window as any).closeProfilePanel = (window as any).closeProfilePanel;
    
    // Set up event listeners for profile panels
    function setupProfilePanelListeners() {
      // Remove existing listeners to prevent duplicates
      window.removeEventListener('openProfilePanel', handleOpenProfilePanel);
      window.removeEventListener('closeProfilePanel', handleCloseProfilePanel);
      
      // Add new listeners
      window.addEventListener('openProfilePanel', handleOpenProfilePanel);
      window.addEventListener('closeProfilePanel', handleCloseProfilePanel);
    }
    
    function handleOpenProfilePanel(event: any) {
      console.log('openProfilePanel event received:', event.detail);
      const panelName = event.detail.panelName;
      
      // Try multiple selectors to find the Alpine component
      const selectors = [
        '[slot="additional"]',
        '.additional-slot',
        'div[slot="additional"]',
        'div[data-slot="additional"]'
      ];
      
      let additionalSlot = null;
      for (const selector of selectors) {
        additionalSlot = document.querySelector(selector);
        if (additionalSlot) {
          console.log('Found additional slot with selector:', selector);
          break;
        }
      }
      
      if (!additionalSlot) {
        console.error('Additional slot not found with any selector');
        console.log('Available elements with slot attribute:', document.querySelectorAll('[slot]'));
        return;
      }
      
      console.log('Additional slot element:', additionalSlot);
      console.log('Alpine data stack:', (additionalSlot as any)._x_dataStack);
      
      if ((additionalSlot as any)._x_dataStack && (additionalSlot as any)._x_dataStack[0]) {
        const alpineData = (additionalSlot as any)._x_dataStack[0];
        console.log('Alpine data:', alpineData);
        if (alpineData.openProfilePanel) {
          alpineData.openProfilePanel(panelName);
        } else {
          console.error('openProfilePanel method not found on Alpine data');
          console.log('Available methods:', Object.keys(alpineData));
        }
      } else {
        console.error('Alpine component not found in additional slot');
        console.log('Element has Alpine data:', !!(additionalSlot as any)._x_dataStack);
        
        // Fallback: Try to directly show the EditNameColorPanel
        if (panelName === 'editNameColor') {
          console.log('Attempting fallback: directly showing EditNameColorPanel');
          const editPanel = additionalSlot.querySelector('[x-show="showEditNameColorPanel"]');
          if (editPanel) {
            (editPanel as HTMLElement).style.display = 'block';
            console.log('Fallback: EditNameColorPanel shown directly');
          } else {
            console.error('Fallback: EditNameColorPanel element not found');
          }
        }
      }
    }
    
    function handleCloseProfilePanel() {
      console.log('closeProfilePanel event received');
      
      // Try multiple selectors to find the Alpine component
      const selectors = [
        '[slot="additional"]',
        '.additional-slot',
        'div[slot="additional"]',
        'div[data-slot="additional"]'
      ];
      
      let additionalSlot = null;
      for (const selector of selectors) {
        additionalSlot = document.querySelector(selector);
        if (additionalSlot) {
          console.log('Found additional slot with selector:', selector);
          break;
        }
      }
      
      if (!additionalSlot) {
        console.error('Additional slot not found with any selector');
        return;
      }
      
      console.log('Additional slot element:', additionalSlot);
      console.log('Alpine data stack:', (additionalSlot as any)._x_dataStack);
      
      if ((additionalSlot as any)._x_dataStack && (additionalSlot as any)._x_dataStack[0]) {
        const alpineData = (additionalSlot as any)._x_dataStack[0];
        console.log('Alpine data:', alpineData);
        if (alpineData.closeProfilePanel) {
          alpineData.closeProfilePanel();
        } else {
          console.error('closeProfilePanel method not found on Alpine data');
          console.log('Available methods:', Object.keys(alpineData));
        }
      } else {
        console.error('Alpine component not found in additional slot');
        console.log('Element has Alpine data:', !!(additionalSlot as any)._x_dataStack);
        
        // Fallback: Try to directly hide all panels
        console.log('Attempting fallback: directly hiding all panels');
        const panels = additionalSlot.querySelectorAll('[x-show*="Panel"]');
        panels.forEach(panel => {
          (panel as HTMLElement).style.display = 'none';
        });
        console.log('Fallback: All panels hidden directly');
      }
    }
    
    // Set up listeners when DOM is ready
    setupProfilePanelListeners();
    
    // Additional logout button setup as fallback
    setTimeout(() => {
      const logoutButton = document.getElementById('logout-button');
      if (logoutButton && !logoutButton.hasAttribute('data-listener-added')) {
        logoutButton.setAttribute('data-listener-added', 'true');
        logoutButton.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Fallback logout clicked');
          window.location.href = '/sign-in';
        });
        console.log('Fallback logout listener added');
      }
    }, 1000);
    
    // Listen for profile data requests from EditNameColorPanel
    window.addEventListener('requestProfileData', async () => {
      console.log('requestProfileData event received');
      try {
        // Fetch current user profile data
        const response = await fetch('/api/user/get-profile');
        if (response.ok) {
          const userData = await response.json();
          console.log('User profile data:', userData);
          
          // Only dispatch updateProfile if we have valid data
          if (userData.firstName && userData.lastName) {
            window.dispatchEvent(new CustomEvent('updateProfile', {
              detail: {
                firstName: userData.firstName,
                lastName: userData.lastName,
                userColor: userData.userColor
              }
            }));
          } else {
            console.warn('Invalid user data received:', userData);
          }
        }
      } catch (error) {
        console.error('Error fetching profile data:', error);
      }
    });
    
    // Listen for profile updates and update the CardStack header
    // Remove any existing listeners to prevent duplicates
    window.removeEventListener('updateProfile', handleProfileUpdate);
    window.addEventListener('updateProfile', handleProfileUpdate);
    
    async function handleProfileUpdate(event: any) {
      console.log('updateProfile event received:', event);
      const detail = (event as any).detail;
      console.log('Event detail:', detail);
      if (detail) {
        try {
          console.log('Starting profile update process...');
          // Update user data in Clerk
          const response = await fetch('/api/user/update-profile', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              firstName: detail.firstName,
              lastName: detail.lastName,
              color: detail.selectedColor
            })
          });
          
          if (response.ok) {
            // Show success toast
            window.dispatchEvent(new CustomEvent('toast', {
              detail: {
                message: 'Profile updated successfully!',
                type: 'success'
              }
            }));
            
            // Update CardStack title
            const cardStack = document.getElementById('profile-cardstack');
            if (cardStack) {
              const titleElement = cardStack.querySelector('p');
              if (titleElement) {
                titleElement.textContent = `${detail.firstName} ${detail.lastName.charAt(0)}`.trim();
              }
              
              // Update header background color
              const headerElement = cardStack.querySelector('div[style*="background-color"]') as HTMLElement;
              if (headerElement) {
                headerElement.style.backgroundColor = `var(--color-${detail.selectedColor})`;
              }
            }
            
            // Update all avatars using the global function
            const newInitials = `${detail.firstName.charAt(0) || ''}${detail.lastName.charAt(0) || ''}`.toUpperCase();
            console.log('Updating all avatars with:', { color: detail.selectedColor, initials: newInitials });
            
            // Use the global function to update all avatars
            const updatedCount = (window as any).updateAllAvatars(detail.selectedColor, newInitials);
            console.log(`Successfully updated ${updatedCount} avatars`);
            
            // Also dispatch events for any reactive components
            window.dispatchEvent(new CustomEvent('colorChanged', {
              detail: { color: detail.selectedColor }
            }));
            console.log('Dispatched colorChanged event with color:', detail.selectedColor);
          
          } else {
            // Show error toast with more specific message
            const errorData = await response.json().catch(() => ({}));
            const errorMessage = errorData.error || 'Failed to update profile. Please try again.';
            
            window.dispatchEvent(new CustomEvent('toast', {
              detail: {
                message: errorMessage,
                type: 'error'
              }
            }));
          }
        } catch (error) {
          console.error('Error updating profile:', error);
          // Show error toast
          window.dispatchEvent(new CustomEvent('toast', {
            detail: {
              message: 'Failed to update profile. Please try again.',
              type: 'error'
            }
          }));
        }
      }
    }
  });
</script>
