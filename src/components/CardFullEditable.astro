---
import QuillEditor from "./QuillEditor.astro";

export interface Props {
  title?: string;
  date?: string;
  noteId?: string;
  content?: string;
  className?: string;
  isEditable?: boolean;
  onSave?: (title: string, content: string) => void;
  onCancel?: () => void;
}

const {
  title = "Note from our founder, Derek",
  date = "Feb 7, 2025",
  noteId = undefined,
  content = "Thank you so much for trying out this notes app designed for Bible study. It's been a project I've been working on for a good amount of time. The goal of Harvous is to be the digital tool and space for you and others to use for your Bible study.\n\nHow it began... I was frustrated with there not being a good notes app just for my Bible study. I used Apple Notes and made a ton of highlights in the YouVersion Bible app. I needed a better app, so I sought out to design one. And with the help of my friend, Cam, we built this Bible study notes app.\n\nPlease if you come across anything that isn't working as it prolly should or if you have any feedback for us send it here.",
  className = "",
  isEditable = false,
  onSave,
  onCancel
} = Astro.props;

// Helper function to fix Quill v2 list rendering issues
function fixQuillV2Lists(htmlContent: string): string {
  if (!htmlContent) return '';
  
  // Quill v2 adds problematic spans inside list items
  // Remove these spans that interfere with list display
  let fixedContent = htmlContent
    // Remove Quill v2's ql-ui spans that break list rendering
    .replace(/<span class="ql-ui" contenteditable="false">[\s\S]*?<\/span>/gi, '')
    // Fix Quill v2's mixed list structure - convert ol with bullet items to ul
    .replace(/<ol[^>]*>([\s\S]*?)<\/ol>/gi, (match, content) => {
      // Check if any li has data-list="bullet"
      if (content.includes('data-list="bullet"')) {
        return `<ul style="list-style-type: disc !important; padding-left: 0.5em !important; margin-left: 0.5em !important;">${content}</ul>`;
      } else {
        return `<ol style="list-style-type: decimal !important; padding-left: 0.5em !important; margin-left: 0.5em !important;">${content}</ol>`;
      }
    })
    // Clean up li attributes and add styling
    .replace(/<li[^>]*>/gi, '<li style="display: list-item !important; list-style-position: outside !important; margin-left: 0 !important; padding-left: 0.2em !important;">')
    // Handle regular ul tags
    .replace(/<ul[^>]*>/gi, '<ul style="list-style-type: disc !important; padding-left: 0.5em !important; margin-left: 0.5em !important;">');
  
  return fixedContent;
}

// Process the content to fix Quill v2 list issues
const fixedContent = fixQuillV2Lists(content);
---

<div 
  class={`bg-white box-border content-stretch flex flex-col gap-6 items-start justify-start overflow-clip pb-3 pt-6 px-3 relative rounded-[24px] shadow-[0px_3px_20px_0px_rgba(120,118,111,0.1)] size-full ${className}`}
  data-card-full-editable
  x-data="{ 
    isEditing: false,
    editTitle: '',
    editContent: '',
    isSaving: false,
    hasChanges: false,
    originalTitle: '',
    originalContent: '',
    displayTitle: '',
    displayContent: '',
    onSaveCallback: null
  }"
  x-init="
    editTitle = '';
    editContent = '';
    originalTitle = '';
    originalContent = '';
    displayTitle = '';
    displayContent = '';
    onSaveCallback = null; // Will be set by the script
  "
>
  <!-- Header with title and bookmark icon -->
  <div class="box-border content-stretch flex gap-3 items-center justify-center px-3 py-0 relative shrink-0 w-full">
    <div class="basis-0 font-sans font-semibold grow leading-[0] min-h-px min-w-px not-italic relative shrink-0 text-[var(--color-deep-grey)] text-[24px]">
      <!-- Display mode -->
      <p x-show="!isEditing" class="leading-[normal] cursor-pointer rounded px-2 py-1 -mx-2 -my-1" @click="isEditing = true; editTitle = originalTitle; editContent = originalContent;">{title}</p>
      <!-- Edit mode -->
      <input 
        x-show="isEditing"
        x-model="editTitle"
        type="text"
        class="w-full bg-transparent border border-gray-200 rounded px-2 py-1 text-[24px] font-semibold text-[var(--color-deep-grey)] focus:outline-none focus:border-gray-300"
        placeholder="Note title"
        @keydown.enter="saveChanges()"
        @keydown.escape="cancelEdit()"
      />
    </div>
    <div class="relative shrink-0 size-5">
      <svg class="block max-w-none size-full text-[var(--color-deep-grey)] " fill="currentColor" viewBox="0 0 24 24">
        <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/>
      </svg>
    </div>
  </div>
  
  <!-- Date and Note ID -->
  <div class="box-border content-stretch flex font-sans font-normal items-center leading-[0] not-italic px-3 py-0 relative shrink-0 text-[var(--color-stone-grey)] text-[12px] text-nowrap w-full" class:list={[
    "justify-between",
    noteId ? "justify-between" : "justify-start"
  ]}>
    <div class="relative shrink-0">
      <p class="leading-[normal] text-nowrap whitespace-pre">{date}</p>
    </div>
    {noteId && (
      <div class="relative shrink-0">
        <p class="leading-[normal] text-nowrap whitespace-pre">#{noteId}</p>
      </div>
    )}
  </div>
  
  <!-- Content -->
  <div class="basis-0 box-border content-stretch flex grow items-start justify-between min-h-px min-w-px px-3 py-0 relative shrink-0 w-full">
    <div class="basis-0 flex flex-col font-sans font-normal grow justify-center leading-[1.6] min-h-px min-w-px not-italic relative shrink-0 text-[var(--color-deep-grey)] text-[16px]">
      <!-- Display mode -->
      <div x-show="!isEditing" class="ql-editor min-h-[200px] max-w-none cursor-pointer rounded px-2 py-1 -mx-2 -my-1" @click="isEditing = true; editTitle = originalTitle; editContent = originalContent;" data-fallback-content={fixedContent} set:html={fixedContent || ''}></div>
      
      <!-- Edit mode -->
      <div x-show="isEditing" class="min-h-[200px] flex flex-col">
        <QuillEditor 
          content={content}
          id="edit-note-content"
          name="editContent"
          placeholder="Start writing your note..."
          minimalToolbar={false}
        />
        
        <!-- Save/Cancel buttons -->
        <div class="flex gap-2 mt-4 justify-end">
          <button 
            @click="cancelEdit()"
            class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            :disabled="isSaving"
          >
            Cancel
          </button>
          <button 
            @click="saveChanges()"
            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            :disabled="isSaving"
          >
            <span x-show="!isSaving">Save</span>
            <span x-show="isSaving">Saving...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Maximum specificity to override computedStyle: none */
  [data-card-full-editable] div[x-show="!isEditing"].ql-editor ul {
    list-style-type: disc !important;
    padding-left: 1.5em !important;
    margin-left: 0 !important;
  }

  [data-card-full-editable] div[x-show="!isEditing"].ql-editor ol {
    list-style-type: decimal !important;
    padding-left: 1.5em !important;
    margin-left: 0 !important;
  }

  [data-card-full-editable] div[x-show="!isEditing"].ql-editor li {
    margin-bottom: 0.5em !important;
    color: var(--color-deep-grey) !important;
    display: list-item !important;
    list-style-position: outside !important;
    list-style-type: inherit !important;
  }
  
  /* Even more specific targeting */
  div[data-card-full-editable] div[x-show="!isEditing"].ql-editor ul {
    list-style-type: disc !important;
  }
  
  div[data-card-full-editable] div[x-show="!isEditing"].ql-editor ol {
    list-style-type: decimal !important;
  }
  
  div[data-card-full-editable] div[x-show="!isEditing"].ql-editor li {
    list-style-type: inherit !important;
  }
  
  /* CardFullEditable specific styling */
  [data-card-full-editable] .ql-editor {
    font-family: var(--font-sans) !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: var(--color-deep-grey) !important;
  }
  
  /* Hide duplicate toolbars in CardFullEditable */
  [data-card-full-editable] .ql-toolbar:not(:first-child) {
    display: none !important;
  }
</style>

<script define:vars={{ title, content }}>
  // Function to fix Quill v2 list rendering issues (client-side version)
  function fixQuillV2Lists(htmlContent) {
    if (!htmlContent) return '';
    
    // Quill v2 adds problematic spans inside list items
    // Remove these spans that interfere with list display
    let fixedContent = htmlContent
      // Remove Quill v2's ql-ui spans that break list rendering
      .replace(/<span class="ql-ui" contenteditable="false">[\s\S]*?<\/span>/gi, '')
      // Fix Quill v2's mixed list structure - convert ol with bullet items to ul
      .replace(/<ol[^>]*>([\s\S]*?)<\/ol>/gi, (match, content) => {
        // Check if any li has data-list="bullet"
        if (content.includes('data-list="bullet"')) {
          return `<ul style="list-style-type: disc !important; padding-left: 0.5em !important; margin-left: 0.5em !important;">${content}</ul>`;
        } else {
          return `<ol style="list-style-type: decimal !important; padding-left: 0.5em !important; margin-left: 0.5em !important;">${content}</ol>`;
        }
      })
      // Clean up li attributes and add styling
      .replace(/<li[^>]*>/gi, '<li style="display: list-item !important; list-style-position: outside !important; margin-left: 0 !important; padding-left: 0.2em !important;">')
      // Handle regular ul tags
      .replace(/<ul[^>]*>/gi, '<ul style="list-style-type: disc !important; padding-left: 0.5em !important; margin-left: 0.5em !important;">');
    
    return fixedContent;
  }
  
  // Define functions immediately to avoid timing issues
  function setupCardFullEditable() {
    const cardElement = document.querySelector('[data-card-full-editable]');
    if (cardElement) {
      const alpineData = window.Alpine?.$data(cardElement);
      if (alpineData) {
        // Get the onSave callback from the global variable
        const onSave = window.noteSaveCallback || noteSaveCallback;
        alpineData.onSaveCallback = onSave;
        
        // Set the title and content from the component props
        alpineData.editTitle = title || '';
        alpineData.editContent = content || '';
        alpineData.originalTitle = title || '';
        alpineData.originalContent = content || '';
        alpineData.displayTitle = title || '';
        alpineData.displayContent = content || '';
        
        console.log('CardFullEditable initialized with:', {
          title: title,
          content: content,
          displayTitle: alpineData.displayTitle,
          displayContent: alpineData.displayContent
        });
        
        // Fallback: ensure content is displayed even if Alpine.js data isn't working
        const contentDisplay = cardElement.querySelector('div[x-show="!isEditing"]');
        if (contentDisplay && content && !contentDisplay.innerHTML.trim()) {
          const fixedContent = fixQuillV2Lists(content);
          contentDisplay.innerHTML = fixedContent;
        }
        
        // Apply list styling with JavaScript
        if (contentDisplay) {
          const lists = contentDisplay.querySelectorAll('ul, ol');
          lists.forEach((list) => {
            if (list.tagName === 'UL') {
              list.style.setProperty('list-style-type', 'disc', 'important');
              list.style.setProperty('padding-left', '1.5em', 'important');
            } else if (list.tagName === 'OL') {
              list.style.setProperty('list-style-type', 'decimal', 'important');
              list.style.setProperty('padding-left', '1.5em', 'important');
            }
          });
          
          const listItems = contentDisplay.querySelectorAll('li');
          listItems.forEach((item) => {
            item.style.setProperty('display', 'list-item', 'important');
            item.style.setProperty('list-style-position', 'outside', 'important');
            item.style.setProperty('list-style-type', 'inherit', 'important');
          });
        }
        
        // Define saveChanges function and attach it to Alpine data
        alpineData.saveChanges = async function() {
          this.isSaving = true;
          
          try {
            // Get content from QuillEditor
            let content = '';
            const quillContainer = document.querySelector('#static-quill-container-edit-note-content');
            const hiddenInput = document.querySelector('#edit-note-content');
            
            // Try to get content from hidden input first (most reliable)
            if (hiddenInput && hiddenInput.value) {
              content = hiddenInput.value;
            }
            
            // Fallback to Quill Editor
            if (!content && quillContainer && quillContainer.__quill) {
              try {
                content = quillContainer.__quill.root.innerHTML;
              } catch (error) {
                console.error('Error getting content from Quill Editor:', error);
              }
            }
            
            // Fallback to Alpine data
            if (!content && this.editContent) {
              content = this.editContent;
            }
            
            if (!content.trim()) {
              alert('Please add some content to your note');
              this.isSaving = false;
              return;
            }
            
            // Call the onSave callback if provided
            if (this.onSaveCallback && typeof this.onSaveCallback === 'function') {
              const result = await this.onSaveCallback(this.editTitle, content);
            } else {
              console.error('CardFullEditable: onSaveCallback is not a function!', this.onSaveCallback);
            }
            
            // Update original values
            this.originalTitle = this.editTitle;
            this.originalContent = content;
            this.isEditing = false;
            
            // Update display content directly in DOM
            const titleDisplay = cardElement.querySelector('p[x-show="!isEditing"]');
            const contentDisplay = cardElement.querySelector('div[x-show="!isEditing"]');
            
            if (titleDisplay) {
              titleDisplay.textContent = this.editTitle;
            }
            
            if (contentDisplay) {
              const fixedContent = fixQuillV2Lists(content);
              contentDisplay.innerHTML = fixedContent;
              
              // Re-apply JavaScript styling to the updated content
              setTimeout(() => {
                const lists = contentDisplay.querySelectorAll('ul, ol');
                lists.forEach((list) => {
                  if (list.tagName === 'UL') {
                    list.style.setProperty('list-style-type', 'disc', 'important');
                    list.style.setProperty('padding-left', '0.5em', 'important');
                    list.style.setProperty('margin-left', '0.5em', 'important');
                  } else if (list.tagName === 'OL') {
                    list.style.setProperty('list-style-type', 'decimal', 'important');
                    list.style.setProperty('padding-left', '0.5em', 'important');
                    list.style.setProperty('margin-left', '0.5em', 'important');
                  }
                });
                
                const listItems = contentDisplay.querySelectorAll('li');
                listItems.forEach((item) => {
                  item.style.setProperty('display', 'list-item', 'important');
                  item.style.setProperty('list-style-position', 'outside', 'important');
                  item.style.setProperty('list-style-type', 'inherit', 'important');
                  item.style.setProperty('margin-left', '0', 'important');
                  item.style.setProperty('padding-left', '0.2em', 'important');
                });
                
              }, 10);
            }
            
            // Show success message
            window.dispatchEvent(new CustomEvent('toast', {
              detail: {
                message: 'Note updated successfully!',
                type: 'success'
              }
            }));
            
          } catch (error) {
            console.error('Error saving note:', error);
            window.dispatchEvent(new CustomEvent('toast', {
              detail: {
                message: 'Error saving note. Please try again.',
                type: 'error'
              }
            }));
          } finally {
            this.isSaving = false;
          }
        };
        
        // Define cancelEdit function
        alpineData.cancelEdit = function() {
          this.editTitle = this.originalTitle;
          this.editContent = this.originalContent;
          this.isEditing = false;
          this.hasChanges = false;
        };
        
      }
    }
  }
  
  // Try to setup immediately
  setupCardFullEditable();
  
  // Also try on DOM ready
  document.addEventListener('DOMContentLoaded', setupCardFullEditable);
  
  // Try after delays to ensure Alpine.js is ready
  setTimeout(setupCardFullEditable, 100);
  setTimeout(setupCardFullEditable, 500);
</script>