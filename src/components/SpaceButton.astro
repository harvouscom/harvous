---
import FaAngleDownIcon from "@fortawesome/fontawesome-free/svgs/solid/angle-down.svg";
import FaXmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
import FaAngleRightIcon from "@fortawesome/fontawesome-free/svgs/solid/angle-right.svg";

interface Props {
    className?: string;
    text?: string;
    count?: number;
    state?: "Default" | "Dropdown" | "WithCount" | "DropdownTrigger" | "Close" | "WithArrow" | "TagClose";
    showCount?: boolean;
    backgroundGradient?: string;
    isActive?: boolean;
    itemId?: string;
}

const { 
    className = "", 
    text = "For You", 
    count = 1, 
    state = "Default",
    showCount = false,
    backgroundGradient = "var(--color-gradient-gray)",
    isActive = true,
    itemId,
    ...props 
} = Astro.props;
---

{state === "Default" ? (
    <button 
        class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 px-4 ${className}`}
        style={isActive ? `background-image: ${backgroundGradient};` : ''}
        {...props}
    >
        <div class="flex items-center justify-start relative w-full h-full pl-2 pr-2 transition-transform duration-125">
            <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                {text}
            </span>
        </div>
    </button>
) : state === "WithCount" ? (
    <button 
        class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 ${className}`}
        style={isActive ? `background-image: ${backgroundGradient};` : ''}
        {...props}
    >
        <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
            <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                {text}
            </span>
            <div class="p-[20px]">
                <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                        {count}
                    </span>
                </div>
            </div>
        </div>
    </button>
) : state === "DropdownTrigger" ? (
    <button 
        class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 ${className}`}
        style={isActive ? `background-image: ${backgroundGradient};` : ''}
        {...props}
    >
        <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
            <div class="flex items-center gap-3">
                <slot name="text">
                    <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                        {text}
                    </span>
                </slot>
                {count !== undefined && count !== null && (
                    <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                        <slot name="count">
                            <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                                {count}
                            </span>
                        </slot>
                    </div>
                )}
            </div>
            <div class="flex items-center justify-center relative shrink-0">
                <div class="flex-none scale-y-[-100%]">
                    <div class="box-border content-stretch flex gap-2.5 items-center justify-start p-[12px] relative">
                        <div class="flex items-center justify-center relative shrink-0">
                            <div class="flex-none scale-y-[-100%]">
                                <div class="relative size-5">
                                    <FaAngleDownIcon class="fill-[var(--color-deep-grey)] block max-w-none w-full h-full transition-transform duration-125" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </button>
) : state === "Dropdown" ? (
    <button 
        class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 ${className}`}
        style={isActive ? `background-image: ${backgroundGradient};` : ''}
        {...props}
    >
        <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
            <div class="flex items-center gap-3">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                    {text}
                </span>
                <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                        {count}
                    </span>
                </div>
            </div>
            <div class="flex items-center justify-center relative shrink-0">
                <div class="flex-none scale-y-[-100%]">
                    <div class="box-border content-stretch flex gap-2.5 items-center justify-start p-[12px] relative">
                        <div class="flex items-center justify-center relative shrink-0">
                            <div class="flex-none scale-y-[-100%]">
                                <div class="relative size-5">
                                    <FaAngleDownIcon class="fill-[var(--color-deep-grey)] block max-w-none w-full h-full transition-transform duration-125" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </button>
) : state === "Close" ? (
        <div class={`relative nav-item-container ${isActive ? 'active' : ''}`}>
            <button
                class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group ${className}`}
                style={isActive ? `background-image: ${backgroundGradient};` : ''}
                {...props}
            >
            <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                    {text}
                </span>
                <!-- Right box - simple flex container for badge -->
                <div class="flex items-center justify-center p-[20px]">
                    <!-- Badge count - show when not hovering -->
                    <div class="badge-count bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                        <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                            {count}
                        </span>
                    </div>
                </div>
            </div>
            </button>
            <!-- Close icon - only show for inactive items -->
            {!isActive && (
            <div
                onclick="handleCloseClick(event, this)"
                class="close-icon absolute top-1/2 right-5 transform -translate-y-1/2 flex items-center justify-center w-6 h-6 cursor-pointer"
                data-item-id={itemId}
            >
                <svg class="w-4 h-4 fill-current" style="color: var(--color-deep-grey);" viewBox="0 0 384 512">
                    <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                </svg>
            </div>
            )}
        </div>
) : state === "TagClose" ? (
    <div class={`relative nav-item-container ${isActive ? 'active' : ''}`}>
        <button
            class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group ${className}`}
            style={isActive ? `background-image: ${backgroundGradient};` : ''}
            {...props}
        >
        <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
            <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                {text}
            </span>
        </div>
        </button>
        <!-- Close icon - always visible for tags -->
        <div
            onclick="handleCloseClick(event, this)"
            class="close-icon absolute top-1/2 right-5 transform -translate-y-1/2 flex items-center justify-center w-6 h-6 cursor-pointer"
            data-item-id={itemId}
        >
            <svg class="w-4 h-4 fill-current" style="color: var(--color-deep-grey);" viewBox="0 0 384 512">
                <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
            </svg>
        </div>
    </div>
) : state === "WithArrow" ? (
    <button 
        class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 ${className}`}
        style={isActive ? `background-image: ${backgroundGradient};` : ''}
        {...props}
    >
        <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
            <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                {text}
            </span>
            <div class="flex items-center justify-center relative shrink-0">
                <div class="box-border content-stretch flex gap-2.5 items-center justify-start p-[12px] relative">
                    <div class="flex items-center justify-center relative shrink-0">
                        <div class="relative size-5">
                            <FaAngleRightIcon class="fill-[var(--color-deep-grey)] block max-w-none w-full h-full transition-transform duration-125" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </button>
) : (
    <button 
        class={`space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 ${className}`}
        style={isActive ? `background-image: ${backgroundGradient};` : ''}
        {...props}
    >
        <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
            <div class="flex items-center gap-3">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                    {text}
                </span>
                <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                        {count}
                    </span>
                </div>
            </div>
            <div class="flex items-center justify-center relative shrink-0">
                <div class="flex-none scale-y-[-100%]">
                    <div class="box-border content-stretch flex gap-2.5 items-center justify-start p-[12px] relative">
                        <div class="flex items-center justify-center relative shrink-0">
                            <div class="flex-none scale-y-[-100%]">
                                <div class="relative size-5">
                                    <FaAngleDownIcon class="fill-[var(--color-deep-grey)] block max-w-none w-full h-full transition-transform duration-125" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </button>
)}

<style>
    button {
        will-change: transform;
        transition:
            box-shadow 0.125s ease-in-out;
    }

    button[style*="background-image"] {
        box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
    }

    button:not([data-outer-shadow]):active {
        filter: brightness(0.97);
        box-shadow: 
            0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
            0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
    }

    /* Add text and icon animations similar to Button.astro and SquareButton.astro */
    button:active > div {
        translate: 0 0;
        transform: scale(0.98);
    }

    button:active svg {
        transform: scale(0.95);
    }

    /* Close icon hover states - only for inactive items */
    .nav-item-container:not(.active):hover .badge-count {
        display: none !important;
    }
    .nav-item-container:not(.active):hover .close-icon {
        display: flex !important;
    }
    .close-icon {
        display: none;
    }
    
    /* TagClose variant - always show close icon, no badge count */
    .nav-item-container .close-icon[data-item-id] {
        display: flex !important;
    }
</style>

<script>
    import { navigate } from 'astro:transitions/client';
    
    // Provide Astro's navigate function to the global scope for the close functionality
    (window as any).astroNavigate = navigate;
    
    // Close click handler with confirmation for spaces
    function handleCloseClick(event: Event, element: HTMLElement) {
        console.log('üî• handleCloseClick called');
        event.stopPropagation();
        event.preventDefault();
        
        const itemId = element.getAttribute('data-item-id');
        console.log('üî• Close clicked for item:', itemId);
        
        if (!itemId) {
            console.log('‚ùå No item ID found');
            return;
        }
        
        // Check if this is a tag (in NoteDetailsPanel)
        const isTag = element.closest('.note-details-panel') || element.closest('.tag-item');
        
        if (isTag) {
            // Handle tag removal
            if ((window as any).removeTagFromNote) {
                console.log('üî• Removing tag from note');
                (window as any).removeTagFromNote(event, element);
            } else {
                console.log('‚ùå removeTagFromNote function not available');
            }
            return;
        }
        
        // Check if this is a space (spaces can't be recovered once closed)
        if (itemId.startsWith('space_')) {
            // Get the space title from the button
            const button = element.closest('.space-button');
            const spaceTitle = button?.querySelector('span')?.textContent || 'this space';
            
            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to close "${spaceTitle}"?\n\nThis will remove it from your navigation and you won't be able to bring it back.`);
            
            if (!confirmed) {
                return; // User cancelled
            }
        }
        
        // Check if this is a recent search item (on search page)
        const isRecentSearch = window.location.pathname === '/search' && 
                              element.closest('.recent-search-item');
        
        if (isRecentSearch) {
            // Remove from recent searches
            if ((window as any).removeFromRecentSearches) {
                console.log('üî• Removing from recent searches');
                (window as any).removeFromRecentSearches(itemId);
            } else {
                console.log('‚ùå removeFromRecentSearches function not available');
            }
        } else {
            // Remove from navigation history
            if ((window as any).removeFromNavigationHistory) {
                console.log('üî• Removing from navigation history');
                (window as any).removeFromNavigationHistory(itemId);
            } else {
                console.log('‚ùå removeFromNavigationHistory function not available');
            }
            
            // For regular navigation items, navigate to dashboard
            if ((window as any).astroNavigate) {
                console.log('üî• Navigating to dashboard with astroNavigate');
                (window as any).astroNavigate('/dashboard');
            } else {
                console.log('üî• Navigating to dashboard with location.replace');
                window.location.replace('/dashboard');
            }
        }
    }
    
    // Make function globally available
    (window as any).handleCloseClick = handleCloseClick;
</script>

