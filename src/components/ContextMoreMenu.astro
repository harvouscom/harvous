---
import EditIcon from "@fortawesome/fontawesome-free/svgs/solid/pen-to-square.svg";
import EraseIcon from "@fortawesome/fontawesome-free/svgs/solid/eraser.svg";
import CircleInfoIcon from "@fortawesome/fontawesome-free/svgs/solid/circle-info.svg";
import { getMenuOptions } from "@/utils/menu-options";

export interface Props {
  contentType: "thread" | "note" | "space" | "dashboard" | "profile";
  contentId?: string;
}

const { contentType = "dashboard", contentId } = Astro.props;

// Get menu options using the utility function
const menuOptionsData = getMenuOptions(contentType);

// Add icons to the menu options
const menuOptions = menuOptionsData.map(option => {
  let icon;
  switch (option.action) {
    case "editThread":
    case "editSpace":
      icon = EditIcon;
      break;
    case "eraseThread":
    case "eraseNote":
    case "eraseSpace":
      icon = EraseIcon;
      break;
    case "seeDetails":
      icon = CircleInfoIcon;
      break;
    default:
      icon = EditIcon;
  }
  return { ...option, icon };
});
---

{menuOptions.length > 0 && (
  <div 
    class="context-more-menu bg-white rounded-xl shadow-[0px_3px_20px_0px_rgba(120,118,111,0.1)] overflow-hidden"
    x-data={`{
      contentType: '${contentType}',
      contentId: '${contentId || ''}',
      showConfirmDialog: false,
      pendingAction: null,
      
      async handleAction(action, label) {
        console.log('ContextMoreMenu:', label, 'button clicked');
        
        // Close the menu when any option is selected
        const parentContainer = this.$el.closest('.square-button-container');
        if (parentContainer && parentContainer.__x) {
          parentContainer.__x.$data.isOpen = false;
        }
        
        // Handle delete actions
        if (action.includes('erase')) {
          if (!this.contentId) {
            console.error('No content ID provided for delete action');
            return;
          }
          
          // Show custom confirmation dialog
          this.pendingAction = action;
          this.showConfirmDialog = true;
          return;
        }
        
        // Handle other actions
        await this.executeAction(action, label);
      },
      
      async executeAction(action, label) {
        if (action.includes('erase')) {
          await this.performErase();
        } else if (action === 'seeDetails') {
          // Handle See Details action for notes
          try {
            window.dispatchEvent(new CustomEvent('openNoteDetailsPanel', {
              detail: { contentId: this.contentId, contentType: this.contentType }
            }));
          } catch (error) {
            console.error('Error opening note details panel:', error);
          }
        } else {
          // Handle other actions (like edit)
          console.log('Other action:', action);
        }
      },
      
      async performErase() {
          
          // Determine the API endpoint and parameter name
          let apiUrl, paramName, successMessage;
          switch (this.contentType) {
            case 'thread':
              apiUrl = '/api/threads/delete';
              paramName = 'threadId';
              successMessage = 'Thread erased successfully!';
              break;
            case 'note':
              apiUrl = '/api/notes/delete';
              paramName = 'noteId';
              successMessage = 'Note erased successfully!';
              break;
            case 'space':
              apiUrl = '/api/spaces/delete';
              paramName = 'spaceId';
              successMessage = 'Space erased successfully!';
              break;
            default:
              console.error('Unknown content type for delete:', this.contentType);
              return;
          }
          
          try {
            // Make the delete request
            const response = await fetch(\`\${apiUrl}?\${paramName}=\${encodeURIComponent(this.contentId)}\`, {
              method: 'DELETE',
              headers: {
                'Content-Type': 'application/json'
              }
            });
            
            const data = await response.json();
            
            if (data.success) {
              // Dispatch appropriate deletion event for navigation updates
              if (this.contentType === 'thread') {
                window.dispatchEvent(new CustomEvent('threadDeleted', {
                  detail: { threadId: this.contentId }
                }));
              } else if (this.contentType === 'note') {
                window.dispatchEvent(new CustomEvent('noteDeleted', {
                  detail: { noteId: this.contentId }
                }));
              } else if (this.contentType === 'space') {
                window.dispatchEvent(new CustomEvent('spaceDeleted', {
                  detail: { spaceId: this.contentId }
                }));
              }
              
              // Redirect to dashboard with toast parameters (like create operations)
              const redirectUrl = '/dashboard?toast=success&message=' + encodeURIComponent(successMessage);
              window.location.href = redirectUrl;
            } else {
              // Show error toast immediately (no redirect on error)
              if (window.toast) {
                window.toast.error(data.error || 'Failed to erase item');
              }
            }
          } catch (error) {
            console.error('Error deleting item:', error);
            if (window.toast) {
              window.toast.error('Failed to erase item');
            }
          }
        },
        
        confirmErase() {
          this.showConfirmDialog = false;
          this.executeAction(this.pendingAction, 'erase');
        },
        
        cancelErase() {
          this.showConfirmDialog = false;
          this.pendingAction = null;
        }
    }`}
  >
    {menuOptions.map((option, index) => (
      <button 
        x-on:click={`handleAction('${option.action}', '${option.label}')`}
        class="context-more-menu-item flex items-center gap-3 py-[18px] px-4 pb-5 hover:bg-gray-50 transition-colors duration-150 cursor-pointer w-full text-left"
      >
        <div class="relative shrink-0 w-5 h-5 flex items-center justify-center">
          <option.icon class="fill-[var(--color-deep-grey)] block max-w-none w-full h-full" />
        </div>
        <span class="text-subtitle text-[var(--color-deep-grey)] whitespace-nowrap">
          {option.label}
        </span>
      </button>
    ))}
    
    <!-- Confirmation Dialog -->
    <div x-show="showConfirmDialog" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-lg">
        <h3 class="text-lg font-semibold text-[var(--color-deep-grey)] mb-2">
          Are you sure?
        </h3>
        <p class="text-[var(--color-pebble-grey)] mb-6" x-text="`Are you sure you want to erase this ${contentType}?`">
        </p>
        <div class="flex gap-3 justify-end">
          <button
            type="button"
            x-on:click="cancelErase()"
            class="px-4 py-2 text-[var(--color-deep-grey)] hover:bg-gray-100 rounded-lg transition-colors"
          >
            Cancel
          </button>
          <button
            type="button"
            x-on:click="confirmErase()"
            class="px-4 py-2 bg-[var(--color-red)] text-white rounded-lg hover:bg-opacity-90 transition-colors"
          >
            Erase
          </button>
        </div>
      </div>
    </div>
  </div>
)}

<style>
  .context-more-menu {
    min-width: 223px;
  }
  
  .context-more-menu-item {
    border: none !important;
    outline: none !important;
  }
  
  .context-more-menu-item:first-child {
    border-radius: 12px 12px 0 0;
  }
  
  .context-more-menu-item:last-child {
    border-radius: 0 0 12px 12px;
  }
  
  .context-more-menu-item:only-child {
    border-radius: 12px;
  }
</style>
