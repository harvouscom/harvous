---
interface Props {
  content: string;
  id?: string;
  name?: string;
  placeholder?: string;
}

const { 
  content, 
  id = "content", 
  name = "content", 
  placeholder = "Write something..."
} = Astro.props;
---

<!-- Load Quill CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

<div id="static-quill-editor" class="relative h-full">
  <input id={id} name={name} value={content} type="hidden" />
  
  <!-- Quill Editor Container -->
  <div 
    id={`static-quill-container-${id}`}
    class="quill-content h-full"
    style="min-height: 200px; border: 1px solid #ccc; background: white;"
  ></div>
</div>

<style>
  #static-quill-editor {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  #static-quill-editor .quill-content {
    resize: none;
    background: var(--color-fog-white);
    border-radius: 0.75rem;
    border: none;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 200px;
    overflow-y: auto;
  }
  
  /* Force toolbar to bottom using CSS Grid */
  #static-quill-editor {
    display: grid !important;
    grid-template-rows: 1fr auto !important;
    grid-template-areas: "editor" "toolbar" !important;
  }
  
  #static-quill-editor .ql-container {
    grid-area: editor !important;
    order: 1 !important;
  }
  
  #static-quill-editor .ql-toolbar {
    grid-area: toolbar !important;
    order: 2 !important;
    border-top: 1px solid #ccc !important;
    border-bottom: none !important;
    margin-top: 0.5rem !important;
  }

  /* Quill Editor Styling - Match note content styling */
  #static-quill-editor .ql-editor {
    font-family: var(--font-sans) !important;
    font-weight: normal;
    font-size: 16px;
    color: var(--color-deep-grey);
    line-height: 1.6;
    border: none !important;
    border-radius: 0;
    padding: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
    min-height: 200px;
  }
  
  /* Remove gray background on hover/focus */
  #static-quill-editor .ql-editor:hover,
  #static-quill-editor .ql-editor:focus,
  #static-quill-editor .ql-editor:focus-within {
    background: transparent !important;
    outline: none !important;
  }
  
  /* Remove any Quill default hover effects */
  #static-quill-editor .ql-container:hover .ql-editor {
    background: transparent !important;
  }
  
  /* Force Reddit Sans on all Quill content */
  #static-quill-editor .ql-editor * {
    font-family: var(--font-sans) !important;
  }
  
  /* Override Quill's default font styles */
  #static-quill-editor .ql-editor p,
  #static-quill-editor .ql-editor div,
  #static-quill-editor .ql-editor span,
  #static-quill-editor .ql-editor strong,
  #static-quill-editor .ql-editor em,
  #static-quill-editor .ql-editor u {
    font-family: var(--font-sans) !important;
  }
  
  /* Custom prose-like styling to match note content */
  #static-quill-editor .ql-editor {
    max-width: none;
  }
  
  /* Ensure paragraphs have proper spacing like note content */
  #static-quill-editor .ql-editor p {
    margin-bottom: 0 !important;
  }
  
  #static-quill-editor .ql-editor p:not(:last-child) {
    margin-bottom: 1rem !important;
  }

  #static-quill-editor .ql-editor.ql-blank::before {
    color: var(--color-pebble-grey);
    font-style: italic;
    content: attr(data-placeholder);
  }

  /* Quill Toolbar Styling */
  #static-quill-editor .ql-toolbar {
    border: none;
    background: transparent;
    padding: 0.5rem 0.75rem;
    order: 2; /* Ensure toolbar comes after editor */
  }
  

  #static-quill-editor .ql-toolbar .ql-formats {
    margin-right: 1rem;
  }

  #static-quill-editor .ql-toolbar button {
    color: var(--color-deep-grey);
    transition: color 0.2s;
  }

  #static-quill-editor .ql-toolbar button:hover {
    color: var(--color-stone-grey);
    background: var(--color-fog-white);
    border-radius: 0.25rem;
  }

  #static-quill-editor .ql-toolbar button.ql-active {
    color: var(--color-deep-grey);
    background: var(--color-fog-white);
  }

  /* Hide duplicate toolbars - more aggressive */
  #static-quill-editor .ql-toolbar:not(:first-child) {
    display: none !important;
  }
  
  /* Global rule to hide any duplicate Quill toolbars */
  .ql-toolbar:not(:first-child) {
    display: none !important;
  }
  
  /* Force Reddit Sans on all Quill editors - more aggressive */
  #static-quill-editor .ql-editor,
  #static-quill-editor .ql-editor *,
  #static-quill-editor .ql-editor p,
  #static-quill-editor .ql-editor div,
  #static-quill-editor .ql-editor span,
  #static-quill-editor .ql-editor strong,
  #static-quill-editor .ql-editor em,
  #static-quill-editor .ql-editor u,
  #static-quill-editor .ql-editor ol,
  #static-quill-editor .ql-editor ul,
  #static-quill-editor .ql-editor li {
    font-family: var(--font-sans) !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: var(--color-deep-grey) !important;
  }
  
  /* Global rule to force Reddit Sans on all Quill editors */
  .ql-editor,
  .ql-editor * {
    font-family: var(--font-sans) !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: var(--color-deep-grey) !important;
  }
  
  /* Global rules to remove gray backgrounds on hover/focus */
  .ql-editor:hover,
  .ql-editor:focus,
  .ql-editor:focus-within,
  .ql-container:hover .ql-editor {
    background: transparent !important;
    outline: none !important;
  }
  
</style>

<script define:vars={{ id, placeholder, content }}>
  // Simplified and more reliable QuillEditor initialization
  function initializeQuillEditor() {
    const quillContainer = document.querySelector(`#static-quill-container-${id}`);
    const hiddenInput = document.querySelector(`#${id}`);
    
    console.log(`QuillEditor ${id} initialization attempt:`, {
      quillContainer: !!quillContainer,
      hiddenInput: !!hiddenInput,
      windowQuill: !!window.Quill,
      alreadyInitialized: !!(quillContainer && quillContainer.__quill)
    });
    
    // Check if already initialized
    if (!quillContainer || !hiddenInput || !window.Quill || quillContainer.__quill) {
      return;
    }
    
    // Clear container to prevent duplicate toolbars
    quillContainer.innerHTML = '';
    
    // Initialize Quill with standard configuration
    const quillInstance = new window.Quill(quillContainer, {
      theme: 'snow',
      placeholder: placeholder,
      modules: {
        toolbar: [
          ['bold', 'italic', 'underline'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          ['clean']
        ]
      }
    });
    
    // Move toolbar to bottom after Quill is fully initialized
    setTimeout(() => {
      const toolbar = quillContainer.querySelector('.ql-toolbar');
      const editor = quillContainer.querySelector('.ql-editor');
      if (toolbar && editor) {
        // Remove toolbar from its current position
        toolbar.remove();
        // Insert toolbar after the editor container
        editor.parentNode.insertBefore(toolbar, editor.nextSibling);
        console.log(`QuillEditor ${id} - toolbar moved to bottom`);
      }
    }, 100);
    
    console.log(`QuillEditor ${id} initialized successfully`);
    
    // Store reference to prevent re-initialization
    quillContainer.__quill = quillInstance;
    
    // Set initial content if provided
    if (content && content.trim()) {
      quillInstance.root.innerHTML = content;
      hiddenInput.value = content;
    }
    
    // Update hidden input when content changes
    quillInstance.on('text-change', () => {
      const htmlContent = quillInstance.root.innerHTML;
      hiddenInput.value = htmlContent;
    });
    
    // Apply consistent font styling once
    const fontFamily = getComputedStyle(document.documentElement).getPropertyValue('--font-sans').trim();
    const targetFont = fontFamily || '"Reddit Sans", system-ui, -apple-system, sans-serif';
    
    // Apply styling to editor root
    quillInstance.root.style.fontFamily = targetFont;
    quillInstance.root.style.fontSize = '16px';
    quillInstance.root.style.lineHeight = '1.6';
    quillInstance.root.style.color = 'var(--color-deep-grey)';
    
    console.log(`QuillEditor ${id} initialized successfully`);
  }
  
  // Multiple initialization attempts for reliability
  function tryInitialize() {
    const quillContainer = document.querySelector(`#static-quill-container-${id}`);
    const hiddenInput = document.querySelector(`#${id}`);
    
    if (quillContainer && hiddenInput && window.Quill && !quillContainer.__quill) {
      initializeQuillEditor();
      return true;
    }
    return false;
  }
  
  // Try immediately
  if (!tryInitialize()) {
    // Try on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInitialize);
    }
    
    // Try with delays
    setTimeout(tryInitialize, 100);
    setTimeout(tryInitialize, 300);
    setTimeout(tryInitialize, 500);
    setTimeout(tryInitialize, 1000);
    
    // Final fallback on window load
    window.addEventListener('load', tryInitialize);
  }
  
  // Listen for Astro View Transitions events
  document.addEventListener('astro:after-swap', () => {
    console.log(`QuillEditor ${id} - astro:after-swap event, attempting initialization`);
    setTimeout(tryInitialize, 50);
    setTimeout(tryInitialize, 200);
    setTimeout(tryInitialize, 500);
  });
  
  document.addEventListener('astro:page-load', () => {
    console.log(`QuillEditor ${id} - astro:page-load event, attempting initialization`);
    setTimeout(tryInitialize, 50);
    setTimeout(tryInitialize, 200);
  });
</script>
