---
import FaBoldIcon from "@fortawesome/fontawesome-free/svgs/solid/bold.svg";
import FaItalicIcon from "@fortawesome/fontawesome-free/svgs/solid/italic.svg";
import FaUnderlineIcon from "@fortawesome/fontawesome-free/svgs/solid/underline.svg";
import FaListIcon from "@fortawesome/fontawesome-free/svgs/solid/list.svg";
import FaListOlIcon from "@fortawesome/fontawesome-free/svgs/solid/list-ol.svg";
import FaEraserIcon from "@fortawesome/fontawesome-free/svgs/solid/eraser.svg";

interface Props {
  content: string;
  id?: string;
  name?: string;
  placeholder?: string;
  minimalToolbar?: boolean;
  tabindex?: number;
}

const { 
  content, 
  id = "content", 
  name = "content", 
  placeholder = "Write something...",
  minimalToolbar = false,
  tabindex
} = Astro.props;
---

<!-- Load Quill CSS and JS - Using snow theme with aggressive overrides -->
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<!-- Load Font Awesome for custom icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" />

<!-- Force Font Awesome icon colors with maximum specificity -->
<style>
  .ql-toolbar .fa-solid,
  .ql-toolbar.ql-snow .fa-solid,
  div.ql-toolbar .fa-solid,
  div.ql-toolbar.ql-snow .fa-solid,
  .ql-toolbar i,
  .ql-toolbar.ql-snow i,
  div.ql-toolbar i,
  div.ql-toolbar.ql-snow i,
  .ql-toolbar button i,
  .ql-toolbar.ql-snow button i,
  div.ql-toolbar button i,
  div.ql-toolbar.ql-snow button i {
    color: #8B8B8B !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
  .ql-toolbar button:hover .fa-solid,
  .ql-toolbar.ql-snow button:hover .fa-solid,
  div.ql-toolbar button:hover .fa-solid,
  div.ql-toolbar.ql-snow button:hover .fa-solid,
  .ql-toolbar button:hover i,
  .ql-toolbar.ql-snow button:hover i,
  div.ql-toolbar button:hover i,
  div.ql-toolbar.ql-snow button:hover i {
    color: #4A4A4A !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
  .ql-toolbar button.ql-active .fa-solid,
  .ql-toolbar.ql-snow button.ql-active .fa-solid,
  div.ql-toolbar button.ql-active .fa-solid,
  div.ql-toolbar.ql-snow button.ql-active .fa-solid,
  .ql-toolbar button.ql-active i,
  .ql-toolbar.ql-snow button.ql-active i,
  div.ql-toolbar button.ql-active i,
  div.ql-toolbar.ql-snow button.ql-active i {
    color: #4A4A4A !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
  
  /* Nuclear option - target everything in toolbar */
  .ql-toolbar * {
    color: #8B8B8B !important;
  }
  .ql-toolbar button:hover * {
    color: #4A4A4A !important;
  }
  .ql-toolbar button.ql-active * {
    color: #4A4A4A !important;
  }
  
  /* Nuclear option for icon sizing */
  .ql-toolbar i,
  .ql-toolbar .fa-solid {
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
</style>

<!-- Custom SpaceButton-styled toolbar for Quill snow theme -->
<style>
  /* Quill Snow Theme - SpaceButton Styling Override */
  .ql-toolbar,
  .ql-toolbar.ql-snow,
  #static-quill-editor .ql-toolbar,
  #static-quill-editor .ql-toolbar.ql-snow {
    border: none !important;
    border-color: transparent !important;
    background: transparent !important;
    display: flex !important;
    gap: 0.5rem !important;
    align-items: center !important;
    padding: 0.5rem 0 !important;
    margin: 0 !important;
  }
  
  .ql-toolbar .ql-formats {
    display: flex !important;
    gap: 0.5rem !important;
    margin-right: 0 !important;
  }
  
  .ql-toolbar button,
  #static-quill-editor .ql-toolbar button {
    color: var(--color-deep-grey) !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0.75rem !important;
    padding: 0.5rem 0.75rem !important;
    margin: 0 !important;
    font-family: var(--font-sans) !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.125s ease-in-out !important;
    will-change: transform !important;
    min-height: 2rem !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    box-shadow: none !important;
  }
  
  .ql-toolbar button:hover,
  #static-quill-editor .ql-toolbar button:hover {
    background: var(--color-fog-white) !important;
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset !important;
  }
  
  .ql-toolbar button.ql-active,
  #static-quill-editor .ql-toolbar button.ql-active {
    background: var(--color-fog-white) !important;
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset !important;
  }
  
  .ql-toolbar button:active,
  #static-quill-editor .ql-toolbar button:active {
    filter: brightness(0.97) !important;
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset !important;
    transform: scale(0.98) !important;
  }
  
  /* Quill Editor Core Styling */
  .ql-editor {
    border: none !important;
    background: transparent !important;
    font-family: var(--font-sans) !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: var(--color-deep-grey) !important;
    padding: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    min-height: 200px !important;
    outline: none !important;
    box-sizing: border-box !important;
  }
  
  /* Ensure the editor container is visible */
  .ql-container {
    border: none !important;
    background: transparent !important;
    min-height: 200px !important;
    display: block !important;
  }
  
  /* Make sure the editor is visible and clickable */
  .ql-editor:focus {
    outline: none !important;
  }
  
  .ql-editor.ql-blank::before {
    color: var(--color-pebble-grey) !important;
    font-style: normal !important;
    text-indent: 0 !important;
    padding-left: 0 !important;
    margin-left: 0 !important;
    left: 0 !important;
    transform: translateX(0) !important;
    position: relative !important;
  }
  
  /* Specific fix for snow theme placeholder indentation */
  .ql-snow .ql-editor.ql-blank::before {
    text-indent: 0 !important;
    padding-left: 0 !important;
    margin-left: 0 !important;
    left: 0 !important;
    transform: translateX(0) !important;
    position: relative !important;
  }
  
  /* Global SpaceButton styling for ALL Quill toolbars - MAXIMUM SPECIFICITY */
  .ql-toolbar,
  .ql-toolbar.ql-snow,
  div.ql-toolbar,
  div.ql-toolbar.ql-snow {
    border: 1px solid var(--color-fog-white) !important;
    border-radius: 12px !important;
    background: var(--color-snow-white) !important;
    display: flex !important;
    gap: 0.25rem !important;
    align-items: center !important;
    padding: 0.25rem !important;
    margin: 0 !important;
  }
  
  .ql-toolbar button,
  .ql-toolbar.ql-snow button,
  div.ql-toolbar button,
  div.ql-toolbar.ql-snow button,
  button.ql-bold,
  button.ql-italic,
  button.ql-underline,
  button.ql-list,
  button.ql-clean {
    background: transparent !important;
    border: none !important;
    border-radius: 0.5rem !important;
    padding: 0.5rem 0.75rem !important;
    margin: 0 !important;
    color: var(--color-stone-grey) !important;
    font-family: var(--font-sans) !important;
    font-size: 14px !important;
    font-weight: 500 !important;
    transition: all 0.2s ease-in-out !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    cursor: pointer !important;
    box-shadow: none !important;
    min-width: 2.5rem !important;
    min-height: 2.5rem !important;
  }
  
  .ql-toolbar button:hover,
  .ql-toolbar.ql-snow button:hover,
  div.ql-toolbar button:hover,
  div.ql-toolbar.ql-snow button:hover,
  button.ql-bold:hover,
  button.ql-italic:hover,
  button.ql-underline:hover,
  button.ql-list:hover,
  button.ql-clean:hover {
    background: transparent !important;
    color: var(--color-deep-grey) !important;
  }
  
  .ql-toolbar button.ql-active,
  .ql-toolbar.ql-snow button.ql-active,
  div.ql-toolbar button.ql-active,
  div.ql-toolbar.ql-snow button.ql-active {
    background: transparent !important;
    color: var(--color-deep-grey) !important;
    position: relative !important;
  }
  
  .ql-toolbar button.ql-active::before,
  .ql-toolbar.ql-snow button.ql-active::before,
  div.ql-toolbar button.ql-active::before,
  div.ql-toolbar.ql-snow button.ql-active::before {
    content: '' !important;
    position: absolute !important;
    bottom: 0px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 4px !important;
    height: 4px !important;
    background: var(--color-deep-grey) !important;
    border-radius: 50% !important;
    z-index: 1 !important;
  }
  
  .ql-toolbar button.ql-active:hover,
  .ql-toolbar.ql-snow button.ql-active:hover,
  div.ql-toolbar button.ql-active:hover,
  div.ql-toolbar.ql-snow button.ql-active:hover {
    background: transparent !important;
    color: var(--color-deep-grey) !important;
  }
  
  .ql-toolbar button i,
  .ql-toolbar.ql-snow button i,
  div.ql-toolbar button i,
  div.ql-toolbar.ql-snow button i,
  .ql-toolbar .fa-solid,
  .ql-toolbar.ql-snow .fa-solid,
  div.ql-toolbar .fa-solid,
  div.ql-toolbar.ql-snow .fa-solid,
  .ql-toolbar button .fa-bold,
  .ql-toolbar button .fa-italic,
  .ql-toolbar button .fa-underline,
  .ql-toolbar button .fa-list,
  .ql-toolbar button .fa-list-ol,
  .ql-toolbar button .fa-eraser,
  .ql-toolbar i,
  .ql-toolbar.ql-snow i,
  div.ql-toolbar i,
  div.ql-toolbar.ql-snow i {
    color: #8B8B8B !important;
    transition: color 0.2s ease-in-out !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
  
  .ql-toolbar button:hover i,
  .ql-toolbar.ql-snow button:hover i,
  div.ql-toolbar button:hover i,
  div.ql-toolbar.ql-snow button:hover i,
  .ql-toolbar button:hover .fa-solid,
  .ql-toolbar.ql-snow button:hover .fa-solid,
  div.ql-toolbar button:hover .fa-solid,
  div.ql-toolbar.ql-snow button:hover .fa-solid,
  .ql-toolbar button:hover .fa-bold,
  .ql-toolbar button:hover .fa-italic,
  .ql-toolbar button:hover .fa-underline,
  .ql-toolbar button:hover .fa-list,
  .ql-toolbar button:hover .fa-list-ol,
  .ql-toolbar button:hover .fa-eraser {
    color: #4A4A4A !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
  
  .ql-toolbar button.ql-active i,
  .ql-toolbar.ql-snow button.ql-active i,
  div.ql-toolbar button.ql-active i,
  div.ql-toolbar.ql-snow button.ql-active i,
  .ql-toolbar button.ql-active .fa-solid,
  .ql-toolbar.ql-snow button.ql-active .fa-solid,
  div.ql-toolbar button.ql-active .fa-solid,
  div.ql-toolbar.ql-snow button.ql-active .fa-solid,
  .ql-toolbar button.ql-active .fa-bold,
  .ql-toolbar button.ql-active .fa-italic,
  .ql-toolbar button.ql-active .fa-underline,
  .ql-toolbar button.ql-active .fa-list,
  .ql-toolbar button.ql-active .fa-list-ol,
  .ql-toolbar button.ql-active .fa-eraser {
    color: #4A4A4A !important;
    width: 20px !important;
    height: 20px !important;
    font-size: 20px !important;
  }
</style>

<div id="static-quill-editor" class="relative h-full">
  <input id={id} name={name} value={content} type="hidden" />
  
  <!-- Quill Editor Container -->
  <div 
    id={`static-quill-container-${id}`}
    class="quill-content h-full"
    style="min-height: 200px; border: none; background: transparent;"
    tabindex={tabindex}
  ></div>
</div>

<style>
  #static-quill-editor {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  #static-quill-editor .quill-content {
    resize: none;
    background: transparent;
    border-radius: 0;
    border: none;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    min-height: 200px;
    overflow-y: auto;
  }
  
  /* Force toolbar to bottom using CSS Grid */
  #static-quill-editor {
    display: grid !important;
    grid-template-rows: 1fr auto !important;
    grid-template-areas: "editor" "toolbar" !important;
  }
  
  #static-quill-editor .ql-container {
    grid-area: editor !important;
    order: 1 !important;
    border: none !important;
    border-color: transparent !important;
  }
  
  #static-quill-editor .ql-toolbar {
    grid-area: toolbar !important;
    order: 2 !important;
    border: none !important;
    border-color: transparent !important;
    margin-top: 0.5rem !important;
  }

  /* Quill Editor Styling - Match note content styling */
  #static-quill-editor .ql-editor {
    font-family: var(--font-sans) !important;
    font-weight: normal;
    font-size: 16px;
    color: var(--color-deep-grey);
    line-height: 1.6;
    border: none !important;
    border-radius: 0;
    padding: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    background: transparent !important;
    box-shadow: none !important;
    min-height: 200px;
  }
  
  /* Remove gray background on hover/focus */
  #static-quill-editor .ql-editor:hover,
  #static-quill-editor .ql-editor:focus,
  #static-quill-editor .ql-editor:focus-within {
    background: transparent !important;
    outline: none !important;
  }
  
  /* Remove any Quill default hover effects */
  #static-quill-editor .ql-container:hover .ql-editor {
    background: transparent !important;
  }
  
  /* Force Reddit Sans on all Quill content */
  #static-quill-editor .ql-editor * {
    font-family: var(--font-sans) !important;
  }
  
  /* Override Quill's default font styles */
  #static-quill-editor .ql-editor p,
  #static-quill-editor .ql-editor div,
  #static-quill-editor .ql-editor span,
  #static-quill-editor .ql-editor strong,
  #static-quill-editor .ql-editor em,
  #static-quill-editor .ql-editor u {
    font-family: var(--font-sans) !important;
  }
  
  /* Custom prose-like styling to match note content */
  #static-quill-editor .ql-editor {
    max-width: none;
  }
  
  /* Ensure paragraphs have proper spacing like note content */
  #static-quill-editor .ql-editor p {
    margin-bottom: 0 !important;
  }
  
  #static-quill-editor .ql-editor p:not(:last-child) {
    margin-bottom: 1rem !important;
  }

  #static-quill-editor .ql-editor.ql-blank::before {
    color: var(--color-pebble-grey);
    font-style: normal;
    content: attr(data-placeholder);
  }

  /* Quill Toolbar Styling - SpaceButton inspired */
  #static-quill-editor .ql-toolbar {
    border: 1px solid var(--color-fog-white);
    border-radius: 12px;
    background: var(--color-snow-white);
    padding: 0.5rem;
    order: 2; /* Ensure toolbar comes after editor */
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  

  #static-quill-editor .ql-toolbar .ql-formats {
    margin-right: 0;
    display: flex;
    gap: 0.5rem;
  }

  #static-quill-editor .ql-toolbar button {
    color: var(--color-deep-grey);
    background: transparent;
    border: none;
    border-radius: 0.75rem;
    padding: 0.5rem 0.75rem;
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.125s ease-in-out;
    will-change: transform;
    min-height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #static-quill-editor .ql-toolbar button:hover {
    color: var(--color-deep-grey);
    background: var(--color-fog-white);
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  #static-quill-editor .ql-toolbar button.ql-active {
    color: var(--color-deep-grey);
    background: var(--color-fog-white);
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  #static-quill-editor .ql-toolbar button:active {
    filter: brightness(0.97);
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
    transform: scale(0.98);
  }

  /* Hide duplicate toolbars - more aggressive */
  #static-quill-editor .ql-toolbar:not(:first-child) {
    display: none !important;
  }
  
  /* Global rule to hide any duplicate Quill toolbars */
  .ql-toolbar:not(:first-child) {
    display: none !important;
  }
  
  /* Global rule to apply SpaceButton styling with snow-white background and fog-white border */
  .ql-toolbar {
    border: 1px solid var(--color-fog-white) !important;
    border-radius: 12px !important;
    background: var(--color-snow-white) !important;
    padding: 0.5rem !important;
    display: flex !important;
    gap: 0.5rem !important;
    align-items: center !important;
  }
  
  .ql-toolbar .ql-formats {
    margin-right: 0 !important;
    display: flex !important;
    gap: 0.5rem !important;
  }
  
  .ql-toolbar button {
    color: var(--color-deep-grey) !important;
    background: transparent !important;
    border: none !important;
    border-radius: 0.75rem !important;
    padding: 0.5rem 0.75rem !important;
    font-family: var(--font-sans) !important;
    font-size: 14px !important;
    font-weight: 600 !important;
    cursor: pointer !important;
    transition: all 0.125s ease-in-out !important;
    will-change: transform !important;
    min-height: 2rem !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  
  .ql-toolbar button:hover {
    color: var(--color-deep-grey) !important;
    background: var(--color-fog-white) !important;
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset !important;
  }
  
  .ql-toolbar button.ql-active {
    color: var(--color-deep-grey) !important;
    background: var(--color-fog-white) !important;
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset !important;
  }
  
  .ql-toolbar button:active {
    filter: brightness(0.97) !important;
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset !important;
    transform: scale(0.98) !important;
  }
  
  /* Override Quill's specific toolbar border */
  .ql-toolbar.ql-snow {
    border: none !important;
    border-color: transparent !important;
  }
  
  /* Remove all Quill container borders */
  .ql-container {
    border: none !important;
    border-color: transparent !important;
  }
  
  /* Override Quill's specific container border */
  .ql-container.ql-snow {
    border: none !important;
    border-color: transparent !important;
  }
  
  /* Remove borders from Quill editor */
  .ql-editor {
    border: none !important;
    border-color: transparent !important;
  }
  
  /* Force Reddit Sans on all Quill editors - more aggressive */
  #static-quill-editor .ql-editor,
  #static-quill-editor .ql-editor *,
  #static-quill-editor .ql-editor p,
  #static-quill-editor .ql-editor div,
  #static-quill-editor .ql-editor span,
  #static-quill-editor .ql-editor strong,
  #static-quill-editor .ql-editor em,
  #static-quill-editor .ql-editor u,
  #static-quill-editor .ql-editor ol,
  #static-quill-editor .ql-editor ul,
  #static-quill-editor .ql-editor li {
    font-family: var(--font-sans) !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: var(--color-deep-grey) !important;
  }
  
  /* Global rule to force Reddit Sans on all Quill editors */
  .ql-editor,
  .ql-editor * {
    font-family: var(--font-sans) !important;
    font-size: 16px !important;
    line-height: 1.6 !important;
    color: var(--color-deep-grey) !important;
  }
  
  /* Simple placeholder fix - just remove indentation */
  .ql-editor.ql-blank::before,
  .ql-editor.ql-snow.ql-blank::before,
  div.ql-editor.ql-blank::before,
  div.ql-editor.ql-snow.ql-blank::before,
  #static-quill-editor .ql-editor.ql-blank::before,
  #static-quill-editor .ql-editor.ql-snow.ql-blank::before {
    text-indent: 0 !important;
    padding-left: 0 !important;
    font-style: normal !important;
  }
  
  /* Global rule to remove default padding and fix placeholder - MAXIMUM SPECIFICITY */
  .ql-editor,
  .ql-editor.ql-snow,
  div.ql-editor,
  div.ql-editor.ql-snow,
  #static-quill-editor .ql-editor,
  #static-quill-editor .ql-editor.ql-snow {
    padding: 0 !important;
  }
  
  
  .ql-editor.ql-blank::before,
  .ql-editor.ql-snow.ql-blank::before,
  div.ql-editor.ql-blank::before,
  div.ql-editor.ql-snow.ql-blank::before,
  #static-quill-editor .ql-editor.ql-blank::before,
  #static-quill-editor .ql-editor.ql-snow.ql-blank::before {
    font-style: normal !important;
    text-indent: 0 !important;
    padding-left: 0 !important;
  }
  
  /* Global rules to remove gray backgrounds on hover/focus */
  .ql-editor:hover,
  .ql-editor:focus,
  .ql-editor:focus-within,
  .ql-container:hover .ql-editor {
    background: transparent !important;
    outline: none !important;
  }
  
</style>

<script define:vars={{ id, placeholder, content, minimalToolbar, tabindex }}>
  // Simplified and more reliable QuillEditor initialization
  function initializeQuillEditor() {
    const quillContainer = document.querySelector(`#static-quill-container-${id}`);
    const hiddenInput = document.querySelector(`#${id}`);
    
    
    // Check if already initialized
    if (!quillContainer || !hiddenInput || !window.Quill || quillContainer.__quill) {
      return;
    }
    
    // Don't clear container - let Quill handle it
    // quillContainer.innerHTML = '';
    
    // Initialize Quill with configuration based on minimalToolbar prop
    const toolbarConfig = minimalToolbar ? false : [
      ['bold', 'italic', 'underline'],
      [{ 'list': 'ordered'}, { 'list': 'bullet' }],
      ['clean']
    ];
    
    // Override Quill's default icons with Font Awesome icons using the proper Quill API
    if (!minimalToolbar && window.Quill) {
      const icons = window.Quill.import('ui/icons');
      icons['bold'] = '<i class="fa-solid fa-bold"></i>';
      icons['italic'] = '<i class="fa-solid fa-italic"></i>';
      icons['underline'] = '<i class="fa-solid fa-underline"></i>';
      icons['list'] = '<i class="fa-solid fa-list"></i>';
      icons['ordered'] = '<i class="fa-solid fa-list-ol"></i>';
      icons['bullet'] = '<i class="fa-solid fa-list"></i>';
      icons['clean'] = '<i class="fa-solid fa-eraser"></i>';
    }
    
    
    const quillInstance = new window.Quill(quillContainer, {
      theme: 'snow', // Use snow theme for toolbar but fix placeholder indentation
      placeholder: placeholder,
      modules: {
        toolbar: toolbarConfig
      }
    });
    
    
    
    
    // If no toolbar was created but we want one, create it manually
    if (!minimalToolbar && !quillContainer.querySelector('.ql-toolbar')) {
      const toolbar = document.createElement('div');
      toolbar.className = 'ql-toolbar ql-snow';
      toolbar.innerHTML = `
        <span class="ql-formats">
          <button class="ql-bold" type="button"></button>
          <button class="ql-italic" type="button"></button>
          <button class="ql-underline" type="button"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered" type="button"></button>
          <button class="ql-list" value="bullet" type="button"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-clean" type="button"></button>
        </span>
      `;
      
      // Insert toolbar before the editor
      const editor = quillContainer.querySelector('.ql-editor');
      if (editor) {
        quillContainer.insertBefore(toolbar, editor);
      }
    }
    
    // Immediately try to style the toolbar after Quill creation
    setTimeout(() => {
      const toolbar = quillContainer.querySelector('.ql-toolbar');
      if (toolbar) {
        applySpaceButtonStyling(toolbar);
        
        // Also apply styling to buttons specifically
        const buttons = toolbar.querySelectorAll('button');
        buttons.forEach((button, index) => {
          button.style.cssText = `
            color: var(--color-deep-grey) !important;
            background: transparent !important;
            border: none !important;
            border-radius: 0.75rem !important;
            padding: 0.5rem 0.75rem !important;
            margin: 0 !important;
            font-family: var(--font-sans) !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.125s ease-in-out !important;
            min-height: 2rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: none !important;
          `;
        });
      }
    }, 0);
    
    // Move toolbar to bottom after Quill is fully initialized
    setTimeout(() => {
      const toolbar = quillContainer.querySelector('.ql-toolbar');
      const editor = quillContainer.querySelector('.ql-editor');
      if (toolbar && editor) {
        // Remove toolbar from its current position
        toolbar.remove();
        // Insert toolbar after the editor container
        editor.parentNode.insertBefore(toolbar, editor.nextSibling);
        
        // Apply SpaceButton styling immediately
        applySpaceButtonStyling(toolbar);
      }
    }, 100);
    
    // Also apply styling after a longer delay to ensure toolbar is fully rendered
    setTimeout(() => {
      const toolbar = quillContainer.querySelector('.ql-toolbar');
      if (toolbar) {
        applySpaceButtonStyling(toolbar);
      }
    }, 500);
    
    
    // Store reference to prevent re-initialization
    quillContainer.__quill = quillInstance;
    
    // Set tabindex on the editor if provided
    if (tabindex !== undefined) {
      const editor = quillContainer.querySelector('.ql-editor');
      if (editor) {
        editor.setAttribute('tabindex', tabindex);
      }
      
      // Set tabindex on toolbar buttons to come after the editor
      const toolbarButtons = quillContainer.querySelectorAll('.ql-toolbar button');
      toolbarButtons.forEach((button, index) => {
        button.setAttribute('tabindex', tabindex + 1 + index);
      });
    }
    
    // Inject aggressive CSS directly into document head
    const styleId = `quill-spacebutton-styles-${id}`;
    if (!document.getElementById(styleId)) {
      const style = document.createElement('style');
      style.id = styleId;
      style.textContent = `
        .ql-toolbar, .ql-toolbar.ql-snow, div.ql-toolbar, div.ql-toolbar.ql-snow {
          border: 1px solid var(--color-fog-white) !important;
          border-radius: 12px !important;
          background: var(--color-snow-white) !important;
          display: flex !important;
          gap: 0.25rem !important;
          align-items: center !important;
          padding: 0.25rem !important;
          margin: 0 !important;
        }
        .ql-toolbar button, .ql-toolbar.ql-snow button, div.ql-toolbar button, div.ql-toolbar.ql-snow button,
        button.ql-bold, button.ql-italic, button.ql-underline, button.ql-list, button.ql-clean {
          background: transparent !important;
          border: none !important;
          border-radius: 0.5rem !important;
          padding: 0.5rem 0.75rem !important;
          margin: 0 !important;
          color: var(--color-stone-grey) !important;
          font-family: var(--font-sans) !important;
          font-size: 14px !important;
          font-weight: 500 !important;
          transition: all 0.2s ease-in-out !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          cursor: pointer !important;
          box-shadow: none !important;
          min-width: 2.5rem !important;
          min-height: 2.5rem !important;
        }
        .ql-toolbar button:hover, .ql-toolbar.ql-snow button:hover, div.ql-toolbar button:hover, div.ql-toolbar.ql-snow button:hover,
        button.ql-bold:hover, button.ql-italic:hover, button.ql-underline:hover, button.ql-list:hover, button.ql-clean:hover {
          background: transparent !important;
          color: var(--color-deep-grey) !important;
        }
        .ql-toolbar button.ql-active, .ql-toolbar.ql-snow button.ql-active, div.ql-toolbar button.ql-active, div.ql-toolbar.ql-snow button.ql-active {
          background: transparent !important;
          color: var(--color-deep-grey) !important;
          position: relative !important;
        }
        .ql-toolbar button.ql-active::before, .ql-toolbar.ql-snow button.ql-active::before, div.ql-toolbar button.ql-active::before, div.ql-toolbar.ql-snow button.ql-active::before {
          content: '' !important;
          position: absolute !important;
          bottom: 0px !important;
          left: 50% !important;
          transform: translateX(-50%) !important;
          width: 4px !important;
          height: 4px !important;
          background: var(--color-deep-grey) !important;
          border-radius: 50% !important;
          z-index: 1 !important;
        }
        .ql-toolbar button.ql-active:hover, .ql-toolbar.ql-snow button.ql-active:hover, div.ql-toolbar button.ql-active:hover, div.ql-toolbar.ql-snow button.ql-active:hover {
          background: transparent !important;
          color: var(--color-deep-grey) !important;
        }
        .ql-toolbar button i, .ql-toolbar.ql-snow button i, div.ql-toolbar button i, div.ql-toolbar.ql-snow button i,
        .ql-toolbar .fa-solid, .ql-toolbar.ql-snow .fa-solid, div.ql-toolbar .fa-solid, div.ql-toolbar.ql-snow .fa-solid,
        .ql-toolbar button .fa-bold, .ql-toolbar button .fa-italic, .ql-toolbar button .fa-underline,
        .ql-toolbar button .fa-list, .ql-toolbar button .fa-list-ol, .ql-toolbar button .fa-eraser {
          color: #8B8B8B !important;
          transition: color 0.2s ease-in-out !important;
          width: 20px !important;
          height: 20px !important;
          font-size: 20px !important;
        }
        .ql-toolbar button:hover i, .ql-toolbar.ql-snow button:hover i, div.ql-toolbar button:hover i, div.ql-toolbar.ql-snow button:hover i,
        .ql-toolbar button:hover .fa-solid, .ql-toolbar.ql-snow button:hover .fa-solid, div.ql-toolbar button:hover .fa-solid, div.ql-toolbar.ql-snow button:hover .fa-solid,
        .ql-toolbar button:hover .fa-bold, .ql-toolbar button:hover .fa-italic, .ql-toolbar button:hover .fa-underline,
        .ql-toolbar button:hover .fa-list, .ql-toolbar button:hover .fa-list-ol, .ql-toolbar button:hover .fa-eraser {
          color: #4A4A4A !important;
          width: 20px !important;
          height: 20px !important;
          font-size: 20px !important;
        }
        .ql-toolbar button.ql-active i, .ql-toolbar.ql-snow button.ql-active i, div.ql-toolbar button.ql-active i, div.ql-toolbar.ql-snow button.ql-active i,
        .ql-toolbar button.ql-active .fa-solid, .ql-toolbar.ql-snow button.ql-active .fa-solid, div.ql-toolbar button.ql-active .fa-solid, div.ql-toolbar.ql-snow button.ql-active .fa-solid,
        .ql-toolbar button.ql-active .fa-bold, .ql-toolbar button.ql-active .fa-italic, .ql-toolbar button.ql-active .fa-underline,
        .ql-toolbar button.ql-active .fa-list, .ql-toolbar button.ql-active .fa-list-ol, .ql-toolbar button.ql-active .fa-eraser {
          color: #4A4A4A !important;
          width: 20px !important;
          height: 20px !important;
          font-size: 20px !important;
        }
        /* Force remove padding and fix placeholder */
        .ql-editor, .ql-editor.ql-snow, div.ql-editor, div.ql-editor.ql-snow {
          padding-left: 0 !important;
          padding-right: 0 !important;
          padding: 0 !important;
        }
        .ql-editor.ql-blank::before, .ql-editor.ql-snow.ql-blank::before, div.ql-editor.ql-blank::before, div.ql-editor.ql-snow.ql-blank::before {
          font-style: normal !important;
          text-indent: 0 !important;
          padding-left: 0 !important;
        }
      `;
      document.head.appendChild(style);
    }
    
    
    // Set initial content if provided
    if (content && content.trim()) {
      quillInstance.root.innerHTML = content;
      hiddenInput.value = content;
    }
    
    // Update hidden input when content changes
    quillInstance.on('text-change', () => {
      const htmlContent = quillInstance.root.innerHTML;
      hiddenInput.value = htmlContent;
    });
    
    // Apply consistent font styling once
    const fontFamily = getComputedStyle(document.documentElement).getPropertyValue('--font-sans').trim();
    const targetFont = fontFamily || '"Reddit Sans", system-ui, -apple-system, sans-serif';
    
    // Apply styling to editor root
    quillInstance.root.style.fontFamily = targetFont;
    quillInstance.root.style.fontSize = '16px';
    quillInstance.root.style.lineHeight = '1.6';
    quillInstance.root.style.color = 'var(--color-deep-grey)';
    
    // Force remove padding and fix placeholder
    quillInstance.root.style.padding = '0';
    quillInstance.root.style.paddingLeft = '0';
    quillInstance.root.style.paddingRight = '0';
    
    // Fix placeholder styling - simple approach
    const fixPlaceholder = () => {
      // Only fix the text-indent which is the main issue
      quillInstance.root.style.textIndent = '0';
    };
    
    // Apply placeholder fix immediately and on text changes
    fixPlaceholder();
    quillInstance.on('text-change', fixPlaceholder);
    
    // Simple CSS injection for placeholder fix
    setTimeout(() => {
      const styleId = `quill-placeholder-fix-${id}`;
      if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
          /* Simple placeholder fix for ${id} */
          #static-quill-container-${id} .ql-editor.ql-blank::before {
            text-indent: 0 !important;
            padding-left: 0 !important;
            font-style: normal !important;
          }
        `;
        document.head.appendChild(style);
      }
    }, 1000);
    
    // Force remove all borders from Quill elements
    const container = quillContainer.querySelector('.ql-container');
    const toolbar = quillContainer.querySelector('.ql-toolbar');
    const editor = quillContainer.querySelector('.ql-editor');
    
    if (container) {
      container.style.border = 'none';
      container.style.borderColor = 'transparent';
      container.style.borderTop = 'none';
      container.style.borderBottom = 'none';
      container.style.borderLeft = 'none';
      container.style.borderRight = 'none';
    }
    
    if (toolbar) {
      toolbar.style.border = 'none';
      toolbar.style.borderColor = 'transparent';
      toolbar.style.borderTop = 'none';
      toolbar.style.borderBottom = 'none';
      toolbar.style.borderLeft = 'none';
      toolbar.style.borderRight = 'none';
    }
    
    if (editor) {
      editor.style.border = 'none';
      editor.style.borderColor = 'transparent';
    }
    
    // Also target the .ql-snow classes specifically
    const snowContainers = quillContainer.querySelectorAll('.ql-snow');
    snowContainers.forEach(element => {
      element.style.border = 'none';
      element.style.borderColor = 'transparent';
      element.style.borderTop = 'none';
      element.style.borderBottom = 'none';
      element.style.borderLeft = 'none';
      element.style.borderRight = 'none';
    });
    
    // Function to apply SpaceButton styling to a specific toolbar
    const applySpaceButtonStyling = (toolbar) => {
      if (!toolbar) return;
      
      // Style toolbar container
      toolbar.style.cssText = `
        border: 1px solid var(--color-fog-white) !important;
        border-radius: 12px !important;
        background: var(--color-snow-white) !important;
        display: flex !important;
        gap: 0.5rem !important;
        align-items: center !important;
        padding: 0.5rem !important;
        margin: 0 !important;
      `;
      
      // Style format groups
      const formats = toolbar.querySelectorAll('.ql-formats');
      formats.forEach(format => {
        format.style.cssText = `
          display: flex !important;
          gap: 0.5rem !important;
          margin-right: 0 !important;
        `;
      });
      
      // Style all buttons
      const buttons = toolbar.querySelectorAll('button');
      buttons.forEach((button, index) => {
        button.style.cssText = `
          color: var(--color-deep-grey) !important;
          background: transparent !important;
          border: none !important;
          border-color: transparent !important;
          border-radius: 0.75rem !important;
          padding: 0.5rem 0.75rem !important;
          margin: 0 !important;
          font-family: var(--font-sans) !important;
          font-size: 14px !important;
          font-weight: 600 !important;
          cursor: pointer !important;
          transition: all 0.125s ease-in-out !important;
          will-change: transform !important;
          min-height: 2rem !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          box-shadow: none !important;
        `;
        
        // Add event listeners for hover effects
        button.addEventListener('mouseenter', () => {
          button.style.background = 'var(--color-fog-white)';
          button.style.boxShadow = '0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset';
        });
        
        button.addEventListener('mouseleave', () => {
          if (!button.classList.contains('ql-active')) {
            button.style.background = 'transparent';
            button.style.boxShadow = 'none';
          }
        });
        
        button.addEventListener('mousedown', () => {
          button.style.filter = 'brightness(0.97)';
          button.style.boxShadow = '0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset, 0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset';
          button.style.transform = 'scale(0.98)';
        });
        
        button.addEventListener('mouseup', () => {
          button.style.filter = '';
          button.style.transform = '';
          if (button.classList.contains('ql-active')) {
            button.style.background = 'var(--color-fog-white)';
            button.style.boxShadow = '0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset';
          }
        });
      });
    };
    
    // Apply SpaceButton styling to toolbar buttons with maximum force
    const applyToolbarStyling = () => {
      const toolbarButtons = quillContainer.querySelectorAll('.ql-toolbar button');
      const toolbar = quillContainer.querySelector('.ql-toolbar');
      const formats = quillContainer.querySelectorAll('.ql-formats');
      
      // Style toolbar container
      if (toolbar) {
        toolbar.style.cssText = `
          border: none !important;
          border-color: transparent !important;
          background: transparent !important;
          display: flex !important;
          gap: 0.5rem !important;
          align-items: center !important;
          padding: 0.5rem 0 !important;
        `;
      }
      
      // Style format groups
      formats.forEach(format => {
        format.style.cssText = `
          display: flex !important;
          gap: 0.5rem !important;
          margin-right: 0 !important;
        `;
      });
      
      // Style all buttons
      toolbarButtons.forEach(button => {
        button.style.cssText = `
          color: var(--color-deep-grey) !important;
          background: transparent !important;
          border: none !important;
          border-color: transparent !important;
          border-radius: 0.75rem !important;
          padding: 0.5rem 0.75rem !important;
          margin: 0 !important;
          font-family: var(--font-sans) !important;
          font-size: 14px !important;
          font-weight: 600 !important;
          cursor: pointer !important;
          transition: all 0.125s ease-in-out !important;
          will-change: transform !important;
          min-height: 2rem !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          box-shadow: none !important;
        `;
        
        // Add event listeners for hover effects
        button.addEventListener('mouseenter', () => {
          button.style.background = 'var(--color-fog-white)';
          button.style.boxShadow = '0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset';
        });
        
        button.addEventListener('mouseleave', () => {
          if (!button.classList.contains('ql-active')) {
            button.style.background = 'transparent';
            button.style.boxShadow = 'none';
          }
        });
        
        button.addEventListener('mousedown', () => {
          button.style.filter = 'brightness(0.97)';
          button.style.boxShadow = '0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset, 0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset';
          button.style.transform = 'scale(0.98)';
        });
        
        button.addEventListener('mouseup', () => {
          button.style.filter = '';
          button.style.transform = '';
          if (button.classList.contains('ql-active')) {
            button.style.background = 'var(--color-fog-white)';
            button.style.boxShadow = '0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset';
          }
        });
      });
    };
    
    // Apply styling immediately
    applyToolbarStyling();
    
    // Also apply after a delay to catch any late-rendered elements
    setTimeout(applyToolbarStyling, 100);
    setTimeout(applyToolbarStyling, 500);
    
    // Apply SpaceButton styling to any existing toolbar
    const existingToolbar = quillContainer.querySelector('.ql-toolbar');
    if (existingToolbar) {
      applySpaceButtonStyling(existingToolbar);
    }
    
    // Use MutationObserver to watch for toolbar creation
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        mutation.addedNodes.forEach((node) => {
          if (node.nodeType === 1) { // Element node
            if (node.classList && node.classList.contains('ql-toolbar')) {
              applySpaceButtonStyling(node);
            }
            // Also check for toolbar in child elements
            const toolbar = node.querySelector && node.querySelector('.ql-toolbar');
            if (toolbar) {
              applySpaceButtonStyling(toolbar);
            }
          }
        });
      });
    });
    
    // Start observing
    observer.observe(quillContainer, {
      childList: true,
      subtree: true
    });
    
    // Stop observing after 5 seconds
    setTimeout(() => {
      observer.disconnect();
    }, 5000);
    
  }
  
  // Multiple initialization attempts for reliability
  function tryInitialize() {
    const quillContainer = document.querySelector(`#static-quill-container-${id}`);
    const hiddenInput = document.querySelector(`#${id}`);
    
    if (quillContainer && hiddenInput && window.Quill && !quillContainer.__quill) {
      initializeQuillEditor();
      return true;
    }
    return false;
  }
  
  // Try immediately
  if (!tryInitialize()) {
    // Try on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryInitialize);
    }
    
    // Try with delays
    setTimeout(tryInitialize, 100);
    setTimeout(tryInitialize, 300);
    setTimeout(tryInitialize, 500);
    setTimeout(tryInitialize, 1000);
    
    // Final fallback on window load
    window.addEventListener('load', tryInitialize);
  }
  
  // Listen for Astro View Transitions events
          document.addEventListener('astro:after-swap', () => {
            setTimeout(tryInitialize, 50);
            setTimeout(tryInitialize, 200);
            setTimeout(tryInitialize, 500);
          });
  
  document.addEventListener('astro:page-load', () => {
    setTimeout(tryInitialize, 50);
    setTimeout(tryInitialize, 200);
  });
</script>
