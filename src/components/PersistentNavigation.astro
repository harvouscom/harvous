---
import SpaceButton from "./SpaceButton.astro";
import FaXmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
---

<!-- Persistent Navigation Component -->
<div id="persistent-navigation" class="flex flex-col items-start justify-start w-full">
  <!-- This will be populated by JavaScript with persistent navigation items -->
</div>

<script>
  // Simple function to render persistent navigation
  function renderPersistentNavigation() {
    const container = document.getElementById('persistent-navigation');
    if (!container) {
      return;
    }
    
    // Use the global navigation history functions
    if (typeof (window as any).getNavigationHistory !== 'function') {
      return; // Navigation history script not loaded yet
    }
    
    const history = (window as any).getNavigationHistory();
    
    if (history.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Clean up navigation history by removing items that are currently active or permanently visible
    const currentPath = window.location.pathname;
    const currentItemId = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
    
    console.log(`ðŸ§¹ PERSISTENT NAV DEBUG - Current path: ${currentPath}, Item ID: ${currentItemId}`);
    console.log(`ðŸ§¹ PERSISTENT NAV DEBUG - History before filtering:`, history);
    
    const cleanedHistory = history.filter((item: any) => {
      // Don't show if it's currently active
      if (item.id === currentItemId) {
        console.log(`ðŸ§¹ Filtering out currently active item: ${item.id}`);
        return false;
      }
      
      // Don't show if it's permanently visible (spaces only)
      if (item.id.startsWith('space_')) {
        console.log(`ðŸ§¹ Filtering out permanently visible space: ${item.id}`);
        return false;
      }
      
      // Don't show if it's the unorganized thread and we're currently on it
      if (item.id === 'thread_unorganized' && currentItemId === 'thread_unorganized') {
        console.log(`ðŸ§¹ Filtering out unorganized thread (currently active): ${item.id}`);
        return false;
      }
      
      // Note: Threads can appear in persistent navigation even if they have data-navigation-item
      // because they're only temporarily visible when active
      
      return true;
    });
    
    console.log(`ðŸ§¹ PERSISTENT NAV DEBUG - History after filtering:`, cleanedHistory);
    
    // If we cleaned up items, save the cleaned history
    if (cleanedHistory.length !== history.length) {
      console.log(`ðŸ§¹ Cleaned up navigation history: ${history.length} -> ${cleanedHistory.length} items`);
      if ((window as any).saveNavigationHistory) {
        (window as any).saveNavigationHistory(cleanedHistory);
      }
    }
    
    // Filter out dashboard and any remaining items
    const persistentItems = cleanedHistory.filter((item: any) => {
      // Don't show dashboard
      if (item.id === 'dashboard') {
        return false;
      }
      return true;
    });
    
    if (persistentItems.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Sort items by last access time (most recent last access at the bottom)
    const sortedItems = persistentItems.sort((a: any, b: any) => {
      const aTime = a.lastAccessed || 0;
      const bTime = b.lastAccessed || 0;
      return aTime - bTime; // Most recent last access last
    });
    
    // Create navigation items HTML
    const itemsHTML = sortedItems.map((item: any) => {
      const isActive = window.location.pathname === `/${item.id}`;
      
      return `
        <div data-navigation-item="${item.id}" class="w-full nav-item-container ${isActive ? 'active' : ''}">
          <a href="/${item.id}" class="w-full relative block">
            <button
              class="space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group w-full"
              style="${isActive ? `background-image: ${item.backgroundGradient || 'var(--color-gradient-gray)'};` : ''}"
            >
              <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                  ${item.title}
                </span>
                <!-- Right box - simple flex container for badge -->
                <div class="flex items-center justify-center p-[20px]">
                  <!-- Badge count - show when not hovering -->
                  <div class="badge-count bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                      ${item.count || 0}
                    </span>
                  </div>
                </div>
              </div>
            </button>
            <!-- Close icon - only show for inactive items -->
            ${!isActive ? `
            <div 
              class="close-icon absolute top-1/2 right-5 transform -translate-y-1/2 flex items-center justify-center w-6 h-6 cursor-pointer"
              onclick="handlePersistentCloseClick(event, this)"
              data-item-id="${item.id}"
            >
              <svg class="w-4 h-4 fill-current" style="color: var(--color-deep-grey);" viewBox="0 0 384 512">
                <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
              </svg>
            </div>
            ` : ''}
          </a>
        </div>
      `;
    }).join('');
    
    container.innerHTML = itemsHTML;
    
    // Add CSS for hover states - only for inactive items
    const style = document.createElement('style');
    style.textContent = `
      .nav-item-container:not(.active):hover .badge-count {
        display: none !important;
      }
      .nav-item-container:not(.active):hover .close-icon {
        display: flex !important;
      }
      .close-icon {
        display: none;
      }
    `;
    document.head.appendChild(style);
  }
  
  // Initialize persistent navigation
  function initializePersistentNavigation() {
    // Wait for navigation history script to load
    if (typeof (window as any).getNavigationHistory === 'function') {
      renderPersistentNavigation();
    } else {
      // Retry after a short delay
      setTimeout(initializePersistentNavigation, 100);
    }
  }
  
  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePersistentNavigation);
  } else {
    initializePersistentNavigation();
  }
  
  // Re-initialize after View Transitions
  document.addEventListener('astro:page-load', () => {
    initializePersistentNavigation();
  });
  
  // Simple close handler for persistent navigation items
  function handlePersistentCloseClick(event: Event, element: HTMLElement) {
    event.stopPropagation();
    event.preventDefault();
    
    const itemId = element.getAttribute('data-item-id');
    if (!itemId) return;
    
    console.log('ðŸ”¥ Persistent close clicked for item:', itemId);
    
    // Remove from navigation history
    if ((window as any).removeFromNavigationHistory) {
      (window as any).removeFromNavigationHistory(itemId);
    }
    
    // Re-render persistent navigation
    renderPersistentNavigation();
  }
  
  // Export for global access
  (window as any).renderPersistentNavigation = renderPersistentNavigation;
  (window as any).handlePersistentCloseClick = handlePersistentCloseClick;
</script>

<style>
  /* Reuse SpaceButton styles */
  .space-button {
    will-change: transform;
    transition: box-shadow 0.125s ease-in-out;
  }

  .space-button[style*="background-image"] {
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:not([data-outer-shadow]):active {
    filter: brightness(0.97);
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:active > div {
    translate: 0 0;
    transform: scale(0.98);
  }

  .space-button:active svg {
    transform: scale(0.95);
  }
</style>