---
import SpaceButton from "./SpaceButton.astro";
---

<!-- Persistent Navigation Component -->
<div id="persistent-navigation" class="flex flex-col items-start justify-start w-full">
  <!-- This will be populated by JavaScript with persistent navigation items -->
</div>

<script>
  // Type declarations for window properties
  declare global {
    interface Window {
      getNavigationHistory: () => any[];
      removeFromNavigationHistory: (itemId: string) => void;
      renderPersistentNavigation: () => void;
      handlePersistentCloseClick: (event: Event, element: HTMLElement) => void;
    }
  }

  function renderPersistentNavigation() {
    const container = document.getElementById('persistent-navigation');
    if (!container) return;
    
    if (typeof window.getNavigationHistory !== 'function') return;
    
    const history = window.getNavigationHistory();
    
    if (history.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Get currently visible navigation items to avoid duplicates
    const visibleItems = Array.from(document.querySelectorAll('[data-navigation-item]'))
      .map((item: Element) => item.getAttribute('data-navigation-item'))
      .filter((id: string | null): id is string => id !== null);
    
    // Filter out items that are already visible in regular navigation
    let persistentItems = history.filter((item: any) => !visibleItems.includes(item.id));
    
    // Filter out unorganized thread if it's been closed
    persistentItems = persistentItems.filter((item: any) => {
      if (item.id === 'thread_unorganized') {
        const isClosed = localStorage.getItem('unorganized-thread-closed') === 'true';
        return !isClosed;
      }
      return true;
    });
    
    if (persistentItems.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Create navigation items HTML
    const itemsHTML = persistentItems.map((item: any) => {
      const isActive = window.location.pathname === `/${item.id}`;
      
      return `
        <div data-navigation-item="${item.id}" class="w-full nav-item-container ${isActive ? 'active' : ''}">
          <a href="/${item.id}" class="w-full relative block">
            <button
              class="space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group w-full"
              style="${isActive ? `background-image: ${item.backgroundGradient || 'var(--color-gradient-gray)'};` : ''}"
            >
              <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                  ${item.title}
                </span>
                <div class="flex items-center justify-center p-[20px]">
                  <div class="badge-count bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                      ${item.count || 0}
                    </span>
                  </div>
                </div>
              </div>
            </button>
            ${!isActive ? `
            <div 
              class="close-icon absolute top-1/2 right-5 transform -translate-y-1/2 flex items-center justify-center w-6 h-6 cursor-pointer"
              onclick="handlePersistentCloseClick(event, this)"
              data-item-id="${item.id}"
            >
              <svg class="w-4 h-4 fill-current" style="color: var(--color-deep-grey);" viewBox="0 0 384 512">
                <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
              </svg>
            </div>
            ` : ''}
          </a>
        </div>
      `;
    }).join('');
    
    container.innerHTML = itemsHTML;
    
    // Add CSS for hover states
    const style = document.createElement('style');
    style.textContent = `
      .nav-item-container:not(.active):hover .badge-count {
        display: none !important;
      }
      .nav-item-container:not(.active):hover .close-icon {
        display: flex !important;
      }
      .close-icon {
        display: none;
      }
    `;
    document.head.appendChild(style);
  }
  
  // Initialize persistent navigation
  function initializePersistentNavigation() {
    if (typeof window.getNavigationHistory === 'function') {
      renderPersistentNavigation();
    } else {
      setTimeout(initializePersistentNavigation, 100);
    }
  }
  
  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePersistentNavigation);
  } else {
    initializePersistentNavigation();
  }
  
  // Re-initialize after View Transitions
  document.addEventListener('astro:page-load', initializePersistentNavigation);
  
  // Simple close handler
  function handlePersistentCloseClick(event: Event, element: HTMLElement) {
    event.stopPropagation();
    event.preventDefault();
    
    const itemId = element.getAttribute('data-item-id');
    if (!itemId) return;
    
    if (window.removeFromNavigationHistory) {
      window.removeFromNavigationHistory(itemId);
    }
    
    renderPersistentNavigation();
  }
  
  // Export for global access
  window.renderPersistentNavigation = renderPersistentNavigation;
  window.handlePersistentCloseClick = handlePersistentCloseClick;
</script>

<style>
  .space-button {
    will-change: transform;
    transition: box-shadow 0.125s ease-in-out;
  }

  .space-button[style*="background-image"] {
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:not([data-outer-shadow]):active {
    filter: brightness(0.97);
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:active > div {
    translate: 0 0;
    transform: scale(0.98);
  }

  .space-button:active svg {
    transform: scale(0.95);
  }
</style>