---
import SpaceButton from "./SpaceButton.astro";
import { getNavigationHistory } from "../stores/navigation-history";
---

<!-- Persistent Navigation Component -->
<div id="persistent-navigation" class="flex flex-col items-start justify-start w-full">
  <!-- This will be populated by JavaScript with persistent navigation items -->
</div>

<script>
  // Simple localStorage-based navigation history
  function getNavigationHistory() {
    try {
      const stored = localStorage.getItem('navigation-history');
      return stored ? JSON.parse(stored) : [];
    } catch (error) {
      console.error('âŒ Error getting navigation history:', error);
      return [];
    }
  }
  
  function renderPersistentNavigation() {
    const container = document.getElementById('persistent-navigation');
    if (!container) {
      console.log('âŒ Persistent navigation container not found');
      return;
    }
    
    const history = getNavigationHistory();
    console.log('ðŸ“š Rendering persistent navigation with history:', history);
    
    if (history.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Get currently visible navigation items to avoid duplicates
    const visibleItems = Array.from(document.querySelectorAll('[data-navigation-item]'))
      .map(item => item.getAttribute('data-navigation-item'))
      .filter(id => id !== null);
    
    console.log('ðŸ‘ï¸ Currently visible navigation items:', visibleItems);
    
    // Filter out items that are already visible in regular navigation
    const persistentItems = history.filter((item: any) => !visibleItems.includes(item.id));
    console.log('ðŸ“š Items to show in persistent navigation:', persistentItems);
    
    if (persistentItems.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Create navigation items HTML
    const itemsHTML = persistentItems.map((item: any) => {
      const isActive = window.location.pathname === `/${item.id}`;
      
      return `
        <div data-navigation-item="${item.id}" class="w-full">
          <a href="/${item.id}" class="w-full">
            <button
              class="space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group w-full"
              style="${isActive ? `background-image: ${item.backgroundGradient || 'var(--color-gradient-gray)'};` : ''}"
              x-data="{ showClose: false }"
              @mouseenter="showClose = true; console.log('ðŸ”¥ Persistent nav hover enter - showClose:', showClose)"
              @mouseleave="showClose = false; console.log('ðŸ”¥ Persistent nav hover leave - showClose:', showClose)"
            >
              <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                  ${item.title}
                </span>
                <div class="p-[20px] relative">
                  <!-- Badge count - show when not hovering -->
                  <div 
                    x-show="!showClose"
                    class="badge-count bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6 relative"
                  >
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                      ${item.count || 0}
                    </span>
                  </div>
                  <!-- Close icon - show when hovering -->
                  <div 
                    x-show="showClose"
                    @click.stop.prevent="if (window.closeNavigationItemWithHistory) { window.closeNavigationItemWithHistory('${item.id}'); } else if (window.closeNavigationItem) { window.closeNavigationItem('${item.id}'); }"
                    class="close-icon-container absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center cursor-pointer z-10"
                  >
                    <svg class="fill-[var(--color-deep-grey)]" width="16" height="16" viewBox="0 0 24 24">
                      <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                  </div>
                </div>
              </div>
            </button>
          </a>
        </div>
      `;
    }).join('');
    
    container.innerHTML = itemsHTML;
    
    // Re-initialize Alpine.js for the new elements
    if ((window as any).Alpine) {
      setTimeout(() => {
        try {
          // Re-initialize Alpine.js for this container
          (window as any).Alpine.initTree(container);
          console.log('ðŸ”„ Alpine.js re-initialized for persistent navigation');
          
          // Also call global re-initialization
          if ((window as any).reinitializeAlpine) {
            (window as any).reinitializeAlpine();
          }
          
          // Debug: Check if Alpine.js is working on the new elements
          const alpineElements = container.querySelectorAll('[x-data]');
          console.log('ðŸ” Found Alpine.js elements:', alpineElements.length);
          
          // Test hover functionality
          const testButton = container.querySelector('button');
          if (testButton) {
            console.log('ðŸ§ª Testing hover functionality on first button');
            // Simulate hover to test
            testButton.dispatchEvent(new Event('mouseenter'));
            setTimeout(() => {
              const closeIcon = testButton.querySelector('[x-show="showClose"]');
              console.log('ðŸ” Close icon visible after hover:', closeIcon ? 'Yes' : 'No');
              testButton.dispatchEvent(new Event('mouseleave'));
            }, 100);
          }
        } catch (error) {
          console.error('âŒ Error initializing Alpine.js:', error);
        }
      }, 150); // Increased timeout
    } else {
      console.log('âŒ Alpine.js not available for persistent navigation');
    }
  }
  
  // Initialize persistent navigation
  function initializePersistentNavigation() {
    console.log('ðŸš€ Initializing persistent navigation');
    renderPersistentNavigation();
  }
  
  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePersistentNavigation);
  } else {
    initializePersistentNavigation();
  }
  
  // Re-initialize after View Transitions
  document.addEventListener('astro:page-load', () => {
    console.log('ðŸ“„ Page loaded, re-initializing persistent navigation');
    initializePersistentNavigation();
  });
  
  // Export for global access
  (window as any).renderPersistentNavigation = renderPersistentNavigation;
</script>

<style>
  /* Reuse SpaceButton styles */
  .space-button {
    will-change: transform;
    transition: box-shadow 0.125s ease-in-out;
  }

  .space-button[style*="background-image"] {
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:not([data-outer-shadow]):active {
    filter: brightness(0.97);
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:active > div {
    translate: 0 0;
    transform: scale(0.98);
  }

  .space-button:active svg {
    transform: scale(0.95);
  }
</style>
