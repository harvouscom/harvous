---
import SpaceButton from "./SpaceButton.astro";
import FaXmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
---

<!-- Persistent Navigation Component -->
<div id="persistent-navigation" class="flex flex-col items-start justify-start w-full">
  <!-- This will be populated by JavaScript with persistent navigation items -->
</div>

<script>
  // Simple localStorage-based navigation history
  function getNavigationHistory() {
    try {
      const stored = localStorage.getItem('navigation-history');
      return stored ? JSON.parse(stored) : [];
    } catch (error) {
      console.error('âŒ Error getting navigation history:', error);
      return [];
    }
  }
  
  function renderPersistentNavigation() {
    const container = document.getElementById('persistent-navigation');
    if (!container) {
      console.log('âŒ Persistent navigation container not found');
      return;
    }
    
    const history = getNavigationHistory();
    console.log('ðŸ“š Rendering persistent navigation with history:', history);
    
    if (history.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Get currently visible navigation items to avoid duplicates
    const visibleItems = Array.from(document.querySelectorAll('[data-navigation-item]'))
      .map(item => item.getAttribute('data-navigation-item'))
      .filter(id => id !== null);
    
    console.log('ðŸ‘ï¸ Currently visible navigation items:', visibleItems);
    
    // Filter out items that are already visible in regular navigation
    // Also filter out the current page to avoid showing it as inactive
    const currentPath = window.location.pathname;
    const currentItemId = currentPath.startsWith('/') ? currentPath.substring(1) : currentPath;
    
    const persistentItems = history.filter((item: any) => {
      // Don't show if already visible in regular navigation
      if (visibleItems.includes(item.id)) {
        return false;
      }
      // Don't show if it's the current page
      if (item.id === currentItemId) {
        return false;
      }
      // Don't show dashboard
      if (item.id === 'dashboard') {
        return false;
      }
      return true;
    });
    
    console.log('ðŸ“š Items to show in persistent navigation:', persistentItems);
    
    if (persistentItems.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // Sort items by first access time (most recent first access at the top)
    const sortedItems = persistentItems.sort((a: any, b: any) => {
      const aTime = a.firstAccessed || 0;
      const bTime = b.firstAccessed || 0;
      return bTime - aTime; // Most recent first access first
    });
    
    console.log('ðŸ“š Sorted items by first access time:', sortedItems);
    
    // Create navigation items HTML
    const itemsHTML = sortedItems.map((item: any) => {
      const isActive = window.location.pathname === `/${item.id}`;
      
      return `
        <div data-navigation-item="${item.id}" class="w-full nav-item-container ${isActive ? 'active' : ''}">
          <a href="/${item.id}" class="w-full relative block">
            <button
              class="space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group w-full"
              style="${isActive ? `background-image: ${item.backgroundGradient || 'var(--color-gradient-gray)'};` : ''}"
            >
              <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
                <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap">
                  ${item.title}
                </span>
                <!-- Right box - simple flex container for badge -->
                <div class="flex items-center justify-center p-[20px]">
                  <!-- Badge count - show when not hovering -->
                  <div class="badge-count bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-6 h-6">
                    <span class="text-[14px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0]">
                      ${item.count || 0}
                    </span>
                  </div>
                </div>
              </div>
            </button>
            <!-- Close icon - only show for inactive items -->
            ${!isActive ? `
            <div 
              class="close-icon absolute top-1/2 right-5 transform -translate-y-1/2 flex items-center justify-center w-6 h-6 cursor-pointer"
              @click.stop.prevent="if (window.closeNavigationItemWithHistory) { window.closeNavigationItemWithHistory('${item.id}'); } else if (window.closeNavigationItem) { window.closeNavigationItem('${item.id}'); }"
            >
              <svg class="w-4 h-4 fill-current" style="color: var(--color-deep-grey);" viewBox="0 0 384 512">
                <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
              </svg>
            </div>
            ` : ''}
          </a>
        </div>
      `;
    }).join('');
    
    container.innerHTML = itemsHTML;
    
    // Add CSS for hover states - only for inactive items
    const style = document.createElement('style');
    style.textContent = `
      .nav-item-container:not(.active):hover .badge-count {
        display: none !important;
      }
      .nav-item-container:not(.active):hover .close-icon {
        display: flex !important;
      }
      .close-icon {
        display: none;
      }
    `;
    document.head.appendChild(style);
    
    // Re-initialize Alpine.js for the new elements
    if ((window as any).Alpine) {
      setTimeout(() => {
        (window as any).Alpine.initTree(container);
      }, 150);
    } else {
      console.log('âŒ Alpine.js not available for persistent navigation');
    }
  }
  
  // Initialize persistent navigation
  function initializePersistentNavigation() {
    console.log('ðŸš€ Initializing persistent navigation');
    console.log('ðŸš€ Current page:', window.location.pathname);
    console.log('ðŸš€ Navigation history from localStorage:', localStorage.getItem('navigation-history'));
    renderPersistentNavigation();
  }
  
  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializePersistentNavigation);
  } else {
    initializePersistentNavigation();
  }
  
  // Re-initialize after View Transitions
  document.addEventListener('astro:page-load', () => {
    console.log('ðŸ“„ Page loaded, re-initializing persistent navigation');
    initializePersistentNavigation();
  });
  
  // Export for global access
  (window as any).renderPersistentNavigation = renderPersistentNavigation;
</script>

<style>
  /* Reuse SpaceButton styles */
  .space-button {
    will-change: transform;
    transition: box-shadow 0.125s ease-in-out;
  }

  .space-button[style*="background-image"] {
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:not([data-outer-shadow]):active {
    filter: brightness(0.97);
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .space-button:active > div {
    translate: 0 0;
    transform: scale(0.98);
  }

  .space-button:active svg {
    transform: scale(0.95);
  }
</style>