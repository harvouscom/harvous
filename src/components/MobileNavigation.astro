---
import SearchInput from "@/components/SearchInput.astro";
import SpaceButton from "@/components/SpaceButton.astro";
import Avatar from "@/components/Avatar.astro";
import SquareButton from "@/components/SquareButton.astro";

export interface Props {
  spaces?: any[];
  threads?: any[];
  inboxCount?: number;
  currentSpace?: any;
  currentThread?: any;
  initials?: string;
  userColor?: string;
}

const { 
  spaces = [], 
  threads = [], 
  inboxCount = 0,
  currentSpace,
  currentThread,
  initials = 'U',
  userColor = 'paper'
} = Astro.props;

// Debug: Log the props received
console.log('MobileNavigation received props:', { initials, userColor });
---

<div class="grid grid-cols-[auto_1fr_auto] items-center gap-3 w-full min-w-0">
  <!-- Search Icon Button (Column 1: auto) -->
  <SquareButton variant="Search" />

  <!-- Spaces Dropdown (Column 2: 1fr) -->
  <div class="relative min-w-0" x-data="{ open: false }">
    <SpaceButton 
      text={currentThread ? currentThread.title : currentSpace ? currentSpace.title : "For You"}
      count={currentThread ? currentThread.noteCount : currentSpace ? currentSpace.totalItemCount : inboxCount}
      state="DropdownTrigger"
      className="w-full min-w-0"
      backgroundGradient={currentThread?.backgroundGradient || (currentSpace ? "linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)" : "linear-gradient(180deg, var(--color-paper) 0%, var(--color-paper) 100%)")}
      @click="open = !open"
    />
    
    <!-- Dropdown Menu -->
    <div 
      x-show="open" 
      @click.away="open = false"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 scale-95"
      x-transition:enter-end="opacity-100 scale-100"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 scale-100"
      x-transition:leave-end="opacity-0 scale-95"
      class="absolute top-full left-0 mt-2 w-64 bg-white rounded-lg shadow-lg border border-gray-200 z-[9999]"
    >
      <div class="p-2">
        <!-- For You -->
        <a href="/dashboard" class="block w-full">
          <div class="flex items-center justify-between p-2 rounded hover:bg-gray-50">
            <span class="text-sm font-medium">For You</span>
            <span class="text-xs text-gray-500">{inboxCount}</span>
          </div>
        </a>
        
        <!-- Spaces -->
        {spaces.map(space => (
          <a href={`/${space.id}`} class="block w-full">
            <div class="flex items-center justify-between p-2 rounded hover:bg-gray-50">
              <span class="text-sm font-medium">{space.title}</span>
              <span class="text-xs text-gray-500">{space.totalItemCount}</span>
            </div>
          </a>
        ))}
        
        <!-- Threads (context-aware) -->
        {currentThread && (
          <a href={`/${currentThread.id}`} class="block w-full">
            <div class="flex items-center justify-between p-2 rounded hover:bg-gray-50 bg-blue-50">
              <span class="text-sm font-medium">{currentThread.title}</span>
              <span class="text-xs text-blue-600">{currentThread.noteCount}</span>
            </div>
          </a>
        )}
        
        {currentSpace && threads.length > 0 && (
          threads.filter(thread => thread.spaceId === currentSpace.id).map(thread => (
            <a href={`/${thread.id}`} class="block w-full">
              <div class="flex items-center justify-between p-2 rounded hover:bg-gray-50">
                <span class="text-sm font-medium">{thread.title}</span>
                <span class="text-xs text-gray-500">{thread.noteCount}</span>
              </div>
            </a>
          ))
        )}
        

        
        <!-- New Space Button -->
        <a href="/new-space" class="block w-full">
          <div class="flex items-center justify-between p-2 rounded hover:bg-gray-50">
            <span class="text-sm font-medium text-blue-600">New Space</span>
            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Avatar (Column 3: auto) -->
  <a href="/profile">
    <Avatar initials={initials} color={userColor} id="mobile-navigation-avatar" />
  </a>
</div>

<script>
  // Avatar manager is loaded globally via Layout.astro
  // Listen for avatar updates and update the mobile navigation avatar
  document.addEventListener('DOMContentLoaded', () => {
    console.log('MobileNavigation: Setting up avatar update listener');
    
    // Listen for profile updates
    window.addEventListener('updateProfile', async (event: any) => {
      console.log('MobileNavigation: updateProfile event received', event.detail);
      const detail = event.detail;
      
      if (detail) {
        const newInitials = `${detail.firstName.charAt(0) || ''}${detail.lastName.charAt(0) || ''}`.toUpperCase();
        const newColor = detail.selectedColor;
        
        console.log('MobileNavigation: Updating avatar with:', { newInitials, newColor });
        
        // Use the global avatar manager function
        if ((window as any).updateAllAvatars) {
          const result = await (window as any).updateAllAvatars(newColor, newInitials);
          console.log(`MobileNavigation: Updated ${result.updatedCount} avatars`);
        } else {
          console.error('MobileNavigation: Avatar manager not available');
        }
      }
    });
    
    // Also listen for avatar updates from the centralized manager
    window.addEventListener('avatarUpdated', (event: any) => {
      console.log('MobileNavigation: avatarUpdated event received', event.detail);
    });
  });
</script>


