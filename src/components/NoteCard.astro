---
import DOMPurify from "isomorphic-dompurify";
import IconButton from "@/components/IconButton.astro";
import BookmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/bookmark.svg";
import PencilIcon from "@fortawesome/fontawesome-free/svgs/solid/pencil.svg";
import DeleteIcon from "@fortawesome/fontawesome-free/svgs/solid/trash.svg";
import XmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
import ChonkButton from "@/components/ChonkButton.astro";

interface Props {
  title: string;
  content: string;
  id?: number;
  userId?: string;
  threadId?: number;
}

const { title, content, id, userId, threadId } = Astro.props;

const sanitizedContent = DOMPurify.sanitize(content, {
  ALLOWED_TAGS: ["div", "p", "h1", "h2", "h3", "h4", "h5", "h6", "blockquote", "pre", "br"], // Strip all HTML tags
  ALLOWED_ATTR: [] // Strip all attributes
});

// Decode HTML entities and normalize whitespace
const decodedContent = sanitizedContent
  .replace(/<\/(div|p|h[1-6]|blockquote|pre)>/gi, '\n')
  .replace(/<br>/gi, '\n')
  .replace(/<[^>]*>/g, '')
  .replace(/&nbsp;/g, ' ')
  .replace(/&amp;/g, '&')
  .replace(/&lt;/g, '<')
  .replace(/&gt;/g, '>')
  .replace(/&quot;/g, '"')
  .replace(/&#39;/g, "'")
  .trim();

console.log({content, decodedContent});

const trimmedContent = decodedContent.slice(0, 100);
// If we have a threadId, include it in the URL
const noteUrl = id ? (threadId ? `/feed/notes/${id}?threadId=${threadId}` : `/feed/notes/${id}`) : "";
const editUrl = id ? `/feed/notes/${id}/edit` : "";
---

<section
  class="note-card-component h-full max-h-[85px] box-border grid grid-cols-[28px_1fr] bg-white rounded-xl shadow-[var(--shadow-primary)] overflow-hidden w-full relative"
>
  {/* Clickable area over entire card */}
  {id && (
    <a
      href={noteUrl}
      class="absolute inset-0 z-10 cursor-pointer js-note-link note-card"
      data-id={id}
      data-thread-id={threadId}
      data-title={title || "Untitled Note"}
    ></a>
  )}
  
  {/* Side Highlight */}
  <div class="relative h-full w-full bg-[var(--color-light-paper)] py-3">
    {/* Circle Icon */}
    <div class="absolute top-3 -right-4 z-20">
      <button 
        class="icon-btn note-action-btn rounded-full flex items-center justify-center shadow-[0px_-2.91px_0px_0px_#0000001A_inset]"
        style="width: 32px; height: 32px; background-color: var(--color-paper); transition: none !important;"
        data-id={id}
        data-type="note"
        data-user-id={userId}
        data-thread-id={threadId}
      >
        <svg 
          class="normal-icon"
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 384 512" 
          width="15"
          height="15"
          fill="currentColor"
        >
          <path d="M0 48V487.7C0 501.1 10.9 512 24.3 512c5 0 9.9-1.5 14-4.4L192 400 345.7 507.6c4.1 2.9 9 4.4 14 4.4c13.4 0 24.3-10.9 24.3-24.3V48c0-26.5-21.5-48-48-48H48C21.5 0 0 21.5 0 48z"/>
        </svg>
        <svg 
          class="x-icon hidden"
          xmlns="http://www.w3.org/2000/svg" 
          viewBox="0 0 448 512" 
          width="15"
          height="15"
          fill="currentColor"
        >
          <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
        </svg>
      </button>
    </div>
  </div>
  <div class="ps-7 pe-3 flex flex-col gap-1.5 py-3 pointer-events-none">
    <h2
      class="overflow-wrap-anywhere text-[var(--text-color-primary)] text-[14px] font-semibold line-clamp-2"
    >
      {title}
    </h2>
    <p
      class="select-text overflow-wrap-anywhere whitespace-pre-line text-[var(--text-color-secondary)] text-[12px] line-clamp-4"     
    >
      {trimmedContent}
    </p>
  </div>
</section>

<style>
  .overflow-wrap-anywhere {
    overflow-wrap: anywhere;
  }
  
  .icon-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-stone-grey);
    transition: none !important;  /* Override any transitions */
    background-color: var(--color-paper);
  }
  
  .icon-btn.active {
    background-color: var(--color-stone-grey) !important;
    color: white !important;
  }
  
  .normal-icon, .x-icon {
    width: 15px;
    height: 15px;
    fill: currentColor;
  }
  
  .icon-btn.active .normal-icon {
    display: none;
  }
  
  .icon-btn.active .x-icon {
    display: block;
  }
  
  .hidden {
    display: none;
  }
  
  /* Note card specific styling - no animations */
  .note-card-component {
    display: grid;
    min-height: auto;
    transition: none !important;
    transform: none !important;
    rotate: 0deg !important;
  }
  
  /* Explicitly disable hover effects */
  .note-card-component:hover {
    transform: none !important;
    box-shadow: var(--shadow-primary) !important;
  }
</style>

<script>
  // Initialize the action buttons when the DOM loads
  document.addEventListener('DOMContentLoaded', () => {
    const actionButtons = document.querySelectorAll('.note-action-btn');
    
    // Ensure no transitions on card components
    document.querySelectorAll('.note-card-component').forEach(card => {
      (card as HTMLElement).style.transition = 'none';
      (card as HTMLElement).style.transform = 'none';
    });
    
    actionButtons.forEach(button => {
      // Disable any transitions
      (button as HTMLElement).style.transition = 'none';
      
      button.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const id = button.getAttribute('data-id') || '';
        const type = button.getAttribute('data-type') || 'note';
        const userId = button.getAttribute('data-user-id') || '';
        
        // Call the global function if it exists
        if (window.handleActionButtonClick) {
          window.handleActionButtonClick(type, id, userId, button as HTMLElement);
        }
      });
    });
    
    // Prevent navigation when action bar is open
    const noteLinks = document.querySelectorAll('.js-note-link');
    noteLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        const actionBar = document.getElementById('global-action-bar');
        if (actionBar && actionBar.getAttribute('data-visible') === 'true') {
          e.preventDefault();
        }
      });
    });
  });
</script>
