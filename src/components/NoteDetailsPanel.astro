---
import CardStack from "./CardStack.astro";
import TabNav from "./TabNav.astro";
import SpaceButton from "./SpaceButton.astro";
import SquareButton from "./SquareButton.astro";
import CardThread from "./CardThread.astro";
import FaAngleLeftIcon from "@fortawesome/fontawesome-free/svgs/solid/angle-left.svg";
import FaXmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
import FaPlusIcon from "@fortawesome/fontawesome-free/svgs/solid/plus.svg";

export interface Props {
  noteId?: string;
  noteTitle?: string;
  onClose?: () => void;
}

const { noteId, noteTitle = "Note Details", onClose } = Astro.props;

// Get user ID from Clerk authentication
const { userId } = Astro.locals.auth();

if (!userId) {
  return Astro.redirect('/sign-in');
}

// Helper function to format relative time (same as dashboard)
function formatRelativeTime(date: Date): string {
  const now = new Date();
  const diffInMs = now.getTime() - date.getTime();
  const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
  const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
  const diffInMinutes = Math.floor(diffInMs / (1000 * 60));

  if (diffInDays > 0) {
    return diffInDays === 1 ? "1 day ago" : `${diffInDays} days ago`;
  } else if (diffInHours > 0) {
    return diffInHours === 1 ? "1 hour ago" : `${diffInHours} hours ago`;
  } else if (diffInMinutes > 0) {
    return diffInMinutes === 1 ? "1 minute ago" : `${diffInMinutes} minutes ago`;
  } else {
    return "Just now";
  }
}

// Fetch real data from database for this specific note
let noteThreads: any[] = [];
let noteComments: any[] = [];
let noteTags: any[] = [];

// Fetch threads and tags that contain this note
if (noteId) {
  try {
    const { db, Notes, Threads, eq, and, count, ne } = await import('astro:db');
    
    // First check if the note is in thread_unorganized
    const note = await db.select().from(Notes).where(eq(Notes.id, noteId)).get();
    
    // Only fetch threads if the note is NOT in thread_unorganized
    if (note && note.threadId !== 'thread_unorganized') {
      // Get threads that contain this note (excluding thread_unorganized)
      const threadsWithNote = await db
        .select({
          thread: Threads,
          noteCount: count()
        })
        .from(Threads)
        .innerJoin(Notes, eq(Notes.threadId, Threads.id))
        .where(and(
          eq(Threads.userId, userId), 
          eq(Notes.id, noteId),
          ne(Threads.id, 'thread_unorganized') // Exclude unorganized thread
        ));
      
      // Format threads data
      noteThreads = threadsWithNote.map(item => ({
        id: item.thread.id,
        title: item.thread.title,
        count: item.noteCount,
        subtitle: `${item.noteCount} notes`,
        accentColor: `var(--color-${item.thread.color || 'blue'})`,
        lastUpdated: formatRelativeTime(new Date(item.thread.updatedAt || item.thread.createdAt)),
        isPrivate: !item.thread.isPublic
      }));
    } else {
      // Note is in thread_unorganized, so no threads to show
      noteThreads = [];
    }

    // Fetch tags for this note
    try {
      const { Tags, NoteTags } = await import('astro:db');
      
      console.log('Fetching tags for note:', { noteId, userId });
      
      const tagsWithNote = await db
        .select({
          id: NoteTags.id,
          noteId: NoteTags.noteId,
          tagId: NoteTags.tagId,
          isAutoGenerated: NoteTags.isAutoGenerated,
          confidence: NoteTags.confidence,
          createdAt: NoteTags.createdAt,
          tag: {
            id: Tags.id,
            name: Tags.name,
            color: Tags.color,
            category: Tags.category,
            isSystem: Tags.isSystem
          }
        })
        .from(NoteTags)
        .innerJoin(Tags, eq(NoteTags.tagId, Tags.id))
        .where(and(eq(NoteTags.noteId, noteId), eq(Tags.userId, userId)));

      console.log('Raw tags query result:', {
        noteId,
        userId,
        tagCount: tagsWithNote.length,
        tags: tagsWithNote.map(t => ({
          name: t.tag.name,
          isAutoGenerated: t.isAutoGenerated,
          confidence: t.confidence
        }))
      });

      // Format tags data
      noteTags = tagsWithNote.map(item => ({
        id: item.tag.id,
        name: item.tag.name,
        color: item.tag.color || '#006eff',
        category: item.tag.category || 'spiritual',
        isAutoGenerated: item.isAutoGenerated,
        confidence: item.confidence,
        isSystem: item.tag.isSystem
      }));
      
      console.log('Formatted tags for display:', {
        noteId,
        tagCount: noteTags.length,
        tags: noteTags.map(t => ({
          name: t.name,
          isAutoGenerated: t.isAutoGenerated,
          confidence: t.confidence
        }))
      });
    } catch (error) {
      console.log('Error fetching tags:', error);
      noteTags = [];
    }

  } catch (error) {
    console.error("Error fetching note data:", error);
    noteThreads = [];
    noteTags = [];
  }
}

---

<div 
  class="note-details-panel h-full flex flex-col justify-between"
  data-threads={JSON.stringify(noteThreads)}
  data-comments={JSON.stringify(noteComments)}
  data-tags={JSON.stringify(noteTags)}
  data-note-id={noteId}
  x-data="{ 
    activeTab: 'threads',
    threads: [],
    comments: [],
    tags: [],
    noteId: '',
    
    init() {
      this.noteId = this.$el.getAttribute('data-note-id') || '';
      this.loadData();
      
      // Listen for panel opening
      window.addEventListener('openNoteDetailsPanel', () => {
        this.loadData();
      });
    },
    
    switchTab(tabId) {
      this.activeTab = tabId;
    },
    
    closePanel() {
      // Dispatch close event to hide the panel
      window.dispatchEvent(new CustomEvent('closeNoteDetailsPanel'));
      console.log('closePanel called - dispatching closeNoteDetailsPanel event');
    },
    
    loadData() {
      // Use the real data from data attributes
      this.threads = JSON.parse(this.$el.getAttribute('data-threads') || '[]');
      this.comments = JSON.parse(this.$el.getAttribute('data-comments') || '[]');
      this.tags = JSON.parse(this.$el.getAttribute('data-tags') || '[]');
      
      // Update the display based on data availability
      if (this.threads.length === 0) {
        this.activeTab = 'comments'; // Switch to comments if no threads
      }
    },

    async addNewTag() {
      const tagName = prompt('Enter tag name:');
      if (tagName && tagName.trim()) {
        try {
          // Create the tag
          const createResponse = await fetch('/api/tags/create', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: tagName.trim(),
              color: '#006eff',
              category: 'spiritual'
            })
          });

          if (createResponse.ok) {
            const result = await createResponse.json();
            
            // Assign the tag to the note
            const assignResponse = await fetch('/api/note-tags/assign', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                noteId: this.noteId,
                tagId: result.tag.id
              })
            });

            if (assignResponse.ok) {
              // Reload the panel data
              await this.loadData();
              alert('Tag created and assigned successfully!');
            } else {
              const errorData = await assignResponse.json();
              console.error('Assign error:', errorData);
              alert('Tag created but failed to assign to note: ' + (errorData.error || 'Unknown error'));
            }
          } else {
            const errorData = await createResponse.json();
            console.error('Create error:', errorData);
            alert('Failed to create tag: ' + (errorData.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error creating tag:', error);
          alert('Error creating tag: ' + error.message);
        }
      }
    }

  }"
>
  <!-- Content area that expands to fill available space -->
  <div class="flex-1 flex flex-col min-h-0 mb-3.5">
    <!-- Single unified panel using CardStack structure -->
    <CardStack 
      title="Details"
      headerBgColor="var(--color-paper)"
      centerTitle={true}
      class="h-full"
    >
      <!-- Tab navigation -->
      <div class="w-full">
        <div class="flex flex-col gap-3">
          <div class="tab-nav-container">
            <!-- Tab Navigation -->
            <div class="flex items-center justify-start gap-0 pb-0 pt-1 px-1 relative w-full overflow-x-auto">
              <button
                type="button"
                class="flex gap-2 h-11 items-center justify-center overflow-clip px-2 py-3 relative shrink-0 transition-all duration-200"
                :class="activeTab === 'threads' ? 'opacity-100' : 'opacity-50 hover:opacity-75'"
                @click="switchTab('threads')"
                data-tab-id="threads"
                :data-active="activeTab === 'threads' ? 'true' : 'false'"
              >
                <span class="font-sans font-semibold text-[14px] leading-[0] relative shrink-0 text-nowrap text-[#4a473d]">
                  Threads
                </span>
                <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-5 h-5">
                  <span class="text-[12px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0] badge-number" x-text="threads.length"></span>
                </div>
                <div 
                  class="absolute bottom-0 left-1/2 translate-x-[-50%] w-1 h-1" 
                  x-show="activeTab === 'threads'"
                >
                  <div class="w-1 h-1 bg-[#4a473d] rounded-full"></div>
                </div>
              </button>
              
              <button
                type="button"
                class="flex gap-2 h-11 items-center justify-center overflow-clip px-2 py-3 relative shrink-0 transition-all duration-200"
                :class="activeTab === 'comments' ? 'opacity-100' : 'opacity-50 hover:opacity-75'"
                @click="switchTab('comments')"
                data-tab-id="comments"
                :data-active="activeTab === 'comments' ? 'true' : 'false'"
              >
                <span class="font-sans font-semibold text-[14px] leading-[0] relative shrink-0 text-nowrap text-[#4a473d]">
                  Comments
                </span>
                <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-5 h-5">
                  <span class="text-[12px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0] badge-number" x-text="comments.length"></span>
                </div>
                <div 
                  class="absolute bottom-0 left-1/2 translate-x-[-50%] w-1 h-1" 
                  x-show="activeTab === 'comments'"
                >
                  <div class="w-1 h-1 bg-[#4a473d] rounded-full"></div>
                </div>
              </button>
              
              <button
                type="button"
                class="flex gap-2 h-11 items-center justify-center overflow-clip px-2 py-3 relative shrink-0 transition-all duration-200"
                :class="activeTab === 'tags' ? 'opacity-100' : 'opacity-50 hover:opacity-75'"
                @click="switchTab('tags')"
                data-tab-id="tags"
                :data-active="activeTab === 'tags' ? 'true' : 'false'"
              >
                <span class="font-sans font-semibold text-[14px] leading-[0] relative shrink-0 text-nowrap text-[#4a473d]">
                  Tags
                </span>
                <div class="bg-[rgba(120,118,111,0.1)] flex items-center justify-center rounded-3xl w-5 h-5">
                  <span class="text-[12px] font-sans font-semibold text-[var(--color-deep-grey)] leading-[0] badge-number" x-text="tags.length"></span>
                </div>
                <div 
                  class="absolute bottom-0 left-1/2 translate-x-[-50%] w-1 h-1" 
                  x-show="activeTab === 'tags'"
                >
                  <div class="w-1 h-1 bg-[#4a473d] rounded-full"></div>
                </div>
              </button>
            </div>
          </div>
          
          <!-- Tab content -->
          <div class="w-full">
            <!-- Threads content - shows threads that contain this note (one-to-many relationship) -->
            <div x-show="activeTab === 'threads'" class="tab-content">
              <div class="flex flex-col gap-3">
                {noteThreads.length === 0 ? (
                  <div class="text-center py-4 text-gray-500">
                    <p>This note is not in any threads.</p>
                  </div>
                ) : (
                  <div class="flex flex-col gap-3">
                  {noteThreads.map(thread => (
                    <div class="content-item thread-item">
                      <a 
                        href={`/${thread.id}`}
                        class="block transition-transform duration-200 hover:scale-[1.002]"
                      >
                        <CardThread 
                          title={thread.title}
                          subtitle={thread.subtitle}
                          count={thread.count}
                          accentColor={thread.accentColor}
                          lastUpdated={thread.lastUpdated}
                          isPrivate={thread.isPrivate}
                        />
                      </a>
                    </div>
                  ))}
                  </div>
                )}
              </div>
            </div>
            
            <!-- Comments content -->
            <div x-show="activeTab === 'comments'" class="tab-content">
              <div class="flex flex-col gap-3">
                <div x-show="comments.length === 0" class="text-center py-4 text-gray-500">
                  <p>No comments found for this note.</p>
                </div>
                <div x-show="comments.length > 0" class="flex flex-col gap-3">
                  <template x-for="comment in comments" :key="comment.id">
                    <div class="bg-white p-4 rounded-xl border border-gray-200">
                      <div class="flex justify-between items-start mb-2">
                        <span class="font-semibold text-sm text-gray-600" x-text="comment.author"></span>
                        <span class="text-xs text-gray-500" x-text="comment.date"></span>
                      </div>
                      <p class="text-gray-800" x-text="comment.content"></p>
                    </div>
                  </template>
                </div>
              </div>
            </div>
            
            <!-- Tags content -->
            <div x-show="activeTab === 'tags'" class="tab-content">
              <div class="flex flex-col gap-3">
                <div x-show="tags.length === 0" class="text-center py-4 text-gray-500">
                  <p>No tags found for this note.</p>
                  <p class="text-sm mt-1">Tags are automatically generated based on your note content when you create or update notes.</p>
                </div>
                <div x-show="tags.length > 0" class="flex flex-col gap-3">
                  <template x-for="tag in tags" :key="tag.id">
                    <div class="content-item tag-item">
                      <div class="relative nav-item-container">
                        <button
                          class="space-button relative rounded-xl h-[64px] cursor-pointer transition-[scale,shadow] duration-300 pl-4 pr-0 group w-full"
                          style="background-image: var(--color-gradient-gray);"
                        >
                          <div class="flex items-center justify-between relative w-full h-full pl-2 pr-0 transition-transform duration-125">
                            <span class="text-[var(--color-deep-grey)] font-sans text-[18px] font-semibold whitespace-nowrap" x-text="tag.name"></span>
                          </div>
                        </button>
                        <!-- Close icon - always visible for tags -->
                        <div
                          onclick="removeTagFromNote(event, this)"
                          class="close-icon absolute top-1/2 right-5 transform -translate-y-1/2 flex items-center justify-center w-6 h-6 cursor-pointer"
                          :data-item-id="tag.id"
                        >
                          <svg class="w-4 h-4 fill-current" style="color: var(--color-deep-grey);" viewBox="0 0 384 512">
                            <path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z"/>
                          </svg>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
                
                <!-- New Tag button -->
                <div class="w-full">
                  <button 
                    type="button"
                    class="bg-[#006eff] box-border content-stretch flex h-[60px] items-center justify-center overflow-clip pb-[28px] pt-6 px-6 relative rounded-3xl shrink-0 w-full"
                    @click="addNewTag()"
                  >
                    <div class="font-sans font-semibold leading-[0] relative shrink-0 text-[#f7f7f6] text-[18px] text-nowrap">
                      New Tag
                    </div>
                    <div class="absolute inset-0 pointer-events-none rounded-3xl shadow-[0px_-4px_0px_0px_rgba(0,0,0,0.1)_inset]"></div>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </CardStack>
  </div>

  <!-- Bottom back button -->
  <div class="flex items-center justify-start gap-3">
    <div @click.prevent="closePanel()">
      <SquareButton variant="Back" type="button" />
    </div>
  </div>
</div>

<script>

  // Global functions for tag management
  
  (window as any).removeThread = function(threadId: string) {
    if (confirm('Are you sure you want to remove this note from this thread?')) {
      const panel = document.querySelector('.note-details-panel');
      if (panel && (window as any).Alpine) {
        const alpineData = (window as any).Alpine.$data(panel);
        if (alpineData) {
          alpineData.threads = alpineData.threads.filter((t: any) => t.id !== threadId);
        }
      }
    }
  };
  
  (window as any).removeTag = function(tagId: string) {
    if (confirm('Are you sure you want to remove this tag?')) {
      const panel = document.querySelector('.note-details-panel');
      if (panel && (window as any).Alpine) {
        const alpineData = (window as any).Alpine.$data(panel);
        if (alpineData) {
          alpineData.tags = alpineData.tags.filter((t: any) => t.id !== tagId);
        }
      }
    }
  };

  (window as any).removeTagFromNote = async function(event: Event, element: HTMLElement) {
    event.stopPropagation();
    
    const tagId = element.getAttribute('data-item-id');
    const noteId = document.querySelector('.note-details-panel')?.getAttribute('data-note-id');
    
    if (!tagId || !noteId) {
      alert('Missing tag or note ID');
      return;
    }

    if (confirm('Are you sure you want to remove this tag from the note?')) {
      try {
        const response = await fetch(`/api/note-tags/remove?noteId=${noteId}&tagId=${tagId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          // Reload the panel data
          const panel = document.querySelector('.note-details-panel');
          if (panel && (window as any).Alpine) {
            const alpineData = (window as any).Alpine.$data(panel);
            if (alpineData && alpineData.loadData) {
              await alpineData.loadData();
            }
          }
          alert('Tag removed from note successfully!');
        } else {
          alert('Failed to remove tag from note');
        }
      } catch (error) {
        console.error('Error removing tag from note:', error);
        alert('Error removing tag from note');
      }
    }
  };
</script>

<style>
  /* Tab content styling */
  .tab-content {
    min-height: 200px;
  }
  
  /* Tab navigation styling */
  .tab-nav-container {
    width: 100%;
  }
  
  .tab-nav-container button {
    min-width: 120px;
    white-space: nowrap;
  }
  
  
  /* Thread and tag button styling */
  .note-details-panel .box-border[style*="background-image"] {
    box-shadow: 0px -3px 0px 0px rgba(176, 176, 176, 0.25) inset;
  }
  
  .note-details-panel .box-border[style*="background-color"] {
    box-shadow: 0px -3px 0px 0px rgba(176, 176, 176, 0.25) inset;
  }
  
  /* Space button styling for tags */
  .note-details-panel .space-button {
    will-change: transform;
    transition: box-shadow 0.125s ease-in-out;
  }

  .note-details-panel .space-button[style*="background-image"] {
    box-shadow: 0px -3px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .note-details-panel .space-button:not([data-outer-shadow]):active {
    filter: brightness(0.97);
    box-shadow: 
      0px -1px 0px 0px rgba(120, 118, 111, 0.2) inset,
      0px 1px 0px 0px rgba(120, 118, 111, 0.2) inset;
  }

  .note-details-panel .space-button:active > div {
    translate: 0 0;
    transform: scale(0.98);
  }
  
  /* Tag styling - always show close icon */
  .tag-item .close-icon {
    display: flex !important;
  }

  /* Close icon hover states for tags */
  .note-details-panel .nav-item-container:hover .badge-count {
    display: none !important;
  }
  .note-details-panel .nav-item-container:hover .close-icon {
    display: flex !important;
  }
  .note-details-panel .close-icon {
    display: none;
  }
  
  /* New tag button styling */
  .note-details-panel button[style*="background-color: #006eff"] {
    box-shadow: 0px -4px 0px 0px rgba(0, 0, 0, 0.1) inset;
  }
  
  .note-details-panel button[style*="background-color: #006eff"]:active {
    transform: scale(0.98);
    box-shadow: 0px -2px 0px 0px rgba(0, 0, 0, 0.1) inset;
  }
</style>

