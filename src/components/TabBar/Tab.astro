---
interface Props {
  label: string;
  href?: string;
  active?: boolean;
  closable?: boolean;
  color?: string;
}

const { label, href, active = false, closable = false, color }: Props = Astro.props;

// Determine which localStorage item to remove based on the tab label
let storageKey = null;
let closeAction = "";

if (label === 'Note') {
  storageKey = 'lastViewedNote';
  closeAction = `
    try {
      // Ultra-efficient DOM-minimal approach
      const sourceThread = localStorage.getItem('sourceThreadForNote');
      localStorage.removeItem('lastViewedNote');
      localStorage.removeItem('noteEditState');
      
      if (sourceThread) {
        window.location.href = '/feed/threads/' + sourceThread;
      } else {
        localStorage.removeItem('sourceThreadForNote');
        window.location.href='/feed';
      }
    } catch(e) {
      // Fallback if anything fails
      window.location.href='/feed';
    }
  `;
} else if (label === 'Thread') {
  storageKey = 'lastViewedThread';
  closeAction = `
    try {
      // Batch localStorage operations together
      localStorage.removeItem('lastViewedThread'); 
      localStorage.removeItem('sourceThreadForNote'); 
      localStorage.removeItem('lastViewedNote');
      localStorage.removeItem('noteEditState');
      window.location.href='/feed';
    } catch(e) {
      // Fallback if anything fails
      window.location.href='/feed';
    }
  `;
}

// Different padding based on whether it's closable or not
const paddingStyle = closable 
  ? "pl-[20px] pr-[12px] py-3 flex items-center gap-2"
  : "px-[20px] py-3 flex items-center";

// Text color based on active state
const textColor = active ? "text-(--color-deep-grey)" : "text-(--color-stone-grey)";
---

<div class="h-[48px]">
  {active ? (
    <div 
      class="h-full rounded-t-lg flex items-center" 
      role="tab"
      style={color ? `background-color: var(--color-${color})` : "background-color: var(--color-soft-paper)"}
    >
      <div class={`h-full flex items-center ${closable ? 'pl-[20px] pr-[12px] gap-2' : 'px-[20px]'}`}>
        <span class={`font-bold text-sm ${textColor}`}>{label}</span>
        {closable && (
          <button 
            class={`w-[15px] h-[15px] flex items-center justify-center text-[15px] font-medium ${textColor} cursor-pointer close-tab-btn will-change-opacity touch-manipulation`}
            data-action={closeAction}
            data-tab-type={label}
            aria-label={`Close ${label} tab`}
          >×</button>
        )}
      </div>
    </div>
  ) : (
    <a 
      href={href} 
      class="h-full rounded-t-lg bg-(--color-fog-white) flex items-center" 
      role="tab"
    >
      <div class={`h-full flex items-center ${closable ? 'pl-[20px] pr-[12px] gap-2' : 'px-[20px]'}`}>
        <span class={`font-bold text-sm ${textColor}`}>{label}</span>
        {closable && (
          <button 
            class={`w-[15px] h-[15px] flex items-center justify-center text-[15px] font-medium ${textColor} cursor-pointer close-tab-btn will-change-opacity touch-manipulation`}
            data-action={closeAction}
            data-tab-type={label}
            type="button"
            aria-label={`Close ${label} tab`}
          >×</button>
        )}
      </div>
    </a>
  )}
</div>

<style>
  .tab-text {
    text-box: trim-both cap alphabetic;
  }
  
  .close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Remove any default margins that could cause gaps */
  .tab {
    margin: 0;
  }

  button {
    padding: 0;
    border: none;
    background: transparent;
    line-height: 1;
  }
  
  /* Performance optimizations */
  .will-change-opacity {
    will-change: opacity;
  }
  
  .touch-manipulation {
    touch-action: manipulation;
  }
</style>

<script>
  // More efficient event delegation approach
  document.addEventListener('DOMContentLoaded', () => {
    // Use a single event listener at the document level for clicks
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      
      // Check if the clicked element is a close button
      if (target.classList.contains('close-tab-btn')) {
        e.preventDefault();
        e.stopPropagation();
        
        // Get the action from data attribute
        const action = target.getAttribute('data-action');
        if (action) {
          // Use Function constructor to avoid eval
          new Function(action)();
        }
      }
    });
    
    // Call tab interaction optimizer if it exists (from our special script)
    if (window.tabInteractionOptimizer) {
      window.tabInteractionOptimizer.optimize();
    }
  });
  
  // Make TypeScript happy with our global
  declare global {
    interface Window {
      tabInteractionOptimizer?: {
        optimize: () => void;
      };
    }
  }
</script>