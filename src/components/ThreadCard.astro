---
import LockIcon from "@fortawesome/fontawesome-free/svgs/solid/lock.svg";
import GlobeIcon from "@fortawesome/fontawesome-free/svgs/solid/globe.svg";
import XmarkIcon from "@fortawesome/fontawesome-free/svgs/solid/xmark.svg";
import NoteCardPlaceholder from "./NoteCardPlaceholder.astro";

interface Props {
  title: string;
  isPublic: boolean;
  color?: string;
  id?: number;
  userId?: string;
  noteCount?: number;
}

const { title, isPublic, color, id, userId, noteCount = 0 } = Astro.props;

// Convert color name to CSS variable if provided
const colorStyle = color ? `background-color: var(--color-${color})` : '';
const sideHighlightStyle = color ? `background-color: var(--color-${color})` : 'background-color: var(--color-light-paper)';
const threadUrl = id ? `/feed/threads/${id}` : "";

// Limit the number of note cards to render for performance
const maxVisibleCards = Math.min(10, noteCount);
---

<section
  class="thread-card flex h-[85px] rounded-xl bg-white shadow-[var(--shadow-primary)] overflow-hidden relative will-change-transform"
>
  {/* Clickable area over entire card */}
  {id && (
    <a
      href={threadUrl}
      class="absolute inset-0 z-[1] cursor-pointer js-thread-link thread-card"
      data-id={id}
      data-title={title || "Untitled Thread"}
    ></a>
  )}

  <div class="flex w-full">
    {/* Side Highlight */}
    <div class="w-[36px] h-full" style={sideHighlightStyle}></div>
    
    <div class="flex-1 relative">
      <div class="absolute left-[-22px] top-3 z-20">
        <button 
          class="icon-btn thread-action-btn rounded-full w-[44px] h-[44px] flex items-center justify-center shadow-[0px_-2.91px_0px_0px_#0000001A_inset]"
          style="background-color: var(--color-paper);"
          data-id={id}
          data-type="thread"
          data-user-id={userId}
        >
          {isPublic ? (
            <svg 
              class="normal-icon"
              xmlns="http://www.w3.org/2000/svg" 
              viewBox="0 0 512 512" 
              width="20"
              height="20"
              fill="currentColor"
            >
              <path d="M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64H348.7c2.2 20.4 3.3 41.8 3.3 64zm28.8-64H503.9c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6c78.3 20.7 142 77.5 171.9 151.6zm-149.1 0H167.7c6.1-36.4 15.5-68.6 27-94.7c10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5c11.6 26 20.9 58.2 27 94.7zm-209 0H18.6C48.6 85.9 112.2 29.1 190.6 8.4C165.1 42.6 145.3 96.1 135.3 160zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zM194.7 446.6c-11.6-26-20.9-58.2-27-94.6H344.3c-6.1 36.4-15.5 68.6-27 94.6c-10.5 23.6-22.2 40.7-33.5 51.5C272.6 508.8 263.3 512 256 512s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6C112.2 482.9 48.6 426.1 18.6 352H135.3zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6c25.5-34.2 45.2-87.7 55.3-151.6H493.4z"/>
            </svg>
          ) : (
            <svg 
              class="normal-icon"
              xmlns="http://www.w3.org/2000/svg" 
              viewBox="0 0 448 512" 
              width="20"
              height="20"
              fill="currentColor"
            >
              <path d="M144 144v48H304V144c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192V144C80 64.5 144.5 0 224 0s144 64.5 144 144v48h16c35.3 0 64 28.7 64 64V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V256c0-35.3 28.7-64 64-64H80z"/>
            </svg>
          )}
          <svg 
            class="x-icon hidden"
            xmlns="http://www.w3.org/2000/svg" 
            viewBox="0 0 448 512" 
            width="20"
            height="20"
            fill="currentColor"
          >
            <path d="M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z"/>
          </svg>
        </button>
      </div>
      
      <div class="pl-[34px] pt-3">
        <div class="h-[44px] flex items-center pointer-events-none">
          <h3
            class="overflow-wrap-anywhere text-[var(--Deep-Gray,#4A473D)] text-[18px] font-semibold line-clamp-2 leading-[100%]"
          >
            {title}
          </h3>
        </div>
      </div>
      
      {/* Note cards visualization - staggered cards */}
      {noteCount > 0 && (
        <div class="absolute top-[64px] note-cards-container" style="left: 12px;">
          <div class="stacked-cards-wrapper">
            {/* Display limited notes for performance */}
            {[...Array(maxVisibleCards)].map((_, i) => (
              <NoteCardPlaceholder 
                color={color} 
                offset={i * 25}
                index={maxVisibleCards - i - 1}
                style={`--delay: ${i * 40}ms;`}
              />
            ))}
            {noteCount > maxVisibleCards && (
              <div class="more-notes">+{noteCount - maxVisibleCards}</div>
            )}
          </div>
        </div>
      )}
    </div>
  </div>
</section>

<style>
  .thread-card {
    transition: transform 0.2s ease-out;
    contain: layout style;
  }
  
  .overflow-wrap-anywhere {
    overflow-wrap: anywhere;
  }
  
  .icon-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-stone-grey);
    transition: all 0.2s ease-in-out;
    background-color: var(--color-paper);
  }
  
  .icon-btn.active {
    background-color: var(--color-stone-grey) !important;
    color: white !important;
  }
  
  .normal-icon, .x-icon {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }
  
  .icon-btn.active .normal-icon {
    display: none;
  }
  
  .icon-btn.active .x-icon {
    display: block;
  }
  
  .hidden {
    display: none;
  }
  
  /* Stacked cards visualization styles */
  .stacked-cards-wrapper {
    position: relative;
    width: 400px; /* Provide enough width for the cards */
    height: 140px; /* Match card height */
    overflow: visible;
    z-index: 0;
    pointer-events: auto;
    contain: layout style;
  }
  
  .note-cards-container {
    transition: transform 0.2s ease-out;
    height: 140px;
    width: 100%;
    contain: layout style;
    will-change: transform;
  }
  
  .more-notes {
    position: absolute;
    right: 10px;
    bottom: 5px;
    font-size: 14px;
    color: var(--color-stone-grey);
    font-weight: 600;
    z-index: 1;
  }
</style>

<script>
  // Initialize the action buttons when the DOM loads
  document.addEventListener('DOMContentLoaded', () => {
    // Use event delegation for better performance
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      
      // Find the action button (could be the button or an SVG inside it)
      const actionButton = target.closest('.thread-action-btn');
      
      if (actionButton) {
        e.preventDefault();
        e.stopPropagation();
        
        const id = actionButton.getAttribute('data-id') || '';
        const type = actionButton.getAttribute('data-type') || 'thread';
        const userId = actionButton.getAttribute('data-user-id') || '';
        
        // Call the global function if it exists
        if (window.handleActionButtonClick) {
          window.handleActionButtonClick(type, id, userId, actionButton as HTMLElement);
        }
      }
    });
    
    // Check if global action bar is visible - use event delegation
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      const threadLink = target.closest('.js-thread-link');
      
      if (threadLink) {
        const actionBar = document.getElementById('global-action-bar');
        if (actionBar && actionBar.getAttribute('data-visible') === 'true') {
          e.preventDefault();
        }
      }
    });
    
    // Setup hover animations for thread cards - only if needed
    const threadCards = document.querySelectorAll('.thread-card');
    
    // Use IntersectionObserver to only animate visible cards
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        // Store a reference to the card
        const card = entry.target as HTMLElement;
        
        if (entry.isIntersecting) {
          // Add hover listeners only when visible
          card.addEventListener('mouseenter', cardHoverIn);
          card.addEventListener('mouseleave', cardHoverOut);
        } else {
          // Remove listeners when not visible
          card.removeEventListener('mouseenter', cardHoverIn);
          card.removeEventListener('mouseleave', cardHoverOut);
        }
      });
    });
    
    // Function for mouseenter
    function cardHoverIn(e: MouseEvent) {
      const card = e.currentTarget as HTMLElement;
      const noteCards = card.querySelectorAll('.note-card-placeholder');
      
      // Use requestAnimationFrame for smoother animations
      requestAnimationFrame(() => {
        noteCards.forEach((noteCard) => {
          (noteCard as HTMLElement).classList.add('hover-active');
        });
      });
    }
    
    // Function for mouseleave
    function cardHoverOut(e: MouseEvent) {
      const card = e.currentTarget as HTMLElement;
      const noteCards = card.querySelectorAll('.note-card-placeholder');
      
      requestAnimationFrame(() => {
        noteCards.forEach((noteCard) => {
          (noteCard as HTMLElement).classList.remove('hover-active');
        });
      });
    }
    
    // Observe each thread card
    threadCards.forEach(card => {
      observer.observe(card);
    });
  });
</script> 