---
import CardStack from "./CardStack.astro";
import SquareButton from "./SquareButton.astro";
import Button from "./Button.astro";

interface Props {
  firstName?: string;
  lastName?: string;
  selectedColor?: string;
}

const { 
  firstName = "Derek", 
  lastName = "Jensen", 
  selectedColor = "paper" 
} = Astro.props;

// Create a unique ID for this component instance
const componentId = `edit-panel-${Math.random().toString(36).substr(2, 9)}`;
---

<script>
  // Set initial values in a global object before Alpine.js initializes
  (window as any).editPanelProps = {
    firstName: '{firstName}',
    lastName: '{lastName}',
    selectedColor: '{selectedColor}'
  };
  console.log('Set editPanelProps:', (window as any).editPanelProps);
  
  // Also set the actual values directly from the component props
  (window as any).editPanelActualProps = {
    firstName: '{firstName}',
    lastName: '{lastName}',
    selectedColor: '{selectedColor}'
  };
  console.log('Set editPanelActualProps:', (window as any).editPanelActualProps);
</script>

<div 
  class="edit-name-color-panel flex flex-col"
  data-component-id="{componentId}"
  data-first-name="{firstName}"
  data-last-name="{lastName}"
  data-selected-color="{selectedColor}"
  x-data="{ 
    firstName: '',
    lastName: '',
    selectedColor: 'paper',
    isLoading: false,
    validationErrors: {},
    THREAD_COLORS: ['paper', 'blue', 'yellow', 'orange', 'pink', 'purple', 'green'],
    get firstNamePlaceholder() {
      return this.firstName ? '' : 'First Name';
    },
    get lastNamePlaceholder() {
      return this.lastName ? '' : 'Last Name';
    },
    get hasValidationErrors() {
      return Object.keys(this.validationErrors).length > 0;
    },
    get isFormValid() {
      return this.firstName.trim() && this.lastName.trim() && !this.hasValidationErrors;
    },
    getThreadColorCSS(color) {
      if (!color) return 'var(--color-paper)';
      const colorMap = {
        'paper': 'var(--color-paper)',
        'blue': 'var(--color-blue)',
        'yellow': 'var(--color-yellow)',
        'green': 'var(--color-green)',
        'pink': 'var(--color-pink)',
        'orange': 'var(--color-orange)',
        'purple': 'var(--color-purple)'
      };
      return colorMap[color] || 'var(--color-paper)';
    },
    getThreadTextColorCSS(color) {
      if (!color || color === 'paper') {
        return 'var(--color-deep-grey)';
      }
      return 'white';
    },
    async updateProfile() {
      try {
        console.log('updateProfile called with:', {
          firstName: this.firstName,
          lastName: this.lastName,
          selectedColor: this.selectedColor
        });
        
        // Validate that we have required data
        if (!this.firstName || !this.lastName) {
          console.error('Cannot update profile: firstName or lastName is empty');
          window.dispatchEvent(new CustomEvent('toast', {
            detail: {
              message: 'Please enter both first and last name',
              type: 'error'
            }
          }));
          return;
        }
        
        const event = new CustomEvent('updateProfile', {
          detail: {
            firstName: this.firstName,
            lastName: this.lastName,
            selectedColor: this.selectedColor
          }
        });
        
        window.dispatchEvent(event);
        
        setTimeout(() => {
          if (window.closeProfilePanel) {
            window.closeProfilePanel();
          } else {
            window.dispatchEvent(new CustomEvent('closeProfilePanel'));
          }
        }, 500);
      } catch (error) {
        console.error('Error in updateProfile:', error);
      }
    }
  }"
  x-transition:enter="transition ease-out duration-200"
  x-transition:enter-start="opacity-0 transform scale-95"
  x-transition:enter-end="opacity-100 transform scale-100"
  x-transition:leave="transition ease-in duration-150"
  x-transition:leave-start="opacity-100 transform scale-100"
  x-transition:leave-end="opacity-0 transform scale-95"
  x-init="
    // Read initial data from data attributes (which Astro properly interpolates)
    const firstNameFromAttr = $el.getAttribute('data-first-name') || '';
    const lastNameFromAttr = $el.getAttribute('data-last-name') || '';
    const selectedColorFromAttr = $el.getAttribute('data-selected-color') || 'paper';
    
    // Initialize with data from attributes
    this.firstName = firstNameFromAttr;
    this.lastName = lastNameFromAttr;
    this.selectedColor = selectedColorFromAttr;
    
    console.log('EditNameColorPanel initialized with data from attributes:');
    console.log('  firstName:', this.firstName);
    console.log('  lastName:', this.lastName);
    console.log('  selectedColor:', this.selectedColor);
    console.log('  firstNamePlaceholder:', this.firstNamePlaceholder);
    console.log('  lastNamePlaceholder:', this.lastNamePlaceholder);
    
    // Request fresh data from parent to ensure we have the latest values
    window.dispatchEvent(new CustomEvent('requestProfileData'));
    
    // Listen for profile updates from parent
    window.addEventListener('updateProfile', (event) => {
      console.log('updateProfile event received in EditNameColorPanel.astro');
      const detail = event.detail;
      console.log('Event detail:', detail);
      
      if (detail) {
        console.log('Updating EditNameColorPanel with new data:', detail);
        this.firstName = detail.firstName || this.firstName;
        this.lastName = detail.lastName || this.lastName;
        this.selectedColor = detail.selectedColor || detail.userColor || this.selectedColor;
        
        console.log('EditNameColorPanel data after update - firstName:', this.firstName, 'lastName:', this.lastName, 'selectedColor:', this.selectedColor);
        console.log('firstNamePlaceholder:', this.firstNamePlaceholder);
        console.log('lastNamePlaceholder:', this.lastNamePlaceholder);
      }
    });
  "
>
  <!-- Compact CardStack structure -->
  <div class="bg-white rounded-3xl shadow-[0px_3px_20px_0px_rgba(120,118,111,0.1)] w-full">
    <!-- Header section with dynamic background -->
    <div class="box-border content-stretch flex gap-3 items-center justify-center leading-[0] mb-[-24px] not-italic pb-12 pt-6 px-6 relative shrink-0 w-full rounded-t-3xl" x-bind:style="`background-color: ${getThreadColorCSS(selectedColor)}; color: ${getThreadTextColorCSS(selectedColor)}`">
      <div class="basis-0 font-sans font-bold grow min-h-px min-w-px relative shrink-0 text-[24px] text-center">
        <p class="leading-[normal]">Edit Name & Color</p>
      </div>
    </div>
    
    <!-- Content area -->
    <div class="bg-[var(--color-snow-white)] box-border content-stretch flex flex-col gap-3 items-start justify-start p-[12px] relative rounded-b-3xl rounded-tl-[24px] rounded-tr-[24px] w-full">
      
      <!-- First Name Input -->
      <div class="search-input rounded-3xl py-5 px-4 min-h-[64px] w-full">
        <input 
          type="text"
          x-model="firstName"
          class="outline-none bg-transparent text-[18px] font-semibold text-[var(--color-deep-grey)] text-center placeholder:text-[var(--color-pebble-grey)] w-full" 
          :placeholder="firstNamePlaceholder"
        />
      </div>
      
      <!-- Last Name Input -->
      <div class="search-input rounded-3xl py-5 px-4 min-h-[64px] w-full">
        <input 
          type="text"
          x-model="lastName"
          class="outline-none bg-transparent text-[18px] font-semibold text-[var(--color-deep-grey)] text-center placeholder:text-[var(--color-pebble-grey)] w-full" 
          :placeholder="lastNamePlaceholder"
        />
      </div>
      
      <!-- Color selection -->
      <div class="color-selection flex gap-2 items-center justify-start w-full">
        <template x-for="color in THREAD_COLORS" :key="color">
          <button 
            type="button"
            @click="selectedColor = color"
            class="relative rounded-xl size-10 cursor-pointer transition-all duration-200"
            :style="`background-color: ${getThreadColorCSS(color)};`"
            :class="selectedColor === color ? 'ring-2 ring-[var(--color-deep-grey)] ring-offset-2' : ''"
          >
            <!-- Check icon for selected color -->
            <div x-show="selectedColor === color" class="absolute inset-0 flex items-center justify-center">
              <svg class="size-5" x-bind:style="`color: ${getThreadTextColorCSS(color)}`" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            </div>
          </button>
        </template>
      </div>
      
      <!-- Save Button -->
      <div @click="updateProfile()" class="w-full">
        <Button 
          state="Default" 
          class="w-full h-[60px] text-[18px] font-semibold"
        >
          Save Changes
        </Button>
      </div>
      
    </div>
  </div>
  
  <!-- Close Button -->
  <div class="mt-4" @click="if (window.closeProfilePanel) { window.closeProfilePanel(); } else { window.dispatchEvent(new CustomEvent('closeProfilePanel')); }">
    <SquareButton variant="Back" />
  </div>
</div>

<style>
  .search-input {
    background: var(--color-gradient-gray);
    box-shadow: var(--shadow-small);
  }

  .color-selection button[style*="background-color"] {
    box-shadow: 0px -4px 0px 0px rgba(0, 0, 0, 0.1) inset;
  }

  .color-selection button[style*="background-color"]:hover {
    transform: scale(1.05);
  }

  .color-selection button[style*="background-color"]:active {
    transform: scale(0.95);
  }
</style>
